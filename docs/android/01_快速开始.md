# Android APK 打包快速指南 v2.0

> **设计理念**: KISS(简单至上) + DRY(避免重复) + YAGNI(只实现必要功能)
> **目标**: 3步完成打包,自动记录详细日志,快速定位问题
> **适用**: MT3 Android 客户端 (armeabi-v7a架构)

---

## 🚀 5分钟快速开始

### 前置条件(一次性设置)

1. **安装NDK r10e** 到 `D:\android-ndk-r10e`
2. **确认已安装**:
   - JDK 1.8.0_144
   - Android SDK (Build-Tools 22.0.1)
   - Apache Ant 1.9.x

**验证命令**:
```cmd
java -version && ant -version && dir /b D:\android-ndk-r10e\ndk-build.cmd
```

---

## 📦 三步打包流程

### 步骤1: 打包前检查(1分钟)

```cmd
# 快速检查环境和配置
cd e:\MT3
tools\validate\android_env_check.bat
```

**检查重点**:
- ✅ NDK_HOME已设置
- ✅ ABI配置为armeabi-v7a
- ✅ 依赖库(.so文件)完整
- ✅ 签名文件存在

**详细检查清单**: [02_打包前检查清单.md](02_打包前检查清单.md)

---

### 步骤2: 执行打包(自动化)

使用增强版脚本,**自动记录所有日志**:

```cmd
cd client\android\LocojoyProject
build_with_log.bat
```

**脚本功能**:
- ✅ 记录环境变量和工具版本
- ✅ 执行NDK构建(libgame.so)
- ✅ 执行Ant打包(APK)
- ✅ 验证产物完整性
- ✅ 自动生成时间戳日志文件

**日志位置**: `e:\MT3\build_logs\android_build_YYYYMMDD_HHMMSS.log`

---

### 步骤3: 安装验证

```cmd
# 卸载旧版本
adb uninstall com.locojoy.mini.mt3.locojoy

# 安装新APK
adb install -r client\android\LocojoyProject\bin\mt3_locojoy.apk

# 启动应用
adb shell am start -n com.locojoy.mini.mt3.locojoy/.GameApp
```

**如果出现问题**: 参考 [05_问题诊断决策树.md](05_问题诊断决策树.md)

---

## 🔧 高级选项

### 手动分步打包(调试用)

如果需要单独执行各阶段:

```cmd
# 1. 设置环境变量
set "NDK_HOME=D:\android-ndk-r10e"
set "MT3_NO_PAUSE=1"

# 2. NDK构建
cd client\android\LocojoyProject
mt3_build.bat

# 3. Ant打包
ant -buildfile build.xml release

# 4. 查看产物
dir /b bin\mt3_locojoy.apk
```

### 指定自定义Manifest

```cmd
cd client\android\LocojoyProject\build
ant -Dmanifest=..\AndroidManifest.update.xml release
```

### 对齐APK(可选)

```cmd
"%ANDROID_HOME%\build-tools\22.0.1\zipalign.exe" -f -v 4 ^
  bin\mt3_locojoy.apk ^
  bin\mt3_locojoy_aligned.apk
```

---

## ⚠️ 常见问题速查

### Q1: NDK构建失败 - "ndk-build不是命令"

**原因**: NDK_HOME未设置或路径错误

**解决**:
```cmd
# 检查NDK安装
dir /b D:\android-ndk-r10e\ndk-build.cmd

# 临时设置环境变量
set "NDK_HOME=D:\android-ndk-r10e"

# 重新执行
mt3_build.bat
```

**详细说明**: [06_完整排错手册.md](06_完整排错手册.md)

---

### Q2: 安装失败 - "INSTALL_FAILED_NO_MATCHING_ABIS"

**原因**: 设备仅支持64位,APK仅包含32位库

**诊断**:
```cmd
# 检查设备ABI
adb shell getprop ro.product.cpu.abi
```

**解决**:
- 如果输出 `arm64-v8a`: 更换支持32位的测试设备
- 如果输出 `armeabi-v7a`: 检查APK是否正确包含.so文件

**详细说明**: [闪退诊断 - 场景A5](Android_闪退诊断决策树.md#a5-错误--19-103-abi不匹配)

---

### Q3: 启动闪退 - ClassNotFoundException

**原因**: MultiDex配置错误,关键类未在主dex

**快速修复**:

检查 MultiDex 主dex规则（如使用）应包含:

```
com/locojoy/mini/mt3/Mt3Application.class
com/locojoy/mini/mt3/GameApp.class
android/support/multidex/MultiDexApplication.class
```

重新打包后再试。

**详细说明**: [闪退诊断 - 场景B3](Android_闪退诊断决策树.md#b3-classnotfoundexception)

---

### Q4: Native库加载失败 - UnsatisfiedLinkError

**原因**: libgame.so未生成或缺少依赖

**诊断**:
```cmd
# 检查so文件是否生成
dir /b client\android\LocojoyProject\libs\armeabi-v7a\libgame.so

# 检查APK是否包含
aapt list client\android\LocojoyProject\bin\mt3_locojoy.apk | findstr libgame.so
```

**解决**: 重新执行NDK构建,查看日志中的编译错误

**详细说明**: [闪退诊断 - 场景B4](Android_闪退诊断决策树.md#b4-unsatisfiedlinkerror)

---

### Q5: 编译器版本错误 - UnsupportedClassVersionError

**原因**: javac编译版本与dx工具不匹配

**已修复**: v2.0版本已将编译器配置修正为:
- compiler="modern"
- source="1.7"
- target="1.7"

**验证**: 查看 [build.xml:214](../../client/android/LocojoyProject/build.xml#L214)

---

## 📊 打包流程架构图

```
┌─────────────────────────────────────────────┐
│     打包前检查 (android_env_check.bat)      │
│  - 验证工具链                                │
│  - 检查ABI配置                               │
│  - 确认依赖库                                │
└──────────────────┬──────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────┐
│   NDK构建 (mt3_build.bat)                   │
│  - 清理旧产物                                │
│  - 编译C++代码                               │
│  - 生成libgame.so                            │
│  - 日志: NDK构建阶段                         │
└──────────────────┬──────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────┐
│   Ant打包 (build.xml)                       │
│  1. init - 清理/初始化                       │
│  2. copy_libs - 复制依赖jar                  │
│  3. gen-R - 生成R.java                       │
│  4. compile - javac编译                      │
│  5. dex - 生成classes.dex (MultiDex)        │
│  6. package - aapt打包资源                   │
│  7. build-unsigned - ApkBuilder组包          │
│  8. add-subdex - 添加classes2.dex等          │
│  9. sign-apk - jarsigner签名                 │
│ 10. release - 输出最终APK                    │
│  - 日志: 每个阶段详细输出                    │
└──────────────────┬──────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────┐
│   验证与安装                                 │
│  - 检查APK文件完整性                         │
│  - aapt dump badging                         │
│  - adb install                               │
│  - logcat监控                                │
└─────────────────────────────────────────────┘
```

---

## 📚 文档体系说明

本v2.0版本整合了以下文档,遵循DRY(Don't Repeat Yourself)原则:

| 文档 | 用途 | 何时使用 |
|------|------|---------|
| **本文档** | 快速上手指南 | 日常打包 |
| [打包前必检清单](Android_打包前必检清单.md) | 系统化检查 | 首次打包/环境变更 |
| [闪退诊断决策树](Android_闪退诊断决策树.md) | 问题定位 | 出现闪退/安装失败 |
| [排错手册](Android_Ant_NDK_APK_打包与安装技术要点与排错手册.md) | 技术细节 | 深度排查/学习原理 |
| [环境配置](../common/Android_Env.md) | 环境搭建 | 新机器初始化 |

**使用建议**:
1. 新手: 按顺序阅读所有文档
2. 熟手: 仅使用本快速指南
3. 排错: 先查决策树,再查排错手册

---

## 🔄 版本变更记录

### v2.0 (2025-10-17)

**重大改进**:
1. ✅ **修复编译器配置**: build.xml中javac1.8→modern, 1.8→1.7
2. ✅ **增强NDK脚本**: 自动清洗路径,探测常见安装位置
3. ✅ **新增日志记录**: build_with_log.bat自动记录全过程
4. ✅ **系统化文档**: 检查清单+诊断树+快速指南三合一

**遵循原则**:
- **KISS**: 打包简化为3步,常见问题1分钟定位
- **DRY**: 公共检查逻辑抽取为独立脚本,避免重复
- **SOLID-O**: 新增功能无需修改现有build.xml,通过wrapper扩展
- **YAGNI**: 移除不常用的高级配置说明,仅保留核心流程

### v1.x (历史版本)

- 多个分散的技术文档
- 手动打包流程
- 无自动化日志记录

---

## 🆘 获取帮助

### 问题仍未解决?

1. **查看完整日志**:
   ```cmd
   type build_logs\android_build_最新时间戳.log
   ```

2. **收集诊断信息**:
   ```cmd
   adb shell getprop > device_info.txt
   adb logcat -d > crash_logcat.txt
   aapt dump badging bin\mt3_locojoy.apk > apk_info.txt
   ```

3. **提交Issue**时附带:
   - 构建日志
   - 设备信息
   - 崩溃logcat
   - APK信息
   - 复现步骤

---

## 🎯 最佳实践建议

### 发布前检查清单

- [ ] versionCode递增 (避免降级安装问题)
- [ ] versionName更新 (用户可见版本号)
- [ ] 线上资源地址正确 (strings.xml中的更新地址)
- [ ] 签名证书正确 (生产环境使用正式keystore)
- [ ] 在真机测试 (至少2个不同型号)
- [ ] 检查logcat无异常 (启动后运行5分钟)

### 日志管理建议

- 保留最近10次构建日志用于对比
- 定期清理超过30天的旧日志
- 重要发布版本的日志单独归档

### 团队协作建议

- 统一使用 build_with_log.bat 打包
- 提交代码前确保本地打包成功
- 环境变更需同步更新文档
- 新发现的问题及时补充到诊断树

---

**最后更新**: 2025-10-17
**维护者**: MT3项目组
**反馈渠道**: 项目Issues

**致谢**: 感谢所有参与文档改进和问题排查的团队成员!
