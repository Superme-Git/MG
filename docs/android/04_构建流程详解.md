# Android 构建流程技术详解

> **目标**: 深入理解APK构建全过程,掌握关键技术细节
> **适用**: 需要深度定制构建流程或排查复杂问题的开发者
> **原则**: SOLID-S(单一职责),每个阶段职责清晰

---

## 第1章: 构建流程架构总览

### 1.1 完整构建链路

```
┌────────────────────────────────────────────────────────┐
│                 Android APK 构建全流程                  │
└────────────────────────────────────────────────────────┘

阶段1: Native编译 (NDK)
┌──────────────────────────────────────┐
│ mt3_build.bat                        │
│  ├─ ndk-build.cmd                    │
│  ├─ 编译C++源码                       │
│  ├─ 链接静态库 (libjpeg, libpng等)    │
│  └─ 输出: libgame.so (armeabi-v7a)   │
└──────────────────────────────────────┘
           ↓
阶段2: Java编译与资源处理 (Ant + Android SDK)
┌──────────────────────────────────────┐
│ build.xml (Ant脚本)                  │
│  1) init - 清理临时文件               │
│  2) copy_libs - 复制jar和so          │
│  3) gen-R - aapt生成R.java           │
│  4) compile - javac编译Java代码       │
│  5) dex - dx转换为classes.dex        │
│  6) package - aapt打包资源           │
│  7) build-unsigned-apk - 组装APK     │
│  8) add-subdex-toapk - 添加副dex     │
│  9) sign-apk - jarsigner签名         │
│ 10) release - 输出最终APK            │
└──────────────────────────────────────┘
           ↓
阶段3: 后处理与验证 (可选)
┌──────────────────────────────────────┐
│  ├─ zipalign - 对齐优化               │
│  ├─ apksigner验证 (可选)              │
│  └─ adb install - 安装测试           │
└──────────────────────────────────────┘
```

### 1.2 关键文件与路径

| 文件 | 类型 | 作用 |
|------|------|------|
| [Application.mk](../../client/android/LocojoyProject/jni/Application.mk) | NDK配置 | 定义ABI、平台版本、工具链 |
| [Android.mk](../../client/android/LocojoyProject/jni/Android.mk) | NDK模块 | 声明源码、依赖库、编译选项 |
| [mt3_build.bat](../../client/android/LocojoyProject/mt3_build.bat) | 批处理 | NDK构建入口脚本 |
| [build.xml](../../client/android/LocojoyProject/build.xml) | Ant构建 | 主打包流程(免费服) |
| build_monthpayment.xml(如存在) | Ant构建 | 点卡服打包流程 |
| main-dex-rule.txt(如使用) | MultiDex | 主dex保留规则 |
| [AndroidManifest.xml](../../client/android/LocojoyProject/AndroidManifest.xml) | 清单文件 | 应用元数据、权限、组件 |

---

## 第2章: NDK Native构建详解

### 2.1 Application.mk配置

**文件位置**: `client/android/LocojoyProject/jni/Application.mk`

**关键配置**:
```makefile
APP_ABI := armeabi-v7a               # 仅支持32位ARM
APP_PLATFORM := android-11           # 最低API Level 11
NDK_TOOLCHAIN_VERSION := 4.9         # GCC 4.9工具链
APP_STL := gnustl_static             # 使用静态STL库
APP_CPPFLAGS += -fexceptions -frtti  # 启用异常和RTTI
```

**重要说明**:
- ⚠️ **禁止修改APP_ABI**为arm64-v8a,当前项目不支持64位
- APP_PLATFORM与AndroidManifest.xml的minSdkVersion保持一致

### 2.2 Android.mk模块定义

**主要模块**:

1. **预编译共享库**
```makefile
# 百度定位SDK
include $(CLEAR_VARS)
LOCAL_MODULE := locSDK6a
LOCAL_SRC_FILES := ../../../3rdplatform/BaiduLBS_AndroidSDK_Lib/libs/$(TARGET_ARCH_ABI)/liblocSDK6a.so
include $(PREBUILT_SHARED_LIBRARY)

# DU SDK
include $(CLEAR_VARS)
LOCAL_MODULE := du
LOCAL_SRC_FILES := ../../../3rdplatform/duClient_SDK_Lib/libs/$(TARGET_ARCH_ABI)/libdu.so
include $(PREBUILT_SHARED_LIBRARY)
```

2. **最终输出: libgame.so**
```makefile
include $(CLEAR_VARS)
LOCAL_MODULE := game
LOCAL_SRC_FILES := 游戏源码.cpp ...
LOCAL_STATIC_LIBRARIES := libjpeg libpng libz
LOCAL_SHARED_LIBRARIES := locSDK6a du
include $(BUILD_SHARED_LIBRARY)
```

### 2.3 构建脚本: mt3_build.bat

**核心逻辑**:
```batch
@echo off
# 1. 清理旧产物
rd /s /q .\obj\local

# 2. 探测NDK路径
if defined NDK_HOME (使用NDK_HOME)
else if defined ANDROID_NDK_HOME (使用ANDROID_NDK_HOME)
else (使用默认路径D:\android-ndk-r10e)

# 3. 执行ndk-build
call %NDK_HOME%\ndk-build.cmd NDK_DEBUG=0 -j4
```

**参数说明**:
- `NDK_DEBUG=0`: 发布版本,优化编译
- `-j4`: 并行编译,使用4个线程

### 2.4 常见Native编译错误

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `undefined reference to jpeg_*` | 静态库缺失 | 补充libjpeg.a并在Android.mk中链接 |
| `LOCAL_SRC_FILES points to missing file` | .so文件路径错误 | 检查3rdplatform目录结构 |
| `fatal error: jni.h: No such file` | NDK路径错误 | 确认NDK_HOME指向r10e目录 |

---

## 第3章: Ant Java打包详解

### 3.1 构建阶段详解

#### 阶段1: init - 初始化
```xml
<target name="init">
    <mkdir dir="${bin}"/>
    <delete dir="${bin}/classes"/>
    <mkdir dir="${bin}/classes"/>
    <delete dir="${gen}"/>
    <mkdir dir="${gen}"/>
</target>
```

**作用**: 清理并创建构建目录,避免旧文件干扰

---

#### 阶段2: copy_libs - 复制依赖
```xml
<target name="copy_libs">
    <!-- 复制jar文件到dexedLibs -->
    <copy todir="${dexedLibs}">
        <fileset dir="${libs}" includes="*.jar"/>
    </copy>

    <!-- 仅复制armeabi-v7a的.so文件 -->
    <copy todir="${libs}/armeabi-v7a">
        <fileset dir="../3rdplatform/..." includes="liblocSDK6a.so"/>
        <fileset dir="../3rdplatform/..." includes="libdu.so"/>
    </copy>
</target>
```

**作用**: 整合第三方库和NDK产出的.so文件

---

#### 阶段3: gen-R - 生成R.java
```xml
<target name="gen-R" depends="copy_libs">
    <exec executable="${tools.aapt}">
        <arg value="package"/>
        <arg value="-f"/>
        <arg value="-m"/>
        <arg value="-M"/> <arg value="${manifest}"/>
        <arg value="-S"/> <arg value="${res}"/>
        <arg value="-I"/> <arg value="${android-jar}"/>
        <arg value="-J"/> <arg value="${gen}"/>
        <arg value="--auto-add-overlay"/>
    </exec>
</target>
```

**关键参数**:
- `-m`: 生成R.java
- `-M`: 指定AndroidManifest.xml
- `-S`: 资源目录
- `-I`: android.jar路径
- `--auto-add-overlay`: 支持资源覆盖

---

#### 阶段4: compile - Java编译
```xml
<target name="compile" depends="gen-R">
    <javac
        bootclasspath="${android-jar}"
        compiler="modern"
        source="1.7"
        target="1.7"
        destdir="${bin}/classes"
        encoding="utf-8">
        <src path="${src}"/>
        <src path="${gen}"/>
        <classpath>
            <fileset dir="${libs}" includes="*.jar"/>
        </classpath>
    </javac>
</target>
```

**关键配置**:
- `compiler="modern"`: 使用当前JDK编译器
- `source/target="1.7"`: 兼容dx工具(Build-Tools 22.0.1)
- `bootclasspath`: 使用android.jar替代标准库

---

#### 阶段5: dex - 生成Dalvik字节码
```xml
<target name="dex" depends="compile">
    <exec executable="${tools.dx}">
        <arg value="--dex"/>
        <arg value="--multi-dex"/>
        <arg value="--main-dex-list=main-dex-list.txt"/>
        <arg value="--output=${bin}"/>
        <arg path="${bin}/classes"/>
        <arg path="${dexedLibs}/*.jar"/>
    </exec>
</target>
```

**MultiDex关键点**:
- `--multi-dex`: 生成classes.dex, classes2.dex, ...
- `--main-dex-list`: 主dex类列表(从main-dex-rule.txt生成)
- **作用**: 解决65536方法数限制

**主dex规则示例** (main-dex-rule.txt):
```
com/locojoy/mini/mt3/Mt3Application.class
com/locojoy/mini/mt3/GameApp.class
android/support/multidex/MultiDex.class
android/support/multidex/MultiDexApplication.class
```

---

#### 阶段6: package - 打包资源
```xml
<target name="package" depends="dex">
    <exec executable="${tools.aapt}">
        <arg value="package"/>
        <arg value="-f"/>
        <arg value="-M"/> <arg value="${manifest}"/>
        <arg value="-S"/> <arg value="${res}"/>
        <arg value="-A"/> <arg value="${assets}"/>
        <arg value="-I"/> <arg value="${android-jar}"/>
        <arg value="-F"/> <arg value="${package-temp-name}"/>
    </exec>
</target>
```

**输出**: 中间包(未含classes.dex),后续步骤将dex写入此包

---

#### 阶段7: build-unsigned-apk - 组装未签名APK
```xml
<target name="build-unsigned-apk">
    <java classname="com.android.sdklib.build.ApkBuilderMain" fork="true">
        <arg value="${unsigned-apk-path}"/>
        <arg value="-v"/>
        <arg value="-u"/>
        <arg value="-z"/> <arg value="${package-temp-name}"/>
        <arg value="-f"/> <arg value="${dex-name}"/>
        <arg value="-rf"/> <arg value="${src}"/>
        <arg value="-rj"/> <arg value="${libs}"/>
        <arg value="-nf"/> <arg value="${libs}/armeabi-v7a"/>
    </java>
</target>
```

**参数说明**:
- `-z`: 资源包
- `-f`: classes.dex
- `-nf`: native库目录(.so文件)

---

#### 阶段8: add-subdex-toapk - 添加副dex
```xml
<target name="add-subdex-toapk">
    <exec executable="${tools.aapt}">
        <arg value="add"/>
        <arg value="-v"/>
        <arg value="${unsigned-apk-path}"/>
        <arg value="classes2.dex"/>
        <arg value="classes3.dex"/>
        <!-- ... 更多dex文件 -->
    </exec>
</target>
```

**作用**: 将classes2.dex等追加到APK

---

#### 阶段9: sign-apk - 签名
```xml
<target name="sign-apk">
    <exec executable="${tools.jarsigner}">
        <arg value="-verbose"/>
        <arg value="-keystore"/> <arg value="${keystore-name}"/>
        <arg value="-storepass"/> <arg value="${keystore-password}"/>
        <arg value="-keypass"/> <arg value="${key-password}"/>
        <arg value="-signedjar"/> <arg value="${signed-apk-path}"/>
        <arg value="${unsigned-apk-path}"/>
        <arg value="${keystore-alias}"/>
    </exec>
</target>
```

**安全提示**:
- ⚠️ 生产环境勿在脚本中硬编码密码
- ✅ 使用`-Dkeystore-password=***`从命令行传入

---

#### 阶段10: release - 输出最终APK
```xml
<target name="release" depends="sign-apk">
    <copy file="${signed-apk-path}" todir="${bin}"/>
    <delete file="${unsigned-apk-path}"/>
    <delete file="${package-temp-name}"/>
</target>
```

**产物**: `build/bin/mt3_locojoy.apk`

---

### 3.2 工程配置要点

#### 仅支持armeabi-v7a

**build.xml中的ABI过滤**:
```xml
<copy todir="${libs}/armeabi-v7a">
    <!-- 仅复制v7a的.so文件 -->
    <fileset dir="../../../3rdplatform/BaiduLBS_AndroidSDK_Lib/libs/armeabi-v7a" includes="*.so"/>
</copy>

<!-- 删除其他ABI目录(如果误创建) -->
<delete dir="${libs}/arm64-v8a"/>
<delete dir="${libs}/x86"/>
<delete dir="${libs}/x86_64"/>
```

#### MultiDex配置

**Application初始化**:
```java
// Mt3Application.java
@Override
protected void attachBaseContext(Context base) {
    super.attachBaseContext(base);
    MultiDex.install(this);  // 安装副dex
}
```

**清单文件配置**:
```xml
<application
    android:name=".Mt3Application"
    android:minSdkVersion="11"
    android:targetSdkVersion="17">
    ...
</application>
```

---

## 第4章: 技术规范与最佳实践

### 4.1 编译器配置规范

**标准配置**(已在build.xml中修正):
```xml
<javac
    compiler="modern"    <!-- 使用当前JDK,而非javac1.7/javac1.8 -->
    source="1.7"         <!-- 源码兼容Java 7 -->
    target="1.7"         <!-- 目标字节码Java 7 -->
    bootclasspath="${android-jar}">  <!-- 使用Android API -->
</javac>
```

**原因**: dx工具(Build-Tools 22.0.1)不完全支持Java 8字节码

---

### 4.2 签名管理规范

**开发环境**:
```xml
<property name="keystore-name" value="mt3.keystore"/>
<property name="keystore-password" value="debug123"/>  <!-- 仅示例 -->
<property name="keystore-alias" value="mt3"/>
```

**生产环境**:
```cmd
# 从外部传入密码,避免硬编码
ant -Dkeystore-password=$PROD_PASSWORD -Dkey-password=$KEY_PASSWORD release
```

---

### 4.3 资源配置管理

**版本信息** (strings.xml):
```xml
<string name="mt3_update_url">http://update.server.com/</string>
<string name="mt3_verfile_name">ver.json</string>
```

**渠道配置** (assets/ljsdk.cfg):
```json
{
  "channel": "locojoy",
  "login_verify_url": "http://api.server.com/verify",
  "pay_request_url": "http://api.server.com/pay"
}
```

---

### 4.4 目录结构规范

```
client/android/LocojoyProject/
├── jni/                    # NDK源码和配置
│   ├── Application.mk
│   └── Android.mk
├── src/                    # Java源码
│   └── com/locojoy/mini/mt3/
├── res/                    # 资源文件
│   ├── layout/
│   ├── values/
│   └── drawable/
├── assets/                 # 资产文件
│   └── ljsdk.cfg
├── libs/                   # 第三方库
│   ├── armeabi-v7a/       # 仅此ABI
│   └── *.jar
├── build/                  # 构建脚本
│   ├── build.xml
│   ├── main-dex-rule.txt
│   └── mt3.keystore
└── AndroidManifest.xml
```

---

## 第5章: 常见构建问题

### 5.1 aapt报错: "duplicate resources"

**原因**: 多个res目录存在同名资源

**解决**:
1. 检查overlay配置是否正确
2. 删除重复资源或使用`--auto-add-overlay`

---

### 5.2 dx报错: "method ID not in [0, 0xffff]: 65536"

**原因**: 方法数超过65536限制

**解决**:
1. 确认使用MultiDex构建脚本
2. 检查main-dex-rule.txt包含关键类

---

### 5.3 jarsigner报错: "unable to sign jar"

**原因**: keystore路径错误或密码不正确

**解决**:
```cmd
# 验证keystore
keytool -list -v -keystore build/mt3.keystore

# 检查alias
keytool -list -keystore build/mt3.keystore
```

---

### 5.4 安装后启动闪退

**原因**: 主dex缺少关键类

**诊断**:
```cmd
# 抓取logcat
adb logcat -d | findstr ClassNotFoundException
```

**解决**: 补充类到main-dex-rule.txt

---

## 🔗 相关文档

- 环境准备: [03_环境配置指南.md](03_环境配置指南.md)
- 快速开始: [01_快速开始.md](01_快速开始.md)
- 问题诊断: [05_问题诊断决策树.md](05_问题诊断决策树.md)
- 完整排错: [06_完整排错手册.md](06_完整排错手册.md)

---

**最后更新**: 2025-10-17
**维护者**: MT3项目组
**版本**: v2.0 (整合自v1.0流程总览和操作规范文档)
