# Android Ant + NDK APK 打包与安装技术要点与排错手册

> 公共章节引用与统一脚本
> - 环境统一章节：[Android_Env.md](../common/Android_Env.md:1)
> - ABI/平台一致性：[Android_ABI_Troubleshooting.md](../common/Android_ABI_Troubleshooting.md:1)
> - 验证脚本与使用说明：[README.md](../../tools/validate/README.md:1)
> 排查前，建议先复核《[02_打包前检查清单](02_���ǰ����嵥.md)》《[03_打包流程指南](03_��������ָ��.md)》列出的动作，确认打包流程无遗漏。



---

## 1. 工具链与环境

- JDK: 建议 JDK 8（JNI/旧 aapt/dx 兼容）。路径例如 C:\Program Files\Java\jdk1.8.0_144
- Android SDK: Build-Tools 22.0.1、Platform android-22（与项目脚本匹配）
- NDK: 对应项目 NDK 版本，配合 [Android.mk](client/FireClient/Android.mk:1)、[Application.mk](client/android/LocojoyProject/jni/Application.mk:1)
- Apache Ant: 1.9.x，例如 C:\apache-ant-1.9.7
- Python: 如需使用 Python 脚本，请将 C:\Python27 加入 PATH（可选：C:\Python27\Scripts）
- 环境变量（可不全局设置，脚本中写死亦可）:
  - JAVA_HOME、ANDROID_HOME/ANDROID_SDK_ROOT、ANDROID_NDK_HOME、ANT_HOME
  - 将 sdk\platform-tools（adb）与 build-tools\22.0.1（aapt、zipalign）加入 PATH 便于直接调用

工具存在性快速检查（PowerShell）:
- aapt、dx、adb 路径：C:\Progra~2\Android\android-sdk\...
- 版本：javac -version、java -version、ant -version、aapt version

---

## 2. 项目结构与关键脚本

- 核心构建脚本: [build.xml](client/android/LocojoyProject/build.xml:1)
  - init → copy_libs → gen-R → compile → dex → package → build-unsigned-apk → add-subdex-toapk → sign-apk → release
- APK 输出目录：bin\mt3_locojoy.apk
- keystore（签名）：参见 ant.properties 配置
- 资源及第三方 SDK：3rdplatform/ShareSDK、Meiqia 等在 gen-R/package 阶段叠加
- 多 dex 及主 dex 规则： main-dex-rule.txt(如使用)

---

## 3. 打包流水线技术要点

1) 生成资源与 R.java（aapt）
- 命令由 [gen-R](client/android/LocojoyProject/build/build.xml:178) 触发，合并多个 res 目录（工程 + 第三方）
- 需注意图片 iCCP profile 警告：非致命，可用图像工具移除 iCCP 以净化日志

2) Java 编译（javac）
- [compile](client/android/LocojoyProject/build.xml:1) 使用 JDK8，compiler="modern"，source/target="1.7"，bootclasspath 指向 android.jar
- 若升级 targetSdkVersion，建议保持 source/target=1.7 以兼容 dx 工具

3) dx 转 dex（多 dex）
- [dex](client/android/LocojoyProject/build/build.xml:232) 使用 dx.bat，--multi-dex，主 dex 列表受 [main-dex-rule.txt](client/android/LocojoyProject/build/main-dex-rule.txt:1) 控制
- 启动崩溃或找不到类 → 调整 main-dex-list 以确保关键入口类进主 dex

4) aapt 打包资源（package）
- [package](client/android/LocojoyProject/build.xml:1) 产出中间包（未含 classes.dex），路径为 .\mt3_locojoy
- aapt 22 与旧资源更兼容，Gradle 时代则为 aapt2

5) 组包（ApkBuilderMain）
- [build-unsigned-apk](client/android/LocojoyProject/build.xml:1) 调用 sdklib ApkBuilderMain，将 classes.dex 写入临时 unsigned 包
- 多 dex 时额外通过 aapt add 追加 classes2.dex 等（见 add-subdex-toapk）

6) 签名与对齐
- 签名（jarsigner）由 [sign-apk](client/android/LocojoyProject/build.xml:1) 完成，产出 .\mt3_locojoy.apk
- 对齐（zipalign）：建议构建后执行 zipalign（如下命令示例）；jarsigner→zipalign 顺序需注意（或使用 apksigner）

---

## 4. Manifest 管理与权限模型

- 目标 SDK：Android 6.0+ 启用运行时权限模型；降级安装会触发 INSTALL_FAILED_PERMISSION_MODEL_DOWNGRADE（-26）
- 本项目原 Manifest 为 [AndroidManifest.xml](client/android/LocojoyProject/AndroidManifest.xml:7)（targetSdkVersion=17）
- 升级 Manifest 的两种方式：
  1) 直接改源 Manifest（需关闭编辑器避免锁）：targetSdkVersion 改为 27/28/30/32
  2) 构建时覆盖：传入 -Dmanifest=路径 或在 [init](client/android/LocojoyProject/build/build.xml:125) 中追加 replaceregexp，将 targetSdkVersion 动态替换
- 可使用覆盖清单 AndroidManifest.update.xml（如使用）在构建时覆盖 targetSdkVersion

运行时权限策略：
- 提升 targetSdkVersion 后，请在应用入口（例如 [GameApp.java](client/android/common/src/com/locojoy/mini/mt3/GameApp.java:1)）增加运行时权限申请逻辑（存储/定位/录音/电话等）

---

## 5. 签名管理与覆盖安装

- keystore：默认使用 [mt3.keystore](client/android/LocojoyProject/build/mt3.keystore:1)
- 覆盖安装前提：相同包名 + 相同签名 + 允许覆盖（adb install -r）
- 不同签名或权限模型降级：
  - 不同签名 → INSTALL_FAILED_UPDATE_INCOMPATIBLE 或 -505/-504 类错误，需先 adb uninstall 包名
  - 权限模型降级（-26）→ 提升 targetSdkVersion 与设备上已装版本持平或更高；或先卸载旧包
- 版本号：
  - 降级安装需 -d；否则升级安装建议 versionCode 递增（见 [AndroidManifest.update.xml](client/android/LocojoyProject/AndroidManifest.update.xml:4)）

签名/包信息验证命令：
- adb shell dumpsys package com.locojoy.mini.mt3.locojoy | findstr versionCode versionName
- keytool -list -v -keystore mt3.keystore
- apksigner verify --print-certs mt3_locojoy.apk（若使用 apksigner）

安全建议（生产实践）：
- 不要在脚本中硬编码 keystore 口令与证书；本仓库签名参数仅用于示例/本地调试
- 使用注入参数替代：-Dstorepass=*** -Dkeypass=*** 或外部 properties（keystore.properties）加载
- 统一管理签名材料与口令，避免提交到版本库

---

## 6. ABI 与 SDK 兼容性

- 模拟器 ABI：adb shell getprop ro.product.cpu.abi（x86/x86_64/arm64-v8a）
- 若出现 INSTALL_FAILED_NO_MATCHING_ABIS：
  - 确认 ndk-build 产出 lib 的 ABI 与设备 ABI 匹配（armeabi-v7a/x86/x86_64/arm64-v8a）
  - NDK 的 APP_ABI 配置（[Application.mk](client/android/LocojoyProject/jni/Application.mk:1)）需覆盖目标 ABI
- SDK 等级：
  - minSdkVersion/targetSdkVersion 与设备 SDK（adb shell getprop ro.build.version.sdk）匹配
  - 若过低或过高，需评估兼容性与第三方库依赖

---

## 7. 常见安装失败码与处理

- -7 应用已存在/签名或同名冲突（设备弹窗“应用已存在”）：
  - adb uninstall com.locojoy.mini.mt3.locojoy
  - 若系统分用户：adb shell pm uninstall --user 0 包名
  - 再安装：adb install -r mt3_locojoy.apk 或 zipalign 后安装
- -26 INSTALL_FAILED_PERMISSION_MODEL_DOWNGRADE（权限模型降级）：
  - 提升 targetSdkVersion（如 27），或卸载旧包
- -505/-504 签名冲突或重复包：
  - 确保使用相同 keystore 签名，冲突时卸载旧包
- -19/-103 ABI 不匹配/降级错误：
  - ABI：补齐或调整 .so ABI
  - 降级：加 -d 并注意 versionCode 关系（生产建议升级 versionCode）
- 其他：
  - -12 空间不足：清理设备空间
  - 验证安装后：adb shell pm list packages | findstr 包名

---

## 8. 推荐命令清单（Windows）

构建（使用覆盖 Manifest）：
- cd /d e:\MT3\client\android\LocojoyProject\build
- C:\apache-ant-1.9.7\bin\ant.bat -Dmanifest=e:\MT3\client\android\LocojoyProject\AndroidManifest.update.xml -buildfile build.xml -v release

对齐与安装：
- cd /d e:\MT3\client\android\LocojoyProject\bin
- C:\Progra~2\Android\android-sdk\build-tools\22.0.1\zipalign.exe -f -v 4 mt3_locojoy.apk mt3_locojoy_aligned.apk
- C:\Progra~2\Android\android-sdk\platform-tools\adb.exe uninstall com.locojoy.mini.mt3.locojoy
- C:\Progra~2\Android\android-sdk\platform-tools\adb.exe install -r mt3_locojoy_aligned.apk

快速查询与清理：
- C:\Progra~2\Android\android-sdk\platform-tools\adb.exe devices -l
- C:\Progra~2\Android\android-sdk\platform-tools\adb.exe shell getprop ro.product.cpu.abi
- C:\Progra~2\Android\android-sdk\platform-tools\adb.exe shell getprop ro.build.version.sdk
- C:\Progra~2\Android\android-sdk\platform-tools\adb.exe shell pm list packages | findstr com.locojoy.mini.mt3.locojoy

---

## 9. CI 与日志

- 将 aapt、dx、ApkBuilder、jarsigner 各阶段日志落盘（重定向到 apk_build.log），失败即时抓取尾部
- 构建前清理 build/bin、gen，以避免“Unable to delete directory”类错误
- 在 CI 上引入 zipalign 与 apksigner 验证步骤（Gradle 时代使用 assembleRelease + apksigner）

---

## 10. 迁移建议（Gradle）

- 旧构建链（Ant+dx+aapt+jarsigner+zipalign）可用，但建议规划迁移：
  - Gradle + aapt2 + d8/r8，signingConfigs 统一签名
  - flavors/variants 管理多渠道
  - tasks：./gradlew assembleRelease
- 迁移前先将 Manifest/签名/ABI/权限策略规范化，减少迁移成本

---

## 11. 本项目实操要点小结

- 已通过覆盖 Manifest 的方式提升 targetSdkVersion 到 27，构建成功：
  - 覆盖清单： [AndroidManifest.update.xml](client/android/LocojoyProject/AndroidManifest.update.xml:1)
  - 构建脚本： [build.xml](client/android/LocojoyProject/build/build.xml:1)
  - 产物： [mt3_locojoy.apk](client/android/LocojoyProject/bin/mt3_locojoy.apk:1)
- 遇安装失败 -7（应用已存在）：执行 adb 卸载后再安装，或在“应用管理”中卸载已有版本
- 若遇 -26：维持 targetSdkVersion ≥ 旧版本，或先卸载旧包
- 对齐安装可提升兼容性（zipalign），签名冲突需统一 keystore

---

## 12. 常用排错速查

- “ERROR: No AndroidManifest.xml file found.”：检查 aapt -M 的 Manifest 路径是否指向覆盖清单或源清单（[package](client/android/LocojoyProject/build/build.xml:252)）
- “Unable to delete directory build\bin”：确认无进程占用，先关闭资源占用，再清理
- “INSTALL_FAILED_NO_MATCHING_ABIS”：确认 .so ABI 与模拟器/设备 ABI 一致（[Application.mk](client/android/LocojoyProject/jni/Application.mk:1)）
- “jar 已签名但无时间戳”：生产签名建议附带 TSA（-tsa 或 -tsacert），便于长期校验

---

如需将上述策略固化回源清单，请关闭编辑器中对 [AndroidManifest.xml](client/android/LocojoyProject/AndroidManifest.xml:7) 的占用后更新 targetSdkVersion，同时在 [build.xml](client/android/LocojoyProject/build/build.xml:125) 的 init 任务添加 replaceregexp 守护，防止回退。
## 附录：JDK 1.8.0_144 兼容性分析与配置建议

本项目当前脚本在 [build.xml](client/android/LocojoyProject/build/build.xml:213) 中配置了：
- compiler="javac1.7"
- target="1.7"
- bootclasspath 指向 android-22 的 [android.jar](client/android/LocojoyProject/build/build.xml:21)

在仅安装并使用 JDK 1.8.0_144（路径：C:\Program Files\Java\jdk1.8.0_144）的场景下，兼容性与建议如下：

1) 可兼容点
- Ant 1.9.x 在 JDK 8 下稳定可用；jarsigner（来自 JDK8）用于 APK 签名完全兼容。
- dx/aapt/zipalign（来自 Android SDK build-tools 22.0.1）与 JDK 版本无直接耦合。
- 只要编译的 Java 源/目标版本为 1.7（或与工程依赖一致），JDK8 的 javac 可以正确编译并生成字节码。

2) 潜在不匹配与修正
- 脚本中的 compiler="javac1.7" 在部分 Ant/JDK 组合下可能被视为“指定旧编译器”，会导致 Ant 查找“javac1.7”实现而非现代编译器。
- 建议将 [build.xml](client/android/LocojoyProject/build/build.xml:213) 的 compiler 属性改为：
  - compiler="modern"（让 Ant 选择当前 JDK 的标准编译器）
  - 或 compiler="javac1.8"（显式指定 JDK8 编译器）
- 维持 target="1.7"，并建议同时设置 source="1.7" 以避免源/目标版本不一致（在 [build.xml](client/android/LocojoyProject/build/build.xml:213) 的 <javac> 上增加 source="1.7"）。
- 如不想改文件，可在命令行通过 Ant 内置属性选择编译器：
  - -Dbuild.compiler=modern 或 -Dbuild.compiler=javac1.8
  - 同时可通过 -Dant.build.javac.source=1.7 -Dant.build.javac.target=1.7 统一源/目标版本（当脚本未显式设置时）。

3) 推荐配置（保持 JDK 8 路径）
- 使用 JDK 8（C:\Program Files\Java\jdk1.8.0_144）
- 将 PATH 中的 JDK8 bin 保持在前（java、javac、jarsigner 可直接调用）
- 保持 Android SDK 路径与版本（aapt/dx/zipalign/adb）为 build-tools 22.0.1、platform android-22
- Ant 命令示例（不改脚本、通过覆盖参数运行）：
  - C:\apache-ant-1.9.7\bin\ant.bat -Dbuild.compiler=modern -Dant.build.javac.source=1.7 -Dant.build.javac.target=1.7 -buildfile e:\MT3\client\android\LocojoyProject\build\build_multidex_common.xml release
  - 或对默认脚本：[build.xml](client/android/LocojoyProject/build/build.xml:1) 同样的覆盖参数

4) 验证清单
- javac 版本：javac -version → 1.8.0_144
- Ant 编译日志：确认使用的是 Modern compiler（无“找不到 javac1.7 编译器”的提示）
- APK 构建成功且安装验证通过（adb install -r），主 dex 规则生效（参考 [main-dex-rule.txt](client/android/LocojoyProject/build/main-dex-rule.txt:1)）

5) 何时需要 JDK 7
- 若严格依赖 Ant 的“javac1.7”编译器名且构建系统不接受 modern/javac1.8（较少见），则安装 JDK 7 并将 JAVA_HOME 指向 JDK 7，可避免编译器标识与 JDK 版本不一致。
- 实务上，JDK 8 + modern 编译器 + source/target=1.7 更通用且便于维护。

结论：在保持 Android SDK/NDK 版本与工程配置不变的情况下，JDK 1.8.0_144 完全可以用于项目的打包流程。建议将编译器标识改为“modern”或“javac1.8”，同时明确 source/target=1.7，以确保与现有依赖的兼容性。
========
构建日志阶段性分析与修复记录（2025-10-17）

一、环境与日志采集
- 构建入口与脚本：
  - Java 应用入口使用更新界面布局：[GameApp.setContentView()](client/android/LocojoyProject/src/com/locojoy/mini/mt3/GameApp.java:303) → 布局：[res/layout/mt_update.xml](client/android/LocojoyProject/res/layout/mt_update.xml:1)
  - NDK 构建批处理脚本：[mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:1)
  - Ant 自定义打包规则（含 SDK/JDK 路径配置）：[build/build.xml](client/android/LocojoyProject/build/build.xml:9)
  - 标准 Ant Android 规则入口（依赖 sdk.dir/local.properties）：[client/android/LocojoyProject/build.xml](client/android/LocojoyProject/build.xml:1)
- 日志采集目标文件：
  - [build_logs/android_ant_release_full.log](build_logs/android_ant_release_full.log:1)

二、问题一：“'mt3_build.bat' 未被识别”与 PowerShell 会话差异
- 现象
  - 日志提示：[build_logs/android_ant_release_full.log](build_logs/android_ant_release_full.log:1) 出现
    - “mt3_build.bat: The term 'mt3_build.bat' is not recognized...”
- 根因分析
  - 在 PowerShell 会话中直接输入批处理名不会像 CMD 一样自动解析为可执行，需使用调用符或相对路径。
  - 同一会话内未使用 call 调用批处理，后续命令上下文可能中断（CMD 语义）。
- 修复措施（已实施）
  - 批处理暂停优化：将末尾 pause 改为仅在未设置环境变量 MT3_NO_PAUSE 时暂停，避免 CI/脚本阻塞。
    - 变更位置：[mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:37)
    - 变更内容：pause → if not defined MT3_NO_PAUSE pause
  - 正确的执行方式：
    - 在 CMD 中（推荐，一条命令采集完整日志）
      - cmd /C "set "NDK_HOME=D:\android-ndk-r10e" &amp;&amp; set "MT3_NO_PAUSE=1" &amp;&amp; call e:\MT3\client\android\LocojoyProject\mt3_build.bat &amp;&amp; cd /d e:\MT3\client\android\LocojoyProject\build &amp;&amp; ant -buildfile build.xml release &gt; e:\MT3\build_logs\android_ant_release_full.log 2&gt;&amp;1"
    - 在 PowerShell 中（分步执行，注意调用符 &）
      - $env:NDK_HOME="D:\android-ndk-r10e"
      - $env:MT3_NO_PAUSE="1"
      - &amp; "e:\MT3\client\android\LocojoyProject\mt3_build.bat"
      - Set-Location "e:\MT3\client\android\LocojoyProject\build"
      - ant -buildfile build.xml release *&gt; "e:\MT3\build_logs\android_ant_release_full.log"

三、问题二：“'ndk-build' 不是内部或外部命令”
- 现象
  - 批处理输出（终端采集到的关键片段）提示 "'ndk-build' 不是内部或外部命令"。
  - 批处理定位 ndk-build 的逻辑位于：[mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:7)
    - 解析顺序：NDK_HOME → ANDROID_NDK_HOME → ANDROID_NDK_ROOT → 默认 D:\android-ndk-r10e
    - 优先调用 "!NDK_CANDIDATE!\ndk-build.cmd"，否则回退到 where ndk-build(.cmd)
- 根因分析
  - 本机默认路径 D:\android-ndk-r10e 未找到 ndk-build.cmd（环境检测显示缺失）。
  - 未在 PATH 中找到 ndk-build(.cmd)，导致 where 查找失败。
- 修复步骤（任选其一或组合）
  1) 安装或还原 NDK r10e 到预期路径
     - 建议安装到 D:\android-ndk-r10e，并确保存在 D:\android-ndk-r10e\ndk-build.cmd。
  2) 使用实际安装目录设置环境变量（无需固定盘符）
     - CMD（当前会话有效）：
       - set "NDK_HOME=你的NDK路径（含 ndk-build.cmd）"
     - PowerShell（当前会话有效）：
       - $env:NDK_HOME="你的NDK路径（含 ndk-build.cmd）"
  3) 将 ndk-build 所在目录加入 PATH（可选增强）
     - CMD：set "PATH=%NDK_HOME%;%PATH%"
     - PowerShell：$env:Path="$env:NDK_HOME;$env:Path"
  4) 直接在脚本中写死绝对路径（不推荐，仅临时排障）
     - 在 [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:12) 处将默认路径替换为实际安装路径。
- 验证方法
  - 在 CMD：D:\...&gt; "D:\实际NDK路径\ndk-build.cmd" -h
  - 在 PowerShell：&amp; "D:\实际NDK路径\ndk-build.cmd" -h
  - 成功后重新执行构建命令，日志将进入 [build_logs/android_ant_release_full.log](build_logs/android_ant_release_full.log:1)

四、问题三：Android SDK / Build-tools / JDK 路径硬编码导致的工具缺失
- 位置与默认配置：
  - SDK 路径：[build/build.xml](client/android/LocojoyProject/build/build.xml:9) sdk-folder="C:\Program Files (x86)\Android\android-sdk"
  - Build-tools 路径：[build/build.xml](client/android/LocojoyProject/build/build.xml:16) "build-tools\22.0.1"
  - 平台 Jar：[build/build.xml](client/android/LocojoyProject/build/build.xml:14) "platforms\android-22"
  - JDK 路径：[build/build.xml](client/android/LocojoyProject/build/build.xml:19) "C:\Program Files\Java\jdk1.8.0_144"
- 风险：
  - 若本机未严格按上述路径安装，将引发 aapt/dx/javac/jarsigner 不可用，随后出现 R.java 生成失败、编译失败、dx 失败、签名失败等链式错误。
- 修复建议：
  - 优先保证本机安装路径与上述硬编码一致（最省改动）。
  - 或统一通过 ant.properties/local.properties 注入路径，避免硬编码（需要调整 [build/build.xml](client/android/LocojoyProject/build/build.xml:9) 引用方式）。
- 最小验证集：
  - 确认存在以下可执行文件（版本可与 22.0.1/Android-22 对应）：
    - aapt.exe：[build/build.xml.tools.aapt](client/android/LocojoyProject/build/build.xml:25)
    - dx.bat：[build/build.xml.tools.dx](client/android/LocojoyProject/build/build.xml:31)
    - javac.exe / jarsigner.exe：[build/build.xml.tools.javac](client/android/LocojoyProject/build/build.xml:28)、[build/build.xml.tools.jarsigner](client/android/LocojoyProject/build/build.xml:37)

五、“此应用专为旧版 Android 打造”提示的定位与排查策略
- 入口路径（确认展示层）：
  - 界面加载点：[GameApp.setContentView()](client/android/LocojoyProject/src/com/locojoy/mini/mt3/GameApp.java:303)
  - 布局资源：[res/layout/mt_update.xml](client/android/LocojoyProject/res/layout/mt_update.xml:85)（显示更新提示与进度）
  - 提示文案资源集合：[res/values/strings.xml](client/android/LocojoyProject/res/values/strings.xml:1)
- 当前检索结果：
  - 未在 [strings.xml](client/android/LocojoyProject/res/values/strings.xml:1) 中发现“此应用专为旧版 Android 打造”的直接字面量，说明该提示可能来源于：
    - a) 第三方 SDK 的内部提示（如分享/客服等组件的 UI 覆盖），对应资源位于 3rdparty 源码或其打包资源；
    - b) 线上拉取的动态文案（由更新/公告/补丁配置下发）；
    - c) 系统/商店层提示（非应用内 strings，需结合设备环境重现）。
- 建议排查动作：
  1) 全工程检索该中文文案（含 Java、Lua、XML、JSON），确认是否在第三方库或本地资源中：
     - 已定位更新界面入口；若仍未命中该字面量，倾向为 SDK/线上资源或系统级提示。
  2) 校验版本/更新相关配置：
     - 线上更新/资源配置：
       - [strings.xml.mt3_update_url](client/android/LocojoyProject/res/values/strings.xml:21)
       - [strings.xml.mt3_update_select_url](client/android/LocojoyProject/res/values/strings.xml:26)
       - [strings.xml.mt3_verfile_name / resver.json](client/android/LocojoyProject/res/values/strings.xml:22)
     - SDK/埋点/风控配置：
       - [assets/ljsdk.cfg](client/android/LocojoyProject/assets/ljsdk.cfg:1)（渠道/校验/支付）
       - [assets/cn.shuzilm.config.json](client/android/LocojoyProject/assets/cn.shuzilm.config.json:1)（数美配置）
  3) 构建产物 APK 内验证（生成后再查）：
     - AndroidManifest.xml 的 minSdkVersion/targetSdkVersion 与 versionCode/versionName
     - strings.xml 与资源包中是否存在该提示字面量
- 处理策略：
  - 若来自 SDK：需更新 SDK 版本或调整其配置/资源以移除旧版提示。
  - 若来自线上资源：同步线上资源地址至最新，确保 ver.json/resver.json 指向正确渠道与日期版本。
  - 若来自系统/商店：需提升 targetSdkVersion 与兼容行为，或引导用户升级系统环境。

六、复现与验证命令模板
- 一次性（CMD，推荐记录日志）
  - cmd /C "mkdir build_logs 2&gt;nul &amp;&amp; set "NDK_HOME=D:\android-ndk-r10e" &amp;&amp; set "MT3_NO_PAUSE=1" &amp;&amp; call e:\MT3\client\android\LocojoyProject\mt3_build.bat &amp;&amp; cd /d e:\MT3\client\android\LocojoyProject\build &amp;&amp; ant -buildfile build.xml release &gt; e:\MT3\build_logs\android_ant_release_full.log 2&gt;&amp;1"
- 分步（PowerShell）
  - $env:NDK_HOME="D:\android-ndk-r10e"
  - $env:MT3_NO_PAUSE="1"
  - &amp; "e:\MT3\client\android\LocojoyProject\mt3_build.bat"
  - Set-Location "e:\MT3\client\android\LocojoyProject\build"
  - ant -buildfile build.xml release *&gt; "e:\MT3\build_logs\android_ant_release_full.log"

七、后续动作（待 NDK 与工具链路径确认后继续）
- 继续读取并分组分析构建日志中的后续错误（按模块：AAPT/R.java、Javac、Dex、多 dex 合并与签名、资源打包）
- 校准 [build/build.xml](client/android/LocojoyProject/build/build.xml:9) 中 SDK/Build-tools/JDK 路径与本机实际安装位置，必要时改为通过 ant.properties 注入以去硬编码
- 生成 APK 后解包核验：
  - AndroidManifest.xml 与 strings.xml 的 versionCode/versionName 是否仍保留旧值
  - 是否包含“旧版 Android”提示的资源条目（如存在，定位其包来源与触发条件）

附注：本次已完成的工程内改动
- 可控暂停：已将 [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:37) 的固定 pause 改为条件暂停（受 MT3_NO_PAUSE 控制），避免无人值守/日志采集卡死。

========
———
环境自检结果与行动项（2025-10-17 现场排障增编）

一、环境自检快照
- 自检脚本：已运行 [scripts/check_android_env.bat](scripts/check_android_env.bat:20)，输出保存至 [build_logs/android_env_check.log](build_logs/android_env_check.log:1)
- 结论摘要：
  - JDK：OK（1.8.0_144）
  - Ant：OK（1.9.7）
  - Android SDK：OK（Build-Tools 22.0.1、Platform android-22、aapt/dx/android.jar 均存在）
  - NDK：缺失（NDK_HOME 未设置，ndk-build(.cmd) 未找到）
  - Keystore：OK（[build/mt3.keystore](client/android/LocojoyProject/build/mt3.keystore:1) 存在）
  - APP_ABI：armeabi-v7a（匹配项目“仅 v7a”诉求）
  - Manifest/Project target：minSdk=11，targetSdk=17（Ant 工程 [project.properties](client/android/LocojoyProject/project.properties:14) 为 android-17；Ant 打包脚本 [build/build.xml](client/android/LocojoyProject/build/build.xml:14) 依赖 android-22 的 aapt/android.jar，仅用于资源/编译工具，不改变 manifest target）

二、已确认编译阻断与根因
- “'mt3_build.bat' 未被识别为命令”：PowerShell 环境中未使用调用符，或在 CMD 中未用 call 导致上下文中断
  - 影响范围：调用 NDK 构建入口 [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:1) 时即失败，后续 Ant 流程无法进入
- “'ndk-build' 不是内部或外部命令”：NDK 未安装或 NDK_HOME 未指向正确目录，且 PATH 未包含 ndk-build(.cmd)
  - 证据：自检输出 [build_logs/android_env_check.log](build_logs/android_env_check.log:1) “NDK_HOME is not set”、“ndk-build not found: "\ndk-build.cmd"”
  - 影响范围：Native so（libgame.so 等）无法产出，直接阻断后续打包

三、立即修复步骤（可选一种或组合）
1) 安装或还原 NDK r10e（推荐路径：D:\android-ndk-r10e）
   - 要求：确保存在 D:\android-ndk-r10e\ndk-build.cmd
   - 验证：
     - CMD：&quot;D:\android-ndk-r10e\ndk-build.cmd&quot; -h
     - PowerShell：&amp; &quot;D:\android-ndk-r10e\ndk-build.cmd&quot; -h
2) 使用现有 NDK 安装目录设置会话环境变量（不必修改系统全局）
   - CMD（本次会话有效）：
     - set &quot;NDK_HOME=D:\你的NDK目录（包含 ndk-build.cmd）&quot;
     - set &quot;PATH=%NDK_HOME%;%PATH%&quot;  （可选）
   - PowerShell（本次会话有效）：
     - $env:NDK_HOME=&quot;D:\你的NDK目录（包含 ndk-build.cmd）&quot;
     - $env:Path=&quot;$env:NDK_HOME;$env:Path&quot;  （可选）
   - 注意：不要把引号包含进变量值本身（项目脚本会读取字面量，内嵌引号会形成类似 &quot;&quot;D:\...&quot;\ndk-build.cmd&quot; 的非法路径）
3) 一次性构建与日志采集（CMD 模式，已在文档统一示例）
   - cmd /C &quot;mkdir build_logs 2&gt;nul &amp;&amp; set &quot;NDK_HOME=D:\android-ndk-r10e&quot; &amp;&amp; set &quot;MT3_NO_PAUSE=1&quot; &amp;&amp; call e:\MT3\client\android\LocojoyProject\mt3_build.bat &amp;&amp; cd /d e:\MT3\client\android\LocojoyProject\build &amp;&amp; ant -buildfile build.xml release &gt; e:\MT3\build_logs\android_ant_release_full.log 2&gt;&amp;1&quot;

四、脚本与调用层面的对策（已实施与建议）
- 已实施：将 [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:37) 末尾的 pause 调整为条件暂停（if not defined MT3_NO_PAUSE pause），避免无人值守卡死
- 建议增强（如需进一步稳固）
  - 对 NDK_HOME 进行值清洗（去除包裹引号/尾随空格），避免出现 &quot;&quot;路径&quot;\ndk-build.cmd&quot; 这种拼接问题
  - 调用建议：
    - PowerShell：&amp; &quot;e:\MT3\client\android\LocojoyProject\mt3_build.bat&quot;
    - CMD：call e:\MT3\client\android\LocojoyProject\mt3_build.bat

五、关于“此应用专为旧版 Android 打造”提示的定位与对策
- 触发背景判断：当 app 的 targetSdkVersion 明显低于设备系统版本（例如 targetSdk=17 在 Android 13/14 上），系统会显示“针对旧版 Android 构建”的提示
  - 现状：Manifest [AndroidManifest.xml](client/android/LocojoyProject/AndroidManifest.xml:7) targetSdkVersion=17，minSdk=11（Ant 工程老基线）
- 短期策略（维持现有 Ant/工具链不变）：
  - 可接受提示的前提下继续打包发布（风险：系统行为兼容层限制、上架通道审核要求日益提高）
- 中期策略（逐步提高 targetSdk 至 22 附近、仍使用 Ant）：
  - 升级 Android SDK/Build-Tools 至匹配的更高版本（aapt/dx/android.jar）
  - 调整 [build/build.xml](client/android/LocojoyProject/build/build.xml:14) 工具路径，同时在 [project.properties](client/android/LocojoyProject/project.properties:14) 提升 target（例如 android-22）
  - 注意：可能引出 API 行为变化与第三方库兼容性问题，需要回归验证
- 长期策略（迁移 Gradle/AGP，目标 targetSdk ≥ 26/28+）：
  - 以 Gradle 重构构建脚本，逐步升级 target/compile SDK，同时替换 dx→d8、aapt→aapt2，升级第三方 SDK
  - 该方案可彻底消除“旧版 Android”提示

六、版本与线上资源配置复核（你方提醒项执行情况）
- 更新提示界面入口： [GameApp.setContentView()](client/android/LocojoyProject/src/com/locojoy/mini/mt3/GameApp.java:303) → 布局 [res/layout/mt_update.xml](client/android/LocojoyProject/res/layout/mt_update.xml:1)
- 提示文案资源： [res/values/strings.xml](client/android/LocojoyProject/res/values/strings.xml:1)（未检出“此应用专为旧版 Android 打造”字面量，推断为系统层提示或第三方/线上动态文案）
- 版本/线上资源地址：
  - 更新地址/版本清单：[strings.xml.mt3_update_url](client/android/LocojoyProject/res/values/strings.xml:21) / [strings.xml.mt3_verfile_name](client/android/LocojoyProject/res/values/strings.xml:22) / [strings.xml.mt3_update_select_url](client/android/LocojoyProject/res/values/strings.xml:26)
  - SDK 配置： [assets/ljsdk.cfg](client/android/LocojoyProject/assets/ljsdk.cfg:1)（渠道/登录/支付）、[assets/cn.shuzilm.config.json](client/android/LocojoyProject/assets/cn.shuzilm.config.json:1)（数美）
- Manifest 版本字段（需在发版前更新）： [AndroidManifest.xml](client/android/LocojoyProject/AndroidManifest.xml:4) android:versionCode=&quot;1&quot;、[AndroidManifest.xml](client/android/LocojoyProject/AndroidManifest.xml:5) android:versionName=&quot;0.0.1&quot;
  - 建议：统一以构建参数/脚本替换方式注入（可参考 [build/build.xml](client/android/LocojoyProject/build/build.xml:134) 中 replaceregexp 的用法，为 versionCode/versionName 增加替换规则）

七、下一步执行与验证
- 安装/设置 NDK 并通过 ndk-build -h 验证后，执行“一次性构建与日志采集”命令，生成 [build_logs/android_ant_release_full.log](build_logs/android_ant_release_full.log:1)
- 我将：
  - 读取完整日志，分模块（NDK、AAPT/R.java、Javac、Dex、多包与签名、资源打包）逐条定位错误
  - 对每条错误补充“现象 → 根因 → 修复步骤 → 验证命令/路径”条目，持续回填至本手册
  - 对“旧版 Android 提示”给出覆盖式迁移清单（按短/中/长期策略分阶段实施）
———
———
编译报错逐条分析与解决方案（补充清单）

错误一：'mt3_build.bat' not recognized
- 现象
  - [build_logs/android_ant_release_full.log](build_logs/android_ant_release_full.log:1) 显示 “The term 'mt3_build.bat' is not recognized...”
- 根因
  - 在 PowerShell 中直接输入批处理文件名不会像 CMD 那样执行，需要使用调用符号 & 或显式路径；CMD 中建议使用 call 以保持同一会话。
- 修复
  - PowerShell 执行顺序：
    - $env:NDK_HOME="D:\android-ndk-r10e"
    - $env:MT3_NO_PAUSE="1"
    - & "e:\MT3\client\android\LocojoyProject\mt3_build.bat"
    - Set-Location "e:\MT3\client\android\LocojoyProject\build"
    - ant -buildfile build.xml release *> "e:\MT3\build_logs\android_ant_release_full.log"
  - CMD 一次性（推荐）：
    - cmd /C "mkdir build_logs 2>nul && set "NDK_HOME=D:\android-ndk-r10e" && set "MT3_NO_PAUSE=1" && call e:\MT3\client\android\LocojoyProject\mt3_build.bat && cd /d e:\MT3\client\android\LocojoyProject\build && ant -buildfile build.xml release > e:\MT3\build_logs\android_ant_release_full.log 2>&1"
  - 工程侧已优化：将脚本末尾 pause 改为条件暂停，参见 [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:37)

错误二：'ndk-build' 不是内部或外部命令
- 现象
  - 终端日志多次出现 “'ndk-build' 不是内部或外部命令”，且环境自检报告 [build_logs/android_env_check.log](build_logs/android_env_check.log:1) 标记 “[MISS] NDK_HOME is not set”“[MISS] ndk-build not found”
- 根因
  - NDK 未安装或未设置到正确路径；PATH 中未包含 ndk-build(.cmd)
- 修复
  - 安装或还原 r10e 到 D:\android-ndk-r10e，确保存在 D:\android-ndk-r10e\ndk-build.cmd
  - 或设置当前会话环境变量（避免全局污染）：
    - CMD：set "NDK_HOME=D:\android-ndk-r10e" && set "PATH=%NDK_HOME%;%PATH%"
    - PowerShell：$env:NDK_HOME="D:\android-ndk-r10e"; $env:Path="$env:NDK_HOME;$env:Path"
  - 已增强脚本自动探测与清洗：
    - 清洗 NDK_HOME 的引号/空格并打印诊断：[mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:7)
    - 回退 where ndk-build/自动探测常见安装目录：[mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:24)
  - 验证
    - & "D:\android-ndk-r10e\ndk-build.cmd" -h（PowerShell）
    - "D:\android-ndk-r10e\ndk-build.cmd" -h（CMD）

错误三：aapt/dx/javac/jarsigner 工具缺失
- 现状
  - 环境自检 OK（Build-tools 22.0.1、Platform android-22、JDK 1.8.0_144 就绪），但若在其他机器复现缺失：
- 修复
  - 设置 ANDROID_HOME/ANDROID_SDK_ROOT 指向 SDK 根，安装对应组件，校准硬编码路径：
    - 工具路径定义位置：[build/build.xml](client/android/LocojoyProject/build/build.xml:9)
      - sdk-folder、platform-folder、build-tools、jdk-folder
  - 验证命令（任选其一）：
    - "%ANDROID_HOME%\build-tools\22.0.1\aapt.exe" version
    - "%ANDROID_HOME%\build-tools\22.0.1\dx.bat" -version
    - "%JAVA_HOME%\bin\javac.exe" -version
    - "%JAVA_HOME%\bin\jarsigner.exe" -version

错误四：R.java 生成失败或 aapt 打包失败
- 常见信息
  - error: resource … not found / invalid resource directory name / aapt package 失败
- 排查
  - 确认 res、assets、第三方库 res 路径均在 aapt 命令行中（构建定义在 [build/build.xml.gen-R](client/android/LocojoyProject/build/build.xml:178) 与 [build/build.xml.package](client/android/LocojoyProject/build/build.xml:254)）
  - 检查 values/strings 是否非法转义、中文符号、格式错误
  - 清理 gen/bin 后重试（脚本已在 init 中清理：[build/build.xml.init](client/android/LocojoyProject/build/build.xml:125)）
- 修复
  - 修正资源命名/格式；确保第三方库 res 在 paths 中；必要时降噪删除生成产物后重生成

错误五：Javac 编译失败（找不到符号/类路径问题）
- 根因
  - 依赖 jar 未复制到 classpath；第三方源码未加入 src 列表；JDK 版本不匹配
- 排查/修复
  - 确认 jar 被复制到 dexedLibs（[build/build.xml.copy_libs](client/android/LocojoyProject/build/build.xml:157)）
  - 确认 javac 的 src/classpath 包含工程/第三方源码（[build/build.xml.compile](client/android/LocojoyProject/build/build.xml:209)）
  - JDK 使用 1.8（[build/build.xml.tools.javac](client/android/LocojoyProject/build/build.xml:28)）

错误六：Dex 步骤失败（方法数/主 Dex 列表/路径）
- 现状
  - 本工程使用 dx 多 dex 参数与 main-dex-list（[build/build.xml.dex](client/android/LocojoyProject/build/build.xml:232)）
- 排查/修复
  - 确保 dx 路径正确；main-dex-rule.txt 存在（[client/android/LocojoyProject/build/main-dex-rule.txt](client/android/LocojoyProject/build/main-dex-rule.txt:1)）
  - 若包含重复类/冲突 jar，逐步剔除或用 ProGuard（Ant 项里可选）

错误七：undefined reference to 'jpeg_destroy_compress'（Native 链接失败）
- 现象
  - 链接阶段找不到 libjpeg 等符号导致 make.exe Error 1
- 根因
  - Android.mk 未导入 libjpeg/libpng/libz 或链接顺序错误；预编译库缺失
- 修复
  - 在 [client/android/LocojoyProject/jni/Android.mk](client/android/LocojoyProject/jni/Android.mk:1) 引入对应模块/静态库；确保预编库存在（obj/local/armeabi-v7a 或 prebuilt）
  - 执行 ndk-build clean && ndk-build 重试

提示：“此应用专为旧版 Android 打造”
- 来源与原因
  - 该提示为系统层在新系统上对低 targetSdk 的兼容提示。工程当前 targetSdk=17（[AndroidManifest.xml.uses-sdk](client/android/LocojoyProject/AndroidManifest.xml:7)），在 Android 13/14 等新系统会提示“针对旧版 Android 构建/专为旧版 Android 打造”。
- 对策
  - 短期：保留现有 Ant/工具链，接受提示（需评估发行渠道要求）
  - 中期：将 targetSdk 提升到 22 左右；同步 [project.properties](client/android/LocojoyProject/project.properties:14) 与 [build/build.xml](client/android/LocojoyProject/build/build.xml:14) 所需 SDK/Build-tools；回归第三方 SDK 兼容
  - 长期：迁移 Gradle/AGP，逐步升级 compile/target SDK 至当代要求，替换 dx→d8、aapt→aapt2，清理老 API 用法

版本号（Manifest）与线上资源配置
- Manifest 初始版本值：
  - versionCode=1 / versionName=0.0.1（[AndroidManifest.xml](client/android/LocojoyProject/AndroidManifest.xml:4)）
- 建议在 Ant 脚本中用 replaceregexp 注入发版版本号（参考已有的 td_appid/ShareSDK 字段替换： [build/build.xml](client/android/LocojoyProject/build/build.xml:134)）
- 线上资源/更新配置核对：
  - 更新地址与清单： [strings.xml.mt3_update_url](client/android/LocojoyProject/res/values/strings.xml:21)、[strings.xml.mt3_verfile_name](client/android/LocojoyProject/res/values/strings.xml:22)、[strings.xml.mt3_update_select_url](client/android/LocojoyProject/res/values/strings.xml:26)
  - SDK 配置： [assets/ljsdk.cfg](client/android/LocojoyProject/assets/ljsdk.cfg:1)、[assets/cn.shuzilm.config.json](client/android/LocojoyProject/assets/cn.shuzilm.config.json:1)
- 更新界面入口与布局：
  - 入口： [GameApp.setContentView()](client/android/LocojoyProject/src/com/locojoy/mini/mt3/GameApp.java:303)
  - 布局： [res/layout/mt_update.xml](client/android/LocojoyProject/res/layout/mt_update.xml:1)

操作与验证速查
- 设置会话变量（CMD）
  - set "NDK_HOME=D:\android-ndk-r10e" && set "MT3_NO_PAUSE=1"
- 验证工具链
  - "%NDK_HOME%\ndk-build.cmd" -h
  - "%ANDROID_HOME%\build-tools\22.0.1\aapt.exe" version
  - "%ANDROID_HOME%\build-tools\22.0.1\dx.bat" -version
  - "%JAVA_HOME%\bin\jarsigner.exe" -version
- 一次性编译并采集日志（CMD，推荐）
  - cmd /C "mkdir build_logs 2>nul && set "NDK_HOME=D:\android-ndk-r10e" && set "MT3_NO_PAUSE=1" && call e:\MT3\client\android\LocojoyProject\mt3_build.bat && cd /d e:\MT3\client\android\LocojoyProject\build && ant -buildfile build.xml release > e:\MT3\build_logs\android_ant_release_full.log 2>&1"
- 产物位置
  - APK：client/android/LocojoyProject/bin/mt3_locojoy.apk

本次工程内已做的脚本稳健性增强
- 条件暂停： [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:37)
- NDK 路径清洗与诊断打印： [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:7)
- 自动探测常见 NDK 安装目录（D:\ / C:\ 下常见前缀）： [mt3_build.bat](client/android/LocojoyProject/mt3_build.bat:24)

注：完成 NDK 安装与环境变量设置后，重新执行上述一次性编译命令，新的完整日志将覆盖 [build_logs/android_ant_release_full.log](build_logs/android_ant_release_full.log:1)。后续可继续根据日志中的 AAPT/Javac/Dex/签名/资源等阶段性报错，按本清单逐项定位与修复。
———

