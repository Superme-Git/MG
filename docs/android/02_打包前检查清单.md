# Android APK æ‰“åŒ…å‰å¿…æ£€æ¸…å•

> **ç›®æ ‡**: é€šè¿‡ç³»ç»ŸåŒ–æ£€æŸ¥,ç¡®ä¿æ‰“åŒ…ç¯å¢ƒå°±ç»ª,é™ä½é—ªé€€å’Œæ„å»ºå¤±è´¥é£é™©
> **ç”¨æ—¶**: é¦–æ¬¡çº¦5åˆ†é’Ÿ,ç†Ÿæ‚‰åçº¦1åˆ†é’Ÿ
> **åŸåˆ™**: éµå¾ªKISS(ç®€å•è‡³ä¸Š)å’ŒDRY(é¿å…é‡å¤)åŸåˆ™

---

## âœ… ç¬¬1æ­¥:ç¯å¢ƒéªŒè¯(2åˆ†é’Ÿ)

### 1.1 æ ¸å¿ƒå·¥å…·ç‰ˆæœ¬æ£€æŸ¥

åœ¨å‘½ä»¤è¡Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤,ç¡®ä¿æ‰€æœ‰å·¥å…·å¯ç”¨:

```cmd
# JDK æ£€æŸ¥(è¦æ±‚: 1.8.0_144)
java -version
javac -version

# Ant æ£€æŸ¥(è¦æ±‚: 1.9.x)
ant -version

# Android SDK æ£€æŸ¥(è¦æ±‚: Build-Tools 22.0.1)
"%ANDROID_HOME%\build-tools\22.0.1\aapt.exe" version

# NDK æ£€æŸ¥(è¦æ±‚: r10e)
"%NDK_HOME%\ndk-build.cmd" -h
```

**å¿«é€ŸéªŒè¯è„šæœ¬**: [tools/validate/android_env_check.bat](../../tools/validate/android_env_check.bat)

### 1.2 ç¯å¢ƒå˜é‡éªŒè¯

| å˜é‡ | æœŸæœ›å€¼ç¤ºä¾‹ | æ£€æŸ¥å‘½ä»¤ |
|------|-----------|---------|
| JAVA_HOME | C:\Program Files\Java\jdk1.8.0_144 | echo %JAVA_HOME% |
| ANDROID_HOME | C:\Program Files (x86)\Android\android-sdk | echo %ANDROID_HOME% |
| NDK_HOME | D:\android-ndk-r10e | echo %NDK_HOME% |
| ANT_HOME | C:\apache-ant-1.9.7 | echo %ANT_HOME% |

**æ³¨æ„**: å¦‚æœå˜é‡æœªè®¾ç½®,å¯åœ¨å½“å‰ä¼šè¯ä¸´æ—¶è®¾ç½®(ä¸å½±å“ç³»ç»Ÿ):
```cmd
set "NDK_HOME=D:\android-ndk-r10e"
```

---

## âœ… ç¬¬2æ­¥:ABIé…ç½®æ£€æŸ¥(1åˆ†é’Ÿ)

### 2.1 ç¡®è®¤ä»…æ”¯æŒ armeabi-v7a

æ£€æŸ¥ [Application.mk](../../client/android/LocojoyProject/jni/Application.mk):

```makefile
APP_ABI := armeabi-v7a
```

**âŒ ç¦æ­¢**: æ·»åŠ  arm64-v8a æˆ–å…¶ä»–ABI,å½“å‰é¡¹ç›®ä¸æ”¯æŒ64ä½!

### 2.2 æ£€æŸ¥ç›®æ ‡è®¾å¤‡ABI

è¿æ¥æµ‹è¯•è®¾å¤‡åæ‰§è¡Œ:
```cmd
adb shell getprop ro.product.cpu.abi
```

**æœŸæœ›è¾“å‡º**: `armeabi-v7a` æˆ– `armeabi` (å‘ä¸‹å…¼å®¹)

**è­¦å‘Š**: å¦‚æœè¾“å‡º `arm64-v8a` ä¸”æ— 32ä½å…¼å®¹,APKå°†æ— æ³•è¿è¡Œ!

---

## âœ… ç¬¬3æ­¥:ä¾èµ–åº“å®Œæ•´æ€§æ£€æŸ¥(1åˆ†é’Ÿ)

### 3.1 æ£€æŸ¥é¢„ç¼–è¯‘å…±äº«åº“(.so)

ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨:

```cmd
# ç™¾åº¦å®šä½SDK
dir /b client\3rdplatform\BaiduLBS_AndroidSDK_Lib\libs\armeabi-v7a\liblocSDK6a.so

# DU SDK
dir /b client\3rdplatform\duClient_SDK_Lib\libs\armeabi-v7a\libdu.so
```

### 3.2 æ£€æŸ¥é™æ€åº“(.a)

NDKæ„å»ºéœ€è¦çš„é™æ€åº“(é€šå¸¸ä½äºcocos2dç›®å½•):
- libpng.a
- libjpeg.a
- libz.a

**éªŒè¯**: æ‰§è¡ŒNDKæ„å»º,è‹¥æŠ¥ `undefined reference to png_*` åˆ™è¯´æ˜ç¼ºå¤±

---

## âœ… ç¬¬4æ­¥:Manifesté…ç½®æ£€æŸ¥(30ç§’)

æ£€æŸ¥ [AndroidManifest.xml](../../client/android/LocojoyProject/AndroidManifest.xml):

```xml
<uses-sdk
    android:minSdkVersion="11"
    android:targetSdkVersion="17" />
```

### å…³é”®æ£€æŸ¥ç‚¹:

| é…ç½®é¡¹ | å½“å‰å€¼ | è¯´æ˜ |
|--------|--------|------|
| minSdkVersion | 11 | æ”¯æŒAndroid 3.0+ |
| targetSdkVersion | 17 | åœ¨æ–°è®¾å¤‡ä¼šæç¤º"æ—§ç‰ˆAndroid"(è§é™„å½•) |
| versionCode | éœ€é€’å¢ | è¦†ç›–å®‰è£…éœ€é«˜äºå·²è£…ç‰ˆæœ¬ |
| versionName | éœ€æ›´æ–° | ç”¨æˆ·å¯è§ç‰ˆæœ¬å· |

**å»ºè®®**: å‘ç‰ˆå‰ç”¨replaceregexpåœ¨build.xmlä¸­åŠ¨æ€æ³¨å…¥ç‰ˆæœ¬å·

---

## âœ… ç¬¬5æ­¥:MultiDexè§„åˆ™æ£€æŸ¥(30ç§’)

æ£€æŸ¥ main-dex-rule.txt(å¦‚ä½¿ç”¨):

```
com/locojoy/mini/mt3/Mt3Application.class
com/locojoy/mini/mt3/GameApp.class
```

**å¿…é¡»åŒ…å«**:
1. Applicationç±» (Mt3Application)
2. å…¥å£Activity (GameApp)
3. MultiDexæ”¯æŒç±»

**å¸¸è§é”™è¯¯**: ç¼ºå°‘å…³é”®ç±»å¯¼è‡´å¯åŠ¨æ—¶ ClassNotFoundException é—ªé€€

---

## âœ… ç¬¬6æ­¥:ç­¾åé…ç½®æ£€æŸ¥(30ç§’)

æŸ¥çœ‹ç­¾åé…ç½®æ¥è‡ª ant.properties:
```cmd
type client\android\LocojoyProject\ant.properties
```

æ ¸å¯¹å…³é”®é¡¹:
- key.store æŒ‡å‘ keystore æ‰€åœ¨ç›®å½•ï¼ˆå½“å‰ç¤ºä¾‹: ../../chuhancommon/android_adtï¼‰
- key.alias ä¸ºè¯ä¹¦åˆ«å

éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨(æ ¹æ®key.storeå±•å¼€å®é™…è·¯å¾„):
```cmd
dir /b client\android\chuhancommon\android_adt\*
```

**å®‰å…¨æç¤º**:
- âŒ ç”Ÿäº§ç¯å¢ƒå‹¿åœ¨è„šæœ¬ä¸­ç¡¬ç¼–ç å¯†ç 
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¤–éƒ¨é…ç½®æ–‡ä»¶æ³¨å…¥

---

## âœ… ç¬¬7æ­¥:æ¸…ç†æ—§æ„å»ºäº§ç‰©(å¯é€‰)

é¿å…ä½¿ç”¨è¿‡æœŸçš„ä¸­é—´æ–‡ä»¶:

```cmd
cd client\android\LocojoyProject

# æ¸…ç†NDKäº§ç‰©
rd /s /q obj\local\armeabi-v7a

# æ¸…ç†Antäº§ç‰©
cd build
ant clean
```

---

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥å‘½ä»¤æ¸…å•

å¤åˆ¶ä»¥ä¸‹å‘½ä»¤åˆ°ç»ˆç«¯ä¸€é”®æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥:

```cmd
echo === ç¯å¢ƒæ£€æŸ¥ ===
java -version && javac -version && ant -version
echo.

echo === NDKæ£€æŸ¥ ===
"%NDK_HOME%\ndk-build.cmd" -h
echo.

echo === ABIé…ç½® ===
findstr APP_ABI client\android\LocojoyProject\jni\Application.mk
echo.

echo === ä¾èµ–åº“æ£€æŸ¥ ===
dir /b client\3rdplatform\*SDK*\libs\armeabi-v7a\*.so
echo.

echo === ç­¾åæ–‡ä»¶ ===
dir /b client\android\LocojoyProject\build\mt3.keystore
echo.

echo === å®Œæˆ! æ‰€æœ‰æ£€æŸ¥é€šè¿‡å³å¯å¼€å§‹æ‰“åŒ… ===
```

---

## ğŸš€ é€šè¿‡æ£€æŸ¥åçš„ä¸‹ä¸€æ­¥

ä½¿ç”¨å¢å¼ºç‰ˆæ‰“åŒ…è„šæœ¬(è‡ªåŠ¨è®°å½•è¯¦ç»†æ—¥å¿—):

```cmd
cd client\android\LocojoyProject
build_with_log.bat
```

**æ—¥å¿—ä½ç½®**: `build_logs\android_build_YYYYMMDD_HHMMSS.log`

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- é—ªé€€é—®é¢˜è¯Šæ–­: [05_é—®é¢˜è¯Šæ–­å†³ç­–æ ‘.md](05_é—®é¢˜è¯Šæ–­å†³ç­–æ ‘.md)
- è¯¦ç»†æ’é”™æ‰‹å†Œ: [06_å®Œæ•´æ’é”™æ‰‹å†Œ.md](06_å®Œæ•´æ’é”™æ‰‹å†Œ.md)
- ç¯å¢ƒé…ç½®è¯¦è§£: [../common/Android_Env.md](../common/Android_Env.md)

---

## é™„å½•:å¸¸è§é—®é¢˜é€ŸæŸ¥

### Q1: targetSdkVersion=17 ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜?

**A**: åœ¨Android 13/14ç­‰æ–°ç³»ç»Ÿä¸Šä¼šæ˜¾ç¤º"æ­¤åº”ç”¨ä¸“ä¸ºæ—§ç‰ˆAndroidæ‰“é€ "æç¤º,ä½†ä¸å½±å“å®‰è£…å’Œè¿è¡Œ(ä»…å…¼å®¹æ€§è­¦å‘Š)ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- çŸ­æœŸ: æ¥å—æç¤º,ç»§ç»­ä½¿ç”¨
- ä¸­æœŸ: æå‡åˆ°targetSdk=22
- é•¿æœŸ: è¿ç§»Gradleå¹¶å‡çº§åˆ°28+

### Q2: å¦‚ä½•ç¡®è®¤æ˜¯å¦éœ€è¦64ä½æ”¯æŒ?

**A**: æ£€æŸ¥ç›®æ ‡è®¾å¤‡:
```cmd
adb shell getprop ro.product.cpu.abilist
```

å¦‚æœ**åªæœ‰** `arm64-v8a` ä¸”æ—  `armeabi-v7a`,åˆ™è®¾å¤‡ä¸æ”¯æŒ32ä½,éœ€é€‚é…arm64ã€‚

### Q3: æ‰“åŒ…è„šæœ¬å¡åœ¨"pause"æ€ä¹ˆåŠ?

**A**: è®¾ç½®ç¯å¢ƒå˜é‡è·³è¿‡æš‚åœ:
```cmd
set "MT3_NO_PAUSE=1"
build_with_log.bat
```

æˆ–ç›´æ¥ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬,å·²å†…ç½®é˜²å¡æ­»é€»è¾‘ã€‚

---

**æœ€åæ›´æ–°**: 2025-10-17
**ç»´æŠ¤è€…**: MT3é¡¹ç›®ç»„
