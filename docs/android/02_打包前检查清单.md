# Android APK 打包前必检清单

> **目标**: 通过系统化检查,确保打包环境就绪,降低闪退和构建失败风险
> **用时**: 首次约5分钟,熟悉后约1分钟
> **原则**: 遵循KISS(简单至上)和DRY(避免重复)原则

---

## ✅ 第1步:环境验证(2分钟)

### 1.1 核心工具版本检查

在命令行执行以下命令,确保所有工具可用:

```cmd
# JDK 检查(要求: 1.8.0_144)
java -version
javac -version

# Ant 检查(要求: 1.9.x)
ant -version

# Android SDK 检查(要求: Build-Tools 22.0.1)
"%ANDROID_HOME%\build-tools\22.0.1\aapt.exe" version

# NDK 检查(要求: r10e)
"%NDK_HOME%\ndk-build.cmd" -h
```

**快速验证脚本**: [tools/validate/android_env_check.bat](../../tools/validate/android_env_check.bat)

### 1.2 环境变量验证

| 变量 | 期望值示例 | 检查命令 |
|------|-----------|---------|
| JAVA_HOME | C:\Program Files\Java\jdk1.8.0_144 | echo %JAVA_HOME% |
| ANDROID_HOME | C:\Program Files (x86)\Android\android-sdk | echo %ANDROID_HOME% |
| NDK_HOME | D:\android-ndk-r10e | echo %NDK_HOME% |
| ANT_HOME | C:\apache-ant-1.9.7 | echo %ANT_HOME% |

**注意**: 如果变量未设置,可在当前会话临时设置(不影响系统):
```cmd
set "NDK_HOME=D:\android-ndk-r10e"
```

---

## ✅ 第2步:ABI配置检查(1分钟)

### 2.1 确认仅支持 armeabi-v7a

检查 [Application.mk](../../client/android/LocojoyProject/jni/Application.mk):

```makefile
APP_ABI := armeabi-v7a
```

**❌ 禁止**: 添加 arm64-v8a 或其他ABI,当前项目不支持64位!

### 2.2 检查目标设备ABI

连接测试设备后执行:
```cmd
adb shell getprop ro.product.cpu.abi
```

**期望输出**: `armeabi-v7a` 或 `armeabi` (向下兼容)

**警告**: 如果输出 `arm64-v8a` 且无32位兼容,APK将无法运行!

---

## ✅ 第3步:依赖库完整性检查(1分钟)

### 3.1 检查预编译共享库(.so)

确保以下文件存在:

```cmd
# 百度定位SDK
dir /b client\3rdplatform\BaiduLBS_AndroidSDK_Lib\libs\armeabi-v7a\liblocSDK6a.so

# DU SDK
dir /b client\3rdplatform\duClient_SDK_Lib\libs\armeabi-v7a\libdu.so
```

### 3.2 检查静态库(.a)

NDK构建需要的静态库(通常位于cocos2d目录):
- libpng.a
- libjpeg.a
- libz.a

**验证**: 执行NDK构建,若报 `undefined reference to png_*` 则说明缺失

---

## ✅ 第4步:Manifest配置检查(30秒)

检查 [AndroidManifest.xml](../../client/android/LocojoyProject/AndroidManifest.xml):

```xml
<uses-sdk
    android:minSdkVersion="11"
    android:targetSdkVersion="17" />
```

### 关键检查点:

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| minSdkVersion | 11 | 支持Android 3.0+ |
| targetSdkVersion | 17 | 在新设备会提示"旧版Android"(见附录) |
| versionCode | 需递增 | 覆盖安装需高于已装版本 |
| versionName | 需更新 | 用户可见版本号 |

**建议**: 发版前用replaceregexp在build.xml中动态注入版本号

---

## ✅ 第5步:MultiDex规则检查(30秒)

检查 main-dex-rule.txt(如使用):

```
com/locojoy/mini/mt3/Mt3Application.class
com/locojoy/mini/mt3/GameApp.class
```

**必须包含**:
1. Application类 (Mt3Application)
2. 入口Activity (GameApp)
3. MultiDex支持类

**常见错误**: 缺少关键类导致启动时 ClassNotFoundException 闪退

---

## ✅ 第6步:签名配置检查(30秒)

查看签名配置来自 ant.properties:
```cmd
type client\android\LocojoyProject\ant.properties
```

核对关键项:
- key.store 指向 keystore 所在目录（当前示例: ../../chuhancommon/android_adt）
- key.alias 为证书别名

验证文件是否存在(根据key.store展开实际路径):
```cmd
dir /b client\android\chuhancommon\android_adt\*
```

**安全提示**:
- ❌ 生产环境勿在脚本中硬编码密码
- ✅ 使用环境变量或外部配置文件注入

---

## ✅ 第7步:清理旧构建产物(可选)

避免使用过期的中间文件:

```cmd
cd client\android\LocojoyProject

# 清理NDK产物
rd /s /q obj\local\armeabi-v7a

# 清理Ant产物
cd build
ant clean
```

---

## 📋 快速检查命令清单

复制以下命令到终端一键执行所有检查:

```cmd
echo === 环境检查 ===
java -version && javac -version && ant -version
echo.

echo === NDK检查 ===
"%NDK_HOME%\ndk-build.cmd" -h
echo.

echo === ABI配置 ===
findstr APP_ABI client\android\LocojoyProject\jni\Application.mk
echo.

echo === 依赖库检查 ===
dir /b client\3rdplatform\*SDK*\libs\armeabi-v7a\*.so
echo.

echo === 签名文件 ===
dir /b client\android\LocojoyProject\build\mt3.keystore
echo.

echo === 完成! 所有检查通过即可开始打包 ===
```

---

## 🚀 通过检查后的下一步

使用增强版打包脚本(自动记录详细日志):

```cmd
cd client\android\LocojoyProject
build_with_log.bat
```

**日志位置**: `build_logs\android_build_YYYYMMDD_HHMMSS.log`

---

## 🔗 相关文档

- 闪退问题诊断: [05_问题诊断决策树.md](05_问题诊断决策树.md)
- 详细排错手册: [06_完整排错手册.md](06_完整排错手册.md)
- 环境配置详解: [../common/Android_Env.md](../common/Android_Env.md)

---

## 附录:常见问题速查

### Q1: targetSdkVersion=17 会导致什么问题?

**A**: 在Android 13/14等新系统上会显示"此应用专为旧版Android打造"提示,但不影响安装和运行(仅兼容性警告)。

**解决方案**:
- 短期: 接受提示,继续使用
- 中期: 提升到targetSdk=22
- 长期: 迁移Gradle并升级到28+

### Q2: 如何确认是否需要64位支持?

**A**: 检查目标设备:
```cmd
adb shell getprop ro.product.cpu.abilist
```

如果**只有** `arm64-v8a` 且无 `armeabi-v7a`,则设备不支持32位,需适配arm64。

### Q3: 打包脚本卡在"pause"怎么办?

**A**: 设置环境变量跳过暂停:
```cmd
set "MT3_NO_PAUSE=1"
build_with_log.bat
```

或直接使用自动化脚本,已内置防卡死逻辑。

---

**最后更新**: 2025-10-17
**维护者**: MT3项目组
