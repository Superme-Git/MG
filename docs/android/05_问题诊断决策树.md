# Android APK 闪退诊断决策树

> **目标**: 快速定位APK闪退原因并提供精准解决方案
> **适用场景**: 安装失败、启动闪退、运行时崩溃
> **诊断时间**: 3-10分钟

---

> 使用本手册前，请先确认已按照《[02_打包前检查清单](02_���ǰ����嵥.md)》《[03_打包流程指南](03_��������ָ��.md)》完成全部前置步骤。
## 🔍 第一步:确定问题类型

```
                    APK行为异常
                        │
          ┌─────────────┼─────────────┐
          │             │             │
     安装失败         启动闪退      运行时崩溃
       (↓A)          (↓B)          (↓C)
```

---

## 🚫 场景A: 安装失败

### A1. 获取错误代码

```cmd
adb install -r bin\mt3_locojoy.apk
```

观察输出的错误代码,然后跳转到对应诊断:

| 错误代码 | 症状 | 跳转 |
|---------|------|------|
| -7 | 应用已存在 | → A2 |
| -26 | 权限模型降级 | → A3 |
| -505/-504 | 签名冲突 | → A4 |
| -19/-103 | ABI不匹配 | → A5 |
| -12 | 空间不足 | → A6 |

---

### A2. 错误 -7: 应用已存在

**原因**: 设备上已有同包名应用(可能签名不同)

**解决方案**:
```cmd
# 方案1: 卸载旧版本
adb uninstall com.locojoy.mini.mt3.locojoy

# 方案2: 如果方案1失败,尝试指定用户
adb shell pm uninstall --user 0 com.locojoy.mini.mt3.locojoy

# 重新安装
adb install -r bin\mt3_locojoy.apk
```

**验证**: 安装成功后执行
```cmd
adb shell pm list packages | findstr mt3
```

---

### A3. 错误 -26: 权限模型降级

**原因**: 新APK的targetSdkVersion低于设备上已安装版本

**症状**:
- 设备上已有targetSdk=27的版本
- 新安装的是targetSdk=17的版本

**解决方案**:

**方案1**(推荐): 卸载旧版本
```cmd
adb uninstall com.locojoy.mini.mt3.locojoy
adb install build\bin\mt3_locojoy.apk
```

**方案2**: 提升新版本的targetSdkVersion

编辑 [AndroidManifest.xml](../../client/android/LocojoyProject/AndroidManifest.xml):
```xml
<uses-sdk
    android:minSdkVersion="11"
    android:targetSdkVersion="27" />  <!-- 改为≥旧版本 -->
```

重新打包后安装。

---

### A4. 错误 -505/-504: 签名冲突

**原因**: 新旧APK使用了不同的签名证书

**诊断**:

检查当前APK签名:
```cmd
keytool -list -v -keystore client\android\LocojoyProject\build\mt3.keystore
```

检查已安装APK签名:
```cmd
adb shell pm list packages -f | findstr mt3
# 记录路径后执行
adb pull /data/app/xxx/base.apk
keytool -printcert -jarfile base.apk
```

**解决方案**:

如果签名不同:
```cmd
# 卸载旧版本
adb uninstall com.locojoy.mini.mt3.locojoy

# 使用正确的keystore重新签名并安装
adb install build\bin\mt3_locojoy.apk
```

---

### A5. 错误 -19/-103: ABI不匹配

**原因**: APK内的native库(.so)与设备CPU架构不兼容

**诊断**:

```cmd
# 检查设备ABI
adb shell getprop ro.product.cpu.abi

# 检查APK包含的ABI
aapt dump badging bin\mt3_locojoy.apk | findstr native-code
```

**常见情况**:
- 设备: arm64-v8a (仅64位)
- APK: armeabi-v7a (仅32位)
- **结果**: 不兼容!

**解决方案**:

**方案1**: 更换支持32位的测试设备

**方案2**: 适配arm64-v8a架构(需要代码适配)
1. 修改 [Application.mk](../../client/android/LocojoyProject/jni/Application.mk):
   ```makefile
   APP_ABI := armeabi-v7a arm64-v8a
   ```
2. 解决所有64位兼容性问题
3. 重新编译所有第三方so库

**注意**: 当前项目**不支持64位**,请使用方案1!

---

### A6. 错误 -12: 空间不足

**解决方案**:
```cmd
# 检查设备存储空间
adb shell df

# 清理不必要的应用和缓存后重试
```

---

## ⚡ 场景B: 启动闪退

### B1. 抓取logcat日志

**关键步骤**:
```cmd
# 清空日志
adb logcat -c

# 启动应用
adb shell am start -n com.locojoy.mini.mt3.locojoy/.GameApp

# 抓取崩溃日志
adb logcat -d > crash_log.txt
```

### B2. 分析崩溃日志

在 `crash_log.txt` 中搜索以下关键字:

| 关键字 | 可能原因 | 跳转 |
|--------|---------|------|
| `ClassNotFoundException` | MultiDex配置错误 | → B3 |
| `UnsatisfiedLinkError` | Native库加载失败 | → B4 |
| `NoClassDefFoundError` | 类缺失/Dex问题 | → B5 |
| `RuntimeException: Unable to instantiate application` | Application初始化失败 | → B6 |

---

### B3. ClassNotFoundException

**典型日志**:
```
ClassNotFoundException: Didn't find class "com.locojoy.mini.mt3.Mt3Application"
```

**原因**: 关键类未包含在主dex中

**解决方案**:

检查 main-dex-rule.txt(如使用):

```
com/locojoy/mini/mt3/Mt3Application.class
com/locojoy/mini/mt3/GameApp.class
android/support/multidex/MultiDexApplication.class
```

**必须包含**:
1. Application类
2. 入口Activity
3. MultiDex框架类

修改后重新打包:
```cmd
cd client\android\LocojoyProject
ant -buildfile build.xml clean
ant -buildfile build.xml release
```

---

### B4. UnsatisfiedLinkError

**典型日志**:
```
UnsatisfiedLinkError: dlopen failed: library "libgame.so" not found
```

**原因**: Native库缺失或加载失败

**诊断步骤**:

**步骤1**: 检查APK内是否包含.so文件
```cmd
aapt list bin\mt3_locojoy.apk | findstr lib/armeabi-v7a
```

**步骤2**: 检查so文件是否生成
```cmd
dir /b client\android\LocojoyProject\libs\armeabi-v7a\*.so
```

**解决方案**:

**情况1**: so文件未生成
```cmd
cd client\android\LocojoyProject
set "NDK_HOME=D:\android-ndk-r10e"
mt3_build.bat
```

检查NDK构建日志,解决编译错误。

**情况2**: so文件存在但APK中缺失

检查 [build.xml](../../client/android/LocojoyProject/build.xml:1) 的 `package` 任务是否正确包含libs目录。

**情况3**: so依赖的库缺失

典型错误:
```
undefined reference to `jpeg_destroy_compress'
```

需要在 [Android.mk](../../client/android/LocojoyProject/jni/Android.mk) 中链接静态库:
```makefile
LOCAL_STATIC_LIBRARIES := libjpeg libpng libz
```

---

### B5. NoClassDefFoundError

**原因**: Dex文件生成失败或类路径问题

**解决方案**:

**步骤1**: 清理并重新生成dex
```cmd
cd client\android\LocojoyProject
ant -buildfile build.xml clean
ant -buildfile build.xml -v release > build_verbose.log 2>&1
```

**步骤2**: 检查build_verbose.log中的dx命令输出

搜索关键字: `dx --dex --multi-dex`

确认:
- main-dex-list 参数正确
- 所有jar文件被包含
- 没有重复类冲突

---

### B6. Application初始化失败

**典型日志**:
```
RuntimeException: Unable to instantiate application com.locojoy.mini.mt3.Mt3Application
```

**原因**: Application类构造函数或attachBaseContext抛出异常

**诊断**:

检查 [Mt3Application.java](../../client/android/LocojoyProject/src/com/locojoy/mini/mt3/Mt3Application.java):

```java
@Override
protected void attachBaseContext(Context base) {
    super.attachBaseContext(base);
    MultiDex.install(this);  // 可能在此处失败
}
```

**解决方案**:

1. 确认MultiDex依赖已包含在classpath
2. 检查main-dex-rule.txt包含MultiDex类
3. 查看完整堆栈跟踪找到具体异常原因

---

## 💥 场景C: 运行时崩溃

### C1. 常见运行时崩溃类型

| 崩溃类型 | 关键字 | 可能原因 |
|---------|--------|---------|
| 空指针异常 | `NullPointerException` | 代码逻辑错误 |
| 数组越界 | `ArrayIndexOutOfBoundsException` | 代码逻辑错误 |
| 网络请求失败 | `NetworkOnMainThreadException` | 主线程执行网络操作 |
| 资源未找到 | `ResourceNotFoundException` | 资源ID错误或缺失 |

### C2. 抓取详细堆栈

```cmd
# 实时监控日志
adb logcat AndroidRuntime:E *:S

# 或保存到文件
adb logcat AndroidRuntime:E *:S > runtime_crash.log
```

### C3. 通用排查流程

1. **定位崩溃代码位置**: 查看堆栈中的 `at com.locojoy...` 行
2. **复现问题**: 记录崩溃前的操作步骤
3. **添加日志**: 在怀疑的代码处添加Log.d输出
4. **重新打包测试**: 使用 build_with_log.bat 重新构建

---

## 🛠 诊断工具箱

### 快速诊断命令合集

```cmd
# 设备信息
adb shell getprop ro.product.cpu.abi
adb shell getprop ro.build.version.sdk

# 已安装应用信息
adb shell dumpsys package com.locojoy.mini.mt3.locojoy | findstr versionCode
adb shell pm list packages | findstr mt3

# APK信息
aapt dump badging bin\mt3_locojoy.apk
aapt list bin\mt3_locojoy.apk | findstr lib/

# 实时日志过滤
adb logcat | findstr -i "mt3 error exception crash"
```

### 日志分析技巧

**关键搜索词**:
- `FATAL` - 致命错误
- `AndroidRuntime` - 应用崩溃
- `BEGIN CRASH` - 崩溃开始标记
- `Process:` - 崩溃进程信息
- `at com.locojoy` - 项目代码堆栈

**推荐工具**:
- VSCode + 正则搜索
- Notepad++ 大文件查看
- 在线堆栈分析工具

---

## 🎯 常见闪退原因Top 5

### 1. ABI不匹配 (60%)
- **症状**: INSTALL_FAILED_NO_MATCHING_ABIS
- **快速修复**: 更换32位兼容设备

### 2. MultiDex配置错误 (20%)
- **症状**: ClassNotFoundException on startup
- **快速修复**: 检查main-dex-rule.txt

### 3. Native库缺失 (10%)
- **症状**: UnsatisfiedLinkError: libgame.so
- **快速修复**: 重新执行NDK构建

### 4. 签名/版本冲突 (5%)
- **症状**: 安装错误-505/-7/-26
- **快速修复**: 卸载旧版本

### 5. 代码逻辑错误 (5%)
- **症状**: 运行时各类Exception
- **快速修复**: 分析logcat堆栈

---

## 📚 相关文档

- 打包前检查: [02_打包前检查清单.md](02_打包前检查清单.md)
- 详细排错: [06_完整排错手册.md](06_完整排错手册.md)
- 环境配置: [../common/Android_Env.md](../common/Android_Env.md)

---

## 🆘 仍然无法解决?

### 完整诊断流程

1. **收集信息**:
   ```cmd
   # 生成完整诊断报告
   adb shell getprop > device_info.txt
   adb logcat -d > full_logcat.txt
   aapt dump badging bin\mt3_locojoy.apk > apk_info.txt
   ```

2. **使用增强日志重新打包**:
   ```cmd
   cd client\android\LocojoyProject
   build_with_log.bat
   ```

3. **分析构建日志**:
   检查 `build_logs\android_build_YYYYMMDD_HHMMSS.log`

4. **提交issue**:
   - 附带上述3个文件
   - 描述复现步骤
   - 说明设备型号和系统版本

---

**最后更新**: 2025-10-17
**维护者**: MT3项目组

**原则说明**: 本文档遵循KISS(Keep It Simple, Stupid)原则,通过决策树快速定位问题,避免重复排查(DRY原则)。


