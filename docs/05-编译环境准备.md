# MT3项目编译环境准备指南

**文档版本**: 1.0
**创建日期**: 2025-10-13
**适用对象**: 首次设置编译环境的开发人员
**预计耗时**: 30-60分钟

---

## 📋 概述

本指南将帮助您从零开始准备MT3项目的完整编译环境,包括工具安装、环境配置和验证测试。

---

## 🎯 环境要求总览

### 硬件要求

| 项目 | 最低配置 | 推荐配置 |
|-----|---------|---------|
| **CPU** | Intel Core i3 | Intel Core i5/i7 |
| **内存** | 8GB | 16GB或以上 |
| **磁盘空间** | 10GB | 20GB或以上 (SSD) |
| **操作系统** | Windows 7 SP1 | Windows 10/11 |

### 软件要求

| 软件 | 版本要求 | 必需性 | 下载链接 |
|-----|---------|-------|---------|
| **Visual Studio** | 2013/2019 with v120 | ✅ 必需 | [微软官网](https://visualstudio.microsoft.com/) |
| **Windows SDK** | 8.1 | ✅ 必需 | 随VS安装 |
| **Git** | 2.x | ⚠️ 推荐 | [git-scm.com](https://git-scm.com/) |
| **PowerShell** | 5.0+ | ⚠️ 推荐 | Windows内置 |

---

## 📥 步骤一: 安装Visual Studio

### 方案A: 安装Visual Studio 2013 (推荐)

#### 1.1 下载安装包

**下载地址**:
- 官方: [Visual Studio 2013 Update 5](https://visualstudio.microsoft.com/vs/older-downloads/)
- 需要Microsoft账号登录

**所需组件**:
- ✅ Visual C++
- ✅ Windows SDK 8.1
- ✅ MFC和ATL支持
- ❌ C#/.NET (可选,不必需)

#### 1.2 安装步骤

```plaintext
1. 运行安装程序 vs_ultimate.exe
2. 选择"自定义"安装
3. 勾选以下组件:
   ☑ Visual C++
   ☑ Microsoft Foundation Classes for C++
   ☑ Windows SDK 8.1
4. 选择安装路径 (建议默认)
5. 点击"安装"
6. 等待安装完成 (约30-60分钟)
```

#### 1.3 验证安装

```batch
# 打开命令提示符
"C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\vcvarsall.bat" x86

# 验证编译器
cl
# 应显示: Microsoft (R) C/C++ Optimizing Compiler Version 18.00...

# 验证MSBuild
msbuild /version
# 应显示: 12.0.xxxxx.x
```

---

### 方案B: 安装Visual Studio 2019 + v120工具集

#### 1.1 下载安装包

**下载地址**: [Visual Studio 2019 Community](https://visualstudio.microsoft.com/downloads/)

#### 1.2 安装步骤

```plaintext
1. 运行 vs_community.exe
2. 选择"使用C++的桌面开发"工作负载
3. 在右侧"安装详细信息"中额外勾选:
   ☑ MSVC v120 - VS 2013 C++ x86/x64生成工具
   ☑ Windows 10 SDK
   ☑ Windows 8.1 SDK
4. 点击"安装"
5. 等待安装完成 (约1-2小时)
```

#### 1.3 验证v120工具集

```batch
# 查看安装的工具集
dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC"

# 应该看到v120相关目录
# 14.0.xxxxx (v120)
```

---

## 🔧 步骤二: 配置环境变量

### 2.1 添加MSBuild到PATH

```batch
# 方法1: 永久添加 (推荐)
setx PATH "%PATH%;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin" /M

# 方法2: 临时添加 (当前会话)
set PATH=%PATH%;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin
```

### 2.2 验证环境变量

```batch
# 打开新的命令提示符
msbuild /version

# 应显示版本信息
```

---

## 📦 步骤三: 准备项目源码

### 3.1 获取源码

```batch
# 方法1: 从Git仓库克隆 (如果有)
git clone <仓库地址> MT3Project
cd MT3Project

# 方法2: 解压源码包
# 将源码解压到工作目录,例如:
# E:\梦幻西游MG原版源码\
```

### 3.2 验证目录结构

```batch
cd "e:\MT3"
dir

# 应该看到以下目录:
# client/
# engine/
# common/
# cocos2d-2.0-rc2-x-2.0.1/
# docs/
# build_mt3_v120_complete.bat
```

---

## 🔍 步骤四: 依赖项检查

### 4.1 检查预编译库

```batch
# 检查FireClient预编译库
dir client\FireClient\Release.win32\FireClient.lib

# 检查Cocos2d-x库
dir cocos2d-2.0-rc2-x-2.0.1\Release.win32\libcocos2d.lib
```

### 4.2 检查第三方DLL

```batch
# 检查运行时DLL
dir client\resource\bin\debug\*.dll

# 应该包含:
# libcocos2d.dll
# libCocosDenshion.dll
# glew32.dll
# pthreadVCE2.dll
# libcurl.dll
# iconv.dll
# libxml2.dll
# zlib1.dll
# fmodex.dll
```

**如果缺少DLL**: 查看 [docs/06-编译完整指南.md](./06-编译完整指南.md:1) 第三方库章节

---

## ✅ 步骤五: 环境验证

### 5.1 编译测试

```batch
# 进入项目根目录
cd "e:\MT3"

# 编译单个模块测试
msbuild common\lua\lua.vcxproj /t:Build /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120

# 检查输出
dir common\lua\Release.win32\lua.lib
```

**预期结果**: 编译成功,生成lua.lib

### 5.2 运行测试

```batch
# 运行原始版本测试环境
cd client\resource\bin\debug
MT3原始.exe

# 应该能正常启动游戏
```

**预期结果**: 游戏正常启动,无错误提示

---

## 🎯 步骤六: 首次完整编译

### 6.1 清理旧编译产物 (可选)

```batch
# 删除所有中间文件
rmdir /s /q common\lua\Release.win32
rmdir /s /q common\platform\Release.win32
rmdir /s /q engine\Release.win32
# ... 其他模块

# 或使用Git清理 (如果使用Git)
git clean -xdf
```

### 6.2 执行完整编译

```batch
# 方法1: 使用批处理脚本 (推荐)
build_mt3_v120_complete.bat

# 方法2: 使用PowerShell脚本
powershell -ExecutionPolicy Bypass -File Build-MT3-v120.ps1
```

### 6.3 监控编译进度

```plaintext
编译顺序和预计时间:
[1/8] lua.lib           (2分钟)   ████░░░░░░░░
[2/8] platform.lib      (3分钟)   ████████░░░░
[3/8] cauthc.lib        (2分钟)   ██████████░░
[4/8] ljfm.lib          (2分钟)   ████████████
[5/8] libCocosDenshion  (3分钟)   ██████████████
[6/8] libcocos2d        (8分钟)   ████████████████
[7/8] engine.lib        (5分钟)   ██████████████████
[8/8] MT3.exe           (3分钟)   ████████████████████

总计: 约28分钟 (首次编译)
```

### 6.4 处理编译错误

#### 错误1: 找不到v120工具集

**症状**:
```
error MSB8020: 无法找到 v120 的生成工具
```

**解决**:
- 确认已安装VS2013或VS2019+v120工具集
- 检查安装路径是否正确

#### 错误2: 缺少Windows SDK

**症状**:
```
error: Windows SDK 8.1 未安装
```

**解决**:
```batch
# 重新运行VS安装程序,勾选Windows 8.1 SDK
```

#### 错误3: 预编译头错误

**症状**:
```
fatal error C1010: 在查找预编译头时遇到意外的文件结尾
```

**解决**:
- 清理项目: `msbuild /t:Clean`
- 重新编译

---

## 🔄 步骤七: 部署运行时文件

### 7.1 复制DLL文件

```batch
# 运行DLL复制脚本
copy_runtime_dlls.bat

# 手动复制 (备选)
xcopy /Y cocos2d-2.0-rc2-x-2.0.1\Release.win32\*.dll client\resource\bin\release\
xcopy /Y client\resource\bin\debug\*.dll client\resource\bin\release\
```

### 7.2 验证文件完整性

```batch
cd client\resource\bin\release

# 检查可执行文件
dir MT3.exe

# 检查DLL (应该有9个)
dir *.dll

# 应该包含:
# libcocos2d.dll
# libCocosDenshion.dll
# glew32.dll
# pthreadVCE2.dll
# libcurl.dll
# iconv.dll
# libxml2.dll
# zlib1.dll
# fmodex.dll
```

---

## 🚀 步骤八: 最终验证

### 8.1 运行编译版本

```batch
cd client\resource\bin\release
MT3.exe
```

**预期结果**: 游戏正常启动

### 8.2 验证功能

```plaintext
测试清单:
☐ 游戏窗口正常显示
☐ 登录界面显示正确
☐ 音乐/音效播放正常
☐ UI交互响应正常
☐ 无错误弹窗
☐ 无闪退现象
```

### 8.3 性能验证

```plaintext
检查项:
- FPS: 应该稳定在55-60
- 内存占用: 空闲场景 ~300MB
- CPU占用: 空闲时 <10%
```

---

## 📊 环境配置检查清单

### ✅ 完整检查清单

```plaintext
软件安装:
☐ Visual Studio 2013 或 VS2019+v120工具集
☐ Windows SDK 8.1
☐ MSBuild工具
☐ Git (可选)

环境配置:
☐ MSBuild添加到PATH
☐ 可以在命令行运行msbuild
☐ 可以在命令行运行cl编译器

源码准备:
☐ 源码已解压/克隆到本地
☐ 目录结构完整
☐ 预编译库存在 (FireClient.lib等)
☐ 第三方DLL齐全 (9个)

编译验证:
☐ 单模块编译成功 (lua.lib)
☐ 完整编译成功 (MT3.exe)
☐ DLL复制完成
☐ 原始版本可以运行
☐ 编译版本可以运行

文档阅读:
☐ 已阅读 README.md
☐ 已阅读 docs/03-技术体系总结.md
☐ 已阅读 docs/06-编译完整指南.md
☐ 已阅读 .claude/项目规则.md
```

---

## 🆘 常见问题排查

### 问题1: MSBuild找不到

**症状**: `'msbuild' 不是内部或外部命令`

**解决方案**:
```batch
# 添加MSBuild到PATH
set PATH=%PATH%;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin

# 或使用完整路径
"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin\MSBuild.exe" project.vcxproj
```

### 问题2: 编译极慢

**症状**: 编译单个模块超过10分钟

**可能原因**:
1. 未使用预编译头
2. 硬盘性能差 (机械硬盘)
3. 杀毒软件实时扫描

**解决方案**:
```batch
# 1. 确认PCH配置正确
# 查看项目文件中 <PrecompiledHeader> 设置

# 2. 暂时禁用杀毒软件实时扫描

# 3. 使用SSD存储源码

# 4. 增加MSBuild并行数
msbuild /m:4 project.vcxproj
```

### 问题3: 链接错误

**症状**: `LNK2001: 无法解析的外部符号`

**解决方案**:
```batch
# 1. 检查链接顺序
# 查看项目文件中 <AdditionalDependencies>

# 2. 重新编译依赖库
msbuild common\platform\platform.editor.vcxproj /t:Rebuild

# 3. 清理后重新编译
msbuild /t:Clean
msbuild /t:Build
```

### 问题4: 运行时缺少DLL

**症状**: 启动时提示 `无法启动此程序,因为计算机中丢失 xxx.dll`

**解决方案**:
```batch
# 运行DLL复制脚本
copy_runtime_dlls.bat

# 或手动从debug目录复制
xcopy /Y client\resource\bin\debug\*.dll client\resource\bin\release\
```

---

## 📚 下一步学习

### 环境搭建完成后

1. **阅读核心文档**:
   - [docs/03-技术体系总结.md](./03-技术体系总结.md:1)
   - [docs/02-项目概述.md](./02-项目概述.md:1)

2. **理解项目规则**:
   - [.claude/项目规则.md](../.claude/项目规则.md)

3. **尝试修改代码**:
   - 修改Lua脚本 (无需重编译)
   - 修改C++代码 (增量编译)

4. **学习调试技巧**:
   - VS调试器使用
   - 日志分析

---

## 📞 获取帮助

### 问题反馈

1. 查看 [docs/06-编译完整指南.md](./06-编译完整指南.md:1) - 常见编译问题
2. 查看 [docs/03-技术体系总结.md](./03-技术体系总结.md:1) - 第七章"常见问题"
3. 查看项目文档目录：docs/

---

## 🎉 总结

完成以上步骤后,您应该具备:

✅ 完整的Visual Studio开发环境
✅ 正确配置的编译工具链
✅ 可以成功编译的MT3项目
✅ 可以正常运行的游戏程序
✅ 对项目结构的基本了解

**恭喜!** 您已经准备好开始MT3项目的开发工作了! 🚀

---

**文档版本**: 1.0
**最后更新**: 2025-10-13
**下次审查**: 2025-11-13
