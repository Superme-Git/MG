# MT3 特殊技术专题（12-专题合并版）
文档版本: 1.0  
最后更新: 2025-10-14  
维护状态: 已合并（CEGUI / CRT / libEGL），作为权威专题入口

说明：本专题整合并规范化以下深度技术文档，形成统一的可执行与可参考指南：
- CEGUI 集成与优化（来源： [filename](./CEGUI技术集成指南.md:1)）
- CRT 库冲突与运行时统一（来源： [filename](./CRT库冲突深度分析.md:1)、[filename](./Debug编译错误分析与解决方案.md:1)）
- libEGL / ANGLE 链接差异与 Win32 主线清理（来源： [filename](./libEGL链接错误修复说明.md:1)）

与主线文档的关系：
- 编译完整指南（权威）： [filename](./06-编译完整指南.md:1)
- 技术栈指引（权威入口）： [filename](./MT3_技术栈指引.md:1)
- 文档索引（新结构入口）： [filename](./13-文档索引.md:1)

---

## 1. CEGUI 集成与优化（Win32 / Cocos2d-x）

目标：在 Cocos2d-x 2.0（Win32）环境下正确集成 CEGUI，确保渲染、资源、事件与性能行为符合生产要求。

关键要点（统一规范）：
- 渲染模块：
  - 使用 Cocos2d-x 渲染器适配（RendererModules/Cocos2D），目录与包含参考：  
    - 头文件目录： [filename](dependencies/cegui/CEGUI/include/RendererModules/Cocos2D:1)  
    - 工程包含（可执行工程）： [XML.ClCompile.AdditionalIncludeDirectories](client/MT3Win32App/mt3.win32.vcxproj:93)
- 资源体系：
  - Binary Layout 系统、皮肤与字体资源需在启动时加载并做路径归一化，避免相对路径跨模块漂移。
- 事件桥接：
  - C++ 与 Lua 事件桥接采用注册式（LuaScriptModule），统一注册生命周期与销毁策略。
- 性能优化：
  - 批量渲染（Batching）、脏标记（Dirty flag）、裁剪策略（Clipping）与缓存纹理管理，避免过度提交与频繁纹理切换。
- 编译与链接：
  - 依赖库 SILLY、PCRE 与 CEGUI 的 .lib/.dll 路径应在 [XML.Link.AdditionalLibraryDirectories](client/MT3Win32App/mt3.win32.vcxproj:73) 中列出；
  - 运行时 DLL 由 PostBuild 或运行脚本统一复制（参考 06-指南与 00-计划）。

参考深度文档： [filename](./CEGUI技术集成指南.md:1)

---

## 2. CRT 库冲突与运行时统一（/MD vs /MDd）

目标：消除 LNK4098/运行时默认库冲突，统一工程运行时配置，避免 Debug/Release 混用导致的大量未解析符号。

统一基线（必须遵守）：
- 运行时库：
  - Release：/MD（MultiThreadedDLL） → [XML.ClCompile.RuntimeLibrary](client/MT3Win32App/mt3.win32.vcxproj:95)
  - Debug：/MDd（MultiThreadedDebugDLL） → [XML.ClCompile.RuntimeLibrary](client/MT3Win32App/mt3.win32.vcxproj:63)
- 默认库冲突（LNK4098）：
  - 根因：MSVCRT.lib 与 libcmt/libcmtd 混用或 /NODEFAULTLIB 配置不一致。
  - 解法：统一 RuntimeLibrary 并清理无关默认库设置；必要时在链接器中显式排除重复库。
- 未解析符号（LNK2001/LNK2019）：
  - 根因：Debug 程序链接 Release 库或反之（例如 __imp__isalnum 等符号指向不同 CRT）。
  - 解法：统一 Debug 依赖库（全部 /MDd），统一 Release 依赖库（全部 /MD）。

快速决策：
- 若 Debug 构建出现大量 __imp__* 或 UCRT 相关符号未解析 → 按 [filename](./Debug编译错误分析与解决方案.md:169) 的“方案 1”重编所有依赖为 Debug（/MDd）。
- 若 Release 构建出现 LNK4098 → 核对所有工程 RuntimeLibrary 值，确保无 /MT 或 /MDd 混入。

辅助参考：
- 深度分析： [filename](./CRT库冲突深度分析.md:1)
- Debug 大量错误案例与复原方法： [filename](./Debug编译错误分析与解决方案.md:1)

---

## 3. libEGL / ANGLE 链接差异（Win32 vs WinRT）

结论（Win32 主线）：
- Win32 桌面主线不使用 ANGLE（libEGL/libGLESv2），应使用原生 OpenGL + GLEW（opengl32.lib, glew32.lib）。

症状：
- LNK1104：无法打开 "libEGL.lib"
- 根因：Win32 工程混入 WinRT/WP8 的 ANGLE 依赖，但解决方案未包含 ANGLE 项目。

修复要点：
- 移除 Win32 项目的 libEGL/libGLESv2 依赖（Debug 与 Release 两套配置）
- 保留 opengl32.lib、glew32.lib 等原生 OpenGL 依赖
- 参考操作示例： [filename](./libEGL链接错误修复说明.md:67)

工程定位：
- 链接依赖项（可执行工程）： [XML.Link.AdditionalDependencies](client/MT3Win32App/mt3.win32.vcxproj:71)、[XML.Link.AdditionalDependencies](client/MT3Win32App/mt3.win32.vcxproj:106)
- 库目录（ANGLE/WinRT 混入路径需清理）： [XML.Link.AdditionalLibraryDirectories](client/MT3Win32App/mt3.win32.vcxproj:73)、[XML.Link.AdditionalLibraryDirectories](client/MT3Win32App/mt3.win32.vcxproj:108)

专题来源： [filename](./libEGL链接错误修复说明.md:1)

---

## 4. 统一规范与工程实践（落地规则）

- 工具链与字符集：
  - v120（VS2013）、Unicode（Debug/Release 一致）
- 编译顺序（组件 → 引擎 → 应用）：
  - 参考权威流程： [filename](./06-编译完整指南.md:117)
- 并行编译策略：
  - 若出现 PDB 并发写冲突（C1041），在解决方案构建中禁用并行：  
    - /p:MultiProcessorCompilation=false /m:1  
    - 记录位置： [filename](./MT3_Release_Build_Diagnostics.md:70)
- 链接器库目录：
  - 确保包含上游库输出路径（$(SolutionDir)$(Configuration).win32 与第三方路径）：  
    - [XML.Link.AdditionalLibraryDirectories](client/MT3Win32App/mt3.win32.vcxproj:73)、[XML.Link.AdditionalLibraryDirectories](client/MT3Win32App/mt3.win32.vcxproj:108)
- PostBuild 拷贝：
  - 统一由工程脚本复制 MT3.exe 与 DLL 至发布目录：  
    - [C++.PostBuildEvent.Command](client/MT3Win32App/mt3.win32.vcxproj:81)

---

## 5. 检查与验证清单（专题层）

CEGUI 专题检查：
- 头文件与渲染模块包含路径正确（RendererModules/Cocos2D）
- 事件桥接模块加载与卸载顺序正确
- 批量渲染与脏标记策略生效（运行时统计对比）

CRT 专题检查：
- 所有工程 RuntimeLibrary 一致（Debug:/MDd，Release:/MD）
- 链接器无 /NODEFAULTLIB 误配与重复默认库
- Debug 构建不使用 Release 库，反之亦然

libEGL 专题检查：
- Win32 工程不包含 libEGL/libGLESv2（Debug/Release）
- 链接器库目录无 WinRT ANGLE 路径混入
- 保留 opengl32/glew32 依赖，确保渲染链路正常

---

## 6. 关联证据与日志定位（可审计）

- encode.cpp 缺失导致上游库未产出（C1083 → LNK1104）：
  - 工程包含： [XML.ClCompile Include](client/MT3Win32App/FireClient.win32.vcxproj:213)、[XML.ClCompile Include](client/MT3Win32App/FireClient.win32.vcxproj.filters:250)
  - 链接命令 /LIBPATH 指向 FireClient 输出： [text](client/MT3Win32App/Release.win32/MT3.tlog/link.command.1.tlog:2)
  - FireClient.lib 产出日志： [text](client/MT3Win32App/Release.win32/FireClient.win32.log:667)
- CocosDenshion 扩展接口符号（setEffectVolume/hasEffect/isEffectPlaying）：
  - 接口来源与构建工程： [filename](cocos2d-2.0-rc2-x-2.0.1/CocosDenshion/proj.win32/CocosDenshion.win32.vcxproj:1)
- 并发编译与 PDB 冲突：
  - 禁用并行参考： [filename](./MT3_Release_Build_Diagnostics.md:70)

---

## 7. 执行入口与后续维护

- 入门与完整流程：  
  - 编译完整指南： [filename](./06-编译完整指南.md:1)  
  - 编译步骤计划： [filename](./00-编译步骤工作计划.md:1)
- 统一索引入口（新结构）：  
  - 13-文档索引： [filename](./13-文档索引.md:1)
- 文档更新规则：  
  - 每次工程或文档改动需同步更新索引与交叉引用；遵循 [filename](./文档整合与重命名方案.md:1) 的“序号+中文名称”体系。

---

## 8. 变更记录
- 2025-10-14 v1.0：首次合并发布（CEGUI / CRT / libEGL），统一专题入口与规则。