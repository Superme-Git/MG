# MT3 é¡¹ç›®ç‰¹æ®ŠæŠ€æœ¯ä¸“é¢˜

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0
**æœ€åæ›´æ–°**: 2025-10-12
**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [CEGUI UI ç³»ç»Ÿé›†æˆ](#12.1-cegui-ui-ç³»ç»Ÿé›†æˆ)
2. [CRT åº“å†²çªæ·±åº¦è§£æ](#12.2-crt-åº“å†²çªæ·±åº¦è§£æ)
3. [libEGL/ANGLE é“¾æ¥é—®é¢˜](#12.3-libeglangle-é“¾æ¥é—®é¢˜)
4. [æŠ€æœ¯ä¸“é¢˜äº¤å‰å¼•ç”¨](#æŠ€æœ¯ä¸“é¢˜äº¤å‰å¼•ç”¨)
5. [å¸¸è§é—®é¢˜è§£ç­”](#å¸¸è§é—®é¢˜è§£ç­”)

---

## 12.1 CEGUI UI ç³»ç»Ÿé›†æˆ

### æ¦‚è¿°

**CEGUI** (Crazy Eddie's GUI System) æ˜¯ä¸€ä¸ªå…è´¹çš„ã€è·¨å¹³å°çš„ C++ GUI åº“ï¼Œä¸“ä¸ºæ¸¸æˆå’Œå¤šåª’ä½“åº”ç”¨è®¾è®¡ã€‚MT3 é¡¹ç›®ä½¿ç”¨ CEGUI ä½œä¸ºä¸»è¦ UI ç³»ç»Ÿã€‚

### é¡¹ç›®ä¸­çš„ CEGUI é…ç½®

| ç‰¹æ€§ | é…ç½® |
|------|------|
| **ç‰ˆæœ¬** | CEGUI 0.7.x |
| **ä½ç½®** | `dependencies/cegui/` |
| **æ¸²æŸ“åç«¯** | OpenGL/Cocos2d-x |
| **èµ„æºæ ¼å¼** | Binary Layout |
| **å­—ä½“ç³»ç»Ÿ** | FreeType 2.4.9 |

### é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ¸¸æˆ UI å±‚ (Lua Scripts)             â”‚
â”‚    æŒ‰é’®ã€å¯¹è¯æ¡†ã€èœå•ã€HUDç­‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CEGUI System                         â”‚
â”‚  â”œâ”€ WindowManager                            â”‚
â”‚  â”œâ”€ FontManager                              â”‚
â”‚  â”œâ”€ ImagesetManager                          â”‚
â”‚  â”œâ”€ SchemeManager                            â”‚
â”‚  â””â”€ EventSystem                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CEGUI Renderer (è‡ªå®šä¹‰å®ç°)               â”‚
â”‚    åŸºäº Cocos2d-x / OpenGL ES 2.0           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Cocos2d-x Rendering Layer            â”‚
â”‚     CCDirector, CCScene, CCSprite           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è‡ªå®šä¹‰ CEGUI æ¸²æŸ“å™¨

CEGUI éœ€è¦å®ç°ä¸€ä¸ªæ¸²æŸ“å™¨æ¥å£æ¥ä¸åº•å±‚å›¾å½¢ API å¯¹æ¥ï¼š

```cpp
// è‡ªå®šä¹‰ CEGUI æ¸²æŸ“å™¨ (æ¨æµ‹å®ç°)
class CocosCEGUIRenderer : public CEGUI::Renderer
{
public:
    CocosCEGUIRenderer();
    virtual ~CocosCEGUIRenderer();

    // æ¸²æŸ“æ¥å£
    virtual void addQuad(const CEGUI::Rect& dest_rect,
                        float z,
                        const CEGUI::Texture* tex,
                        const CEGUI::Rect& texture_rect,
                        const CEGUI::ColourRect& colours,
                        CEGUI::QuadSplitMode quad_split_mode);

    virtual void doRender();
    virtual void clearRenderList();

    // çº¹ç†ç®¡ç†
    virtual CEGUI::Texture* createTexture();
    virtual CEGUI::Texture* createTexture(const CEGUI::String& filename,
                                         const CEGUI::String& resourceGroup);
    virtual CEGUI::Texture* createTexture(float size);
    virtual void destroyTexture(CEGUI::Texture* texture);
    virtual void destroyAllTextures();

    // è§†å£å’Œæ˜¾ç¤ºè®¾ç½®
    virtual void setDisplaySize(const CEGUI::Size& size);
    virtual const CEGUI::Size& getDisplaySize() const;
    virtual const CEGUI::Vector2& getDisplayDPI() const;

    // æœ€å¤§çº¹ç†å¤§å°
    virtual uint getMaxTextureSize() const;

private:
    struct QuadInfo
    {
        cocos2d::CCPoint position;
        cocos2d::CCSize size;
        cocos2d::ccColor4F color;
        cocos2d::CCRect texCoords;
        cocos2d::CCTexture2D* texture;
    };

    std::vector<QuadInfo> m_quadList;  // å››è¾¹å½¢æ¸²æŸ“é˜Ÿåˆ—
    CEGUI::Size m_displaySize;         // æ˜¾ç¤ºå°ºå¯¸
    cocos2d::CCSpriteBatchNode* m_batchNode;  // æ‰¹é‡æ¸²æŸ“èŠ‚ç‚¹
};
```

### æ‰¹é‡æ¸²æŸ“ä¼˜åŒ–

```cpp
void CocosCEGUIRenderer::doRender()
{
    // æŒ‰çº¹ç†åˆ†ç»„
    std::map<CCTexture2D*, std::vector<QuadInfo>> batches;

    for (const QuadInfo& quad : m_quadList) {
        batches[quad.texture].push_back(quad);
    }

    // æ‰¹é‡æ¸²æŸ“æ¯ä¸ªçº¹ç†ç»„
    for (auto& pair : batches) {
        CCTexture2D* texture = pair.first;
        std::vector<QuadInfo>& quads = pair.second;

        // è®¾ç½®çº¹ç†
        texture->retain();
        glBindTexture(GL_TEXTURE_2D, texture->getName());

        // æ„å»ºé¡¶ç‚¹ç¼“å†²åŒº
        ccV3F_C4B_T2F_Quad* vertices = new ccV3F_C4B_T2F_Quad[quads.size()];

        for (size_t i = 0; i < quads.size(); ++i) {
            BuildQuadVertices(quads[i], vertices[i]);
        }

        // æäº¤åˆ° GPU
        glVertexAttribPointer(kCCVertexAttrib_Position, 3, GL_FLOAT, GL_FALSE,
                             sizeof(ccV3F_C4B_T2F), &vertices[0].tl.vertices);
        glVertexAttribPointer(kCCVertexAttrib_Color, 4, GL_UNSIGNED_BYTE, GL_TRUE,
                             sizeof(ccV3F_C4B_T2F), &vertices[0].tl.colors);
        glVertexAttribPointer(kCCVertexAttrib_TexCoords, 2, GL_FLOAT, GL_FALSE,
                             sizeof(ccV3F_C4B_T2F), &vertices[0].tl.texCoords);

        glDrawArrays(GL_TRIANGLES, 0, quads.size() * 6);

        delete[] vertices;
        texture->release();
    }

    m_quadList.clear();
}
```

### åæ ‡ç³»è½¬æ¢

```cpp
// CEGUI ä½¿ç”¨å·¦ä¸Šè§’ä¸ºåŸç‚¹ï¼Œéœ€è¦è½¬æ¢åˆ° Cocos2d-x çš„å·¦ä¸‹è§’åæ ‡ç³»
cocos2d::CCPoint ConvertCEGUIToCocos2d(const CEGUI::Vector2& ceguiPos)
{
    // è·å–å±å¹•é«˜åº¦
    float screenHeight = cocos2d::CCDirector::sharedDirector()->getWinSize().height;
    
    return cocos2d::CCPoint(
        ceguiPos.d_x,
        screenHeight - ceguiPos.d_y  // ç¿»è½¬ Y åæ ‡
    );
}
```

### èµ„æºç®¡ç†

CEGUI ä½¿ç”¨äºŒè¿›åˆ¶å¸ƒå±€ç³»ç»Ÿè¿›è¡Œèµ„æºç®¡ç†ï¼š

```cpp
// äºŒè¿›åˆ¶å¸ƒå±€åºåˆ—åŒ–å™¨ (æ¨æµ‹å®ç°)
class CEGUIBinLayoutFileSerializer
{
public:
    void Serialize(const CEGUI::Window* window, const std::string& filename)
    {
        CEGUIFileStream stream(filename, CEGUIFileStream::Write);
        SerializeWindow(window, stream);
        stream.close();
    }

    CEGUI::Window* Deserialize(const std::string& filename)
    {
        CEGUIFileStream stream(filename, CEGUIFileStream::Read);
        CEGUI::Window* window = DeserializeWindow(stream);
        stream.close();
        return window;
    }

private:
    void SerializeWindow(const CEGUI::Window* window, CEGUIFileStream& stream);
    CEGUI::Window* DeserializeWindow(CEGUIFileStream& stream);
};
```

### CEGUI åˆå§‹åŒ–

```cpp
// CEGUI åˆå§‹åŒ–å’Œèµ„æºåŠ è½½
void InitializeCEGUI()
{
    // 1. åˆ›å»ºæ¸²æŸ“å™¨
    CEGUI::CocosCEGUIRenderer& renderer =
        CEGUI::CocosCEGUIRenderer::create();
    
    // 2. åˆ›å»º CEGUI ç³»ç»Ÿ
    CEGUI::System::create(renderer);
    
    // 3. è®¾ç½®èµ„æºç›®å½•
    CEGUI::DefaultResourceProvider* rp =
        static_cast<CEGUI::DefaultResourceProvider*>(
            CEGUI::System::getSingleton().getResourceProvider());
    
    rp->setResourceGroupDirectory("schemes", "cegui/schemes/");
    rp->setResourceGroupDirectory("imagesets", "cegui/imagesets/");
    rp->setResourceGroupDirectory("fonts", "cegui/fonts/");
    rp->setResourceGroupDirectory("layouts", "cegui/layouts/");
    rp->setResourceGroupDirectory("looknfeels", "cegui/looknfeel/");
    
    // 4. åŠ è½½èµ„æº
    CEGUI::SchemeManager::getSingleton().create("MT3Scheme.scheme");
    CEGUI::FontManager::getSingleton().create("SimHei-14.font");
    CEGUI::System::getSingleton().setDefaultFont("SimHei-14");
    CEGUI::System::getSingleton().setDefaultMouseCursor("MT3Scheme", "MouseArrow");
    
    // 5. è®¾ç½®æ ¹çª—å£
    CEGUI::Window* rootWindow = CEGUI::WindowManager::getSingleton()
        .createWindow("DefaultWindow", "Root");
    CEGUI::System::getSingleton().setGUISheet(rootWindow);
}
```

### UI å…ƒç´ åˆ›å»ºç¤ºä¾‹

```cpp
// åˆ›å»ºç™»å½•å¯¹è¯æ¡†
CEGUI::Window* CreateLoginDialog()
{
    CEGUI::WindowManager& wmgr = CEGUI::WindowManager::getSingleton();
    
    // åˆ›å»ºä¸»çª—å£
    CEGUI::FrameWindow* dialog = static_cast<CEGUI::FrameWindow*>(
        wmgr.createWindow("MT3Scheme/FrameWindow", "LoginDialog"));
    
    dialog->setPosition(CEGUI::UVector2(CEGUI::UDim(0.25f, 0), CEGUI::UDim(0.25f, 0)));
    dialog->setSize(CEGUI::UVector2(CEGUI::UDim(0.5f, 0), CEGUI::UDim(0.5f, 0)));
    dialog->setText("ç™»å½•");
    
    // ç”¨æˆ·åæ ‡ç­¾
    CEGUI::Window* usernameLabel = wmgr.createWindow("MT3Scheme/Label", "UsernameLabel");
    usernameLabel->setPosition(CEGUI::UVector2(CEGUI::UDim(0.1f, 0), CEGUI::UDim(0.2f, 0)));
    usernameLabel->setSize(CEGUI::UVector2(CEGUI::UDim(0.3f, 0), CEGUI::UDim(0.1f, 0)));
    usernameLabel->setText("ç”¨æˆ·å:");
    dialog->addChildWindow(usernameLabel);
    
    // ç”¨æˆ·åè¾“å…¥æ¡†
    CEGUI::Editbox* usernameEdit = static_cast<CEGUI::Editbox*>(
        wmgr.createWindow("MT3Scheme/Editbox", "UsernameEdit"));
    usernameEdit->setPosition(CEGUI::UVector2(CEGUI::UDim(0.4f, 0), CEGUI::UDim(0.2f, 0)));
    usernameEdit->setSize(CEGUI::UVector2(CEGUI::UDim(0.5f, 0), CEGUI::UDim(0.1f, 0)));
    dialog->addChildWindow(usernameEdit);
    
    // å¯†ç æ ‡ç­¾
    CEGUI::Window* passwordLabel = wmgr.createWindow("MT3Scheme/Label", "PasswordLabel");
    passwordLabel->setPosition(CEGUI::UVector2(CEGUI::UDim(0.1f, 0), CEGUI::UDim(0.35f, 0)));
    passwordLabel->setSize(CEGUI::UVector2(CEGUI::UDim(0.3f, 0), CEGUI::UDim(0.1f, 0)));
    passwordLabel->setText("å¯†ç :");
    dialog->addChildWindow(passwordLabel);
    
    // å¯†ç è¾“å…¥æ¡†
    CEGUI::Editbox* passwordEdit = static_cast<CEGUI::Editbox*>(
        wmgr.createWindow("MT3Scheme/Editbox", "PasswordEdit"));
    passwordEdit->setPosition(CEGUI::UVector2(CEGUI::UDim(0.4f, 0), CEGUI::UDim(0.35f, 0)));
    passwordEdit->setSize(CEGUI::UVector2(CEGUI::UDim(0.5f, 0), CEGUI::UDim(0.1f, 0)));
    passwordEdit->setProperty("MaskText", "true");  // å¯†ç é®ç½©
    dialog->addChildWindow(passwordEdit);
    
    // ç™»å½•æŒ‰é’®
    CEGUI::PushButton* loginButton = static_cast<CEGUI::PushButton*>(
        wmgr.createWindow("MT3Scheme/Button", "LoginButton"));
    loginButton->setPosition(CEGUI::UVector2(CEGUI::UDim(0.3f, 0), CEGUI::UDim(0.6f, 0)));
    loginButton->setSize(CEGUI::UVector2(CEGUI::UDim(0.2f, 0), CEGUI::UDim(0.1f, 0)));
    loginButton->setText("ç™»å½•");
    dialog->addChildWindow(loginButton);
    
    // å–æ¶ˆæŒ‰é’®
    CEGUI::PushButton* cancelButton = static_cast<CEGUI::PushButton*>(
        wmgr.createWindow("MT3Scheme/Button", "CancelButton"));
    cancelButton->setPosition(CEGUI::UVector2(CEGUI::UDim(0.55f, 0), CEGUI::UDim(0.6f, 0)));
    cancelButton->setSize(CEGUI::UVector2(CEGUI::UDim(0.2f, 0), CEGUI::UDim(0.1f, 0)));
    cancelButton->setText("å–æ¶ˆ");
    dialog->addChildWindow(cancelButton);
    
    return dialog;
}
```

### å¸ƒå±€åŠ è½½

```cpp
// ä»æ–‡ä»¶åŠ è½½å¸ƒå±€
CEGUI::Window* LoadLayout(const std::string& layoutName)
{
    std::string fullPath = "cegui/layouts/" + layoutName + ".layout";
    
    CEGUIBinLayoutFileSerializer serializer;
    CEGUI::Window* window = serializer.Deserialize(fullPath);
    
    return window;
}

// Lua è„šæœ¬ä¸­ä½¿ç”¨
local mainMenuWindow = CEGUI.LoadLayout("MainMenu")
CEGUI.System:getSingleton():getGUISheet():addChildWindow(mainMenuWindow)
```

### äº‹ä»¶å¤„ç†

```cpp
// ç™»å½•å¯¹è¯æ¡†äº‹ä»¶å¤„ç†å™¨
class LoginDialogHandler
{
public:
    LoginDialogHandler(CEGUI::Window* dialog)
        : m_dialog(dialog)
    {
        // è®¢é˜…æŒ‰é’®äº‹ä»¶
        CEGUI::PushButton* loginBtn = static_cast<CEGUI::PushButton*>(
            CEGUI::WindowManager::getSingleton().getWindow("LoginButton"));
        
        loginBtn->subscribeEvent(
            CEGUI::PushButton::EventClicked,
            CEGUI::Event::Subscriber(&LoginDialogHandler::OnLoginClicked, this));
        
        CEGUI::PushButton* cancelBtn = static_cast<CEGUI::PushButton*>(
            CEGUI::WindowManager::getSingleton().getWindow("CancelButton"));
        
        cancelBtn->subscribeEvent(
            CEGUI::PushButton::EventClicked,
            CEGUI::Event::Subscriber(&LoginDialogHandler::OnCancelClicked, this));
    }
    
    bool OnLoginClicked(const CEGUI::EventArgs& e)
    {
        // è·å–ç”¨æˆ·åå’Œå¯†ç 
        CEGUI::Editbox* usernameEdit = static_cast<CEGUI::Editbox*>(
            CEGUI::WindowManager::getSingleton().getWindow("UsernameEdit"));
        CEGUI::Editbox* passwordEdit = static_cast<CEGUI::Editbox*>(
            CEGUI::WindowManager::getSingleton().getWindow("PasswordEdit"));
        
        CEGUI::String username = usernameEdit->getText();
        CEGUI::String password = passwordEdit->getText();
        
        // æ‰§è¡Œç™»å½•é€»è¾‘
        // ...
        
        return true;
    }
    
    bool OnCancelClicked(const CEGUI::EventArgs& e)
    {
        // å…³é—­å¯¹è¯æ¡†
        CEGUI::Window* dialog = static_cast<const CEGUI::WindowEventArgs&>(e).window;
        dialog->hide();
        
        return true;
    }
    
private:
    CEGUI::Window* m_dialog;
};
```

### æ€§èƒ½ä¼˜åŒ–

#### æ‰¹é‡æ¸²æŸ“

```cpp
class CEGUIBatchRenderer
{
public:
    void AddQuad(const QuadInfo& quad)
    {
        m_quadList.push_back(quad);
    }
    
    void Render()
    {
        // æŒ‰çº¹ç†åˆ†ç»„
        std::map<CCTexture2D*, std::vector<QuadInfo>> batches;
        
        for (const QuadInfo& quad : m_quadList) {
            batches[quad.texture].push_back(quad);
        }
        
        // æ‰¹é‡æ¸²æŸ“æ¯ä¸ªçº¹ç†ç»„
        for (auto& pair : batches) {
            RenderBatch(pair.first, pair.second);
        }
        
        m_quadList.clear();
    }
    
private:
    void RenderBatch(CCTexture2D* texture, const std::vector<QuadInfo>& quads)
    {
        // å®ç°æ‰¹é‡æ¸²æŸ“é€»è¾‘
        // ...
    }
    
    std::vector<QuadInfo> m_quadList;
};
```

#### å¯¹è±¡æ± 

```cpp
class OptimizedCEGUIWindow : public CEGUI::Window
{
public:
    static OptimizedCEGUIWindow* create(const std::string& type)
    {
        return WindowPool::AcquireWindow(type);
    }
    
    virtual void destroy()
    {
        WindowPool::ReleaseWindow(this);
    }
    
private:
    class WindowPool
    {
    public:
        static CEGUI::Window* AcquireWindow(const std::string& type)
        {
            auto& pool = m_pools[type];
            
            if (!pool.empty()) {
                CEGUI::Window* window = pool.back();
                pool.pop_back();
                return window;
            }
            
            return CEGUI::WindowManager::getSingleton().createWindow(type);
        }
        
        static void ReleaseWindow(CEGUI::Window* window)
        {
            std::string type = window->getType();
            m_pools[type].push_back(window);
            
            // é‡ç½®çª—å£çŠ¶æ€
            window->setPosition(CEGUI::UVector2(CEGUI::UDim(0, 0), CEGUI::UDim(0, 0)));
            window->setSize(CEGUI::UVector2(CEGUI::UDim(0, 0), CEGUI::UDim(0, 0)));
            window->setText("");
            
            // ç§»é™¤æ‰€æœ‰å­çª—å£
            while (window->getChildCount() > 0) {
                CEGUI::Window* child = window->getChildAtIdx(0);
                window->removeChildWindow(child);
            }
        }
        
    private:
        static std::map<std::string, std::vector<CEGUI::Window*>> m_pools;
    };
};
```

### æ™ºèƒ½æŒ‡é’ˆç®¡ç†

```cpp
// ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç† CEGUI çª—å£ç”Ÿå‘½å‘¨æœŸ
class WindowPtr
{
public:
    WindowPtr(CEGUI::Window* window) : m_window(window) {}
    
    ~WindowPtr()
    {
        if (m_window) {
            CEGUI::WindowManager::getSingleton().destroyWindow(m_window);
        }
    }
    
    CEGUI::Window* get() const { return m_window; }
    CEGUI::Window* operator->() const { return m_window; }
    
    // ç¦æ­¢æ‹·è´
    WindowPtr(const WindowPtr&) = delete;
    WindowPtr& operator=(const WindowPtr&) = delete;
    
    // æ”¯æŒç§»åŠ¨
    WindowPtr(WindowPtr&& other) noexcept : m_window(other.m_window)
    {
        other.m_window = nullptr;
    }
    
    WindowPtr& operator=(WindowPtr&& other) noexcept
    {
        if (this != &other) {
            if (m_window) {
                CEGUI::WindowManager::getSingleton().destroyWindow(m_window);
            }
            m_window = other.m_window;
            other.m_window = nullptr;
        }
        return *this;
    }
    
private:
    CEGUI::Window* m_window;
};

// ä½¿ç”¨ç¤ºä¾‹
void CreateUI()
{
    WindowPtr loginDialog(CreateLoginDialog());
    // ä½¿ç”¨ loginDialog...
    // ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é”€æ¯
}
```

### äº‹ä»¶è¿æ¥ç®¡ç†

```cpp
class EventConnection
{
public:
    EventConnection(CEGUI::Window* window, const std::string& event,
                   CEGUI::Event::Subscriber subscriber)
        : m_window(window)
    {
        m_connection = new CEGUI::Event::Connection(
            window->subscribeEvent(event, subscriber));
    }
    
    ~EventConnection()
    {
        if (m_connection) {
            (*m_connection)->disconnect();
            delete m_connection;
        }
    }
    
private:
    CEGUI::Window* m_window;
    CEGUI::Event::Connection* m_connection;
};

// ä½¿ç”¨ç¤ºä¾‹
void SetupEventHandlers()
{
    WindowPtr loginDialog(CreateLoginDialog());
    
    EventConnection loginClick(
        loginDialog->getChild("LoginButton"),
        CEGUI::PushButton::EventClicked,
        CEGUI::Event::Subscriber(&OnLoginClicked));
    
    EventConnection cancelClick(
        loginDialog->getChild("CancelButton"),
        CEGUI::PushButton::EventClicked,
        CEGUI::Event::Subscriber(&OnCancelClicked));
    
    // äº‹ä»¶è¿æ¥ä¼šåœ¨ EventConnection å¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨æ–­å¼€
}
```

### CEGUI çš®è‚¤ç³»ç»Ÿ

```xml
<!-- MT3Scheme.looknfeel -->
<LookNFeel>
    <WidgetLook name="MT3Scheme/Button">
        <Property name="NormalImage" value="set:MT3Imageset image:ButtonNormal" />
        <Property name="HoverImage" value="set:MT3Imageset image:ButtonHover" />
        <Property name="PushedImage" value="set:MT3Imageset image:ButtonPressed" />
        <Property name="DisabledImage" value="set:MT3Imageset image:ButtonDisabled" />
        
        <ImagerySection name="label">
            <TextComponent>
                <Area>
                    <Dim type="LeftEdge"><AbsoluteDim value="0" /></Dim>
                    <Dim type="TopEdge"><AbsoluteDim value="0" /></Dim>
                    <Dim type="Width"><UnifiedDim scale="1" type="Width" /></Dim>
                    <Dim type="Height"><UnifiedDim scale="1" type="Height" /></Dim>
                </Area>
                <VertFormat type="CentreAligned" />
                <HorzFormat type="CentreAligned" />
            </TextComponent>
        </ImagerySection>
        
        <StateImagery name="Normal">
            <Layer>
                <Section section="label">
                    <Colours topLeft="FFBBBBBB" topRight="FFFFFFFF" 
                             bottomLeft="FFFFFFFF" bottomRight="FFBBBBBB" />
                </Section>
            </Layer>
        </StateImagery>
        
        <StateImagery name="Hover">
            <Layer>
                <Section section="label">
                    <Colours topLeft="FFDDDDDD" topRight="FFFFFFFF" 
                             bottomLeft="FFFFFFFF" bottomRight="FFDDDDDD" />
                </Section>
            </Layer>
        </StateImagery>
        
        <StateImagery name="Pushed">
            <Layer>
                <Section section="label">
                    <Colours topLeft="FF999999" topRight="FFBBBBBB" 
                             bottomLeft="FFBBBBBB" bottomRight="FF999999" />
                </Section>
            </Layer>
        </StateImagery>
    </WidgetLook>
    
    <WidgetLook name="MT3Scheme/Editbox">
        <Property name="NormalTextColour" value="FF000000" />
        <Property name="SelectedTextColour" value="FFFFFFFF" />
        <Property name="ActiveSelectionColour" value="FF6060FF" />
        <Property name="InactiveSelectionColour" value="FF808080" />
        
        <ImagerySection name="container">
            <FrameComponent>
                <Area>
                    <Dim type="LeftEdge"><AbsoluteDim value="0" /></Dim>
                    <Dim type="TopEdge"><AbsoluteDim value="0" /></Dim>
                    <Dim type="Width"><UnifiedDim scale="1" type="Width" /></Dim>
                    <Dim type="Height"><UnifiedDim scale="1" type="Height" /></Dim>
                </Area>
                <Image type="TopLeftCorner" imageset="MT3Imageset" image="EditboxTopLeft" />
                <Image type="TopRightCorner" imageset="MT3Imageset" image="EditboxTopRight" />
                <Image type="BottomLeftCorner" imageset="MT3Imageset" image="EditboxBottomLeft" />
                <Image type="BottomRightCorner" imageset="MT3Imageset" image="EditboxBottomRight" />
                <Image type="LeftEdge" imageset="MT3Imageset" image="EditboxLeft" />
                <Image type="RightEdge" imageset="MT3Imageset" image="EditboxRight" />
                <Image type="TopEdge" imageset="MT3Imageset" image="EditboxTop" />
                <Image type="BottomEdge" imageset="MT3Imageset" image="EditboxBottom" />
                <Colours topLeft="FFDDDDDD" topRight="FFFFFFFF" 
                         bottomLeft="FFFFFFFF" bottomRight="FFDDDDDD" />
            </FrameComponent>
        </ImagerySection>
        
        <StateImagery name="Enabled">
            <Layer>
                <Section section="container" />
            </Layer>
        </StateImagery>
        
        <StateImagery name="ReadOnly">
            <Layer>
                <Section section="container">
                    <Colours topLeft="FFEEEEEE" topRight="FFEEEEEE" 
                             bottomLeft="FFEEEEEE" bottomRight="FFEEEEEE" />
                </Section>
            </Layer>
        </StateImagery>
        
        <StateImagery name="Disabled">
            <Layer>
                <Section section="container">
                    <Colours topLeft="FFCCCCCC" topRight="FFCCCCCC" 
                             bottomLeft="FFCCCCCC" bottomRight="FFCCCCCC" />
                </Section>
            </Layer>
        </StateImagery>
    </WidgetLook>
    
    <WidgetLook name="MT3Scheme/FrameWindow">
        <Property name="TitlebarFont" value="SimHei-14" />
        <Property name="TitlebarTextColour" value="FFFFFFFF" />
        
        <Child nameSuffix="__auto_titlebar__" type="MT3Scheme/Titlebar">
            <Area>
                <Dim type="LeftEdge"><AbsoluteDim value="0" /></Dim>
                <Dim type="TopEdge"><AbsoluteDim value="0" /></Dim>
                <Dim type="Width"><UnifiedDim scale="1" type="Width" /></Dim>
                <Dim type="Height"><FontDim type="LineSpacing" padding="8" /></Dim>
            </Area>
        </Child>
        
        <Child nameSuffix="__auto_closebutton__" type="MT3Scheme/Button">
            <Area>
                <Dim type="LeftEdge"><AbsoluteDim value="-20" /></Dim>
                <Dim type="TopEdge"><AbsoluteDim value="2" /></Dim>
                <Dim type="Width"><AbsoluteDim value="16" /></Dim>
                <Dim type="Height"><AbsoluteDim value="16" /></Dim>
            </Area>
            <Property name="NormalImage" value="set:MT3Imageset image:CloseButtonNormal" />
            <Property name="HoverImage" value="set:MT3Imageset image:CloseButtonHover" />
            <Property name="PushedImage" value="set:MT3Imageset image:CloseButtonPressed" />
        </Child>
        
        <ImagerySection name="client_with_frame">
            <FrameComponent>
                <Area>
                    <Dim type="LeftEdge"><AbsoluteDim value="0" /></Dim>
                    <Dim type="TopEdge"><AbsoluteDim value="0" /></Dim>
                    <Dim type="Width"><UnifiedDim scale="1" type="Width" /></Dim>
                    <Dim type="Height"><UnifiedDim scale="1" type="Height" /></Dim>
                </Area>
                <Image type="TopLeftCorner" imageset="MT3Imageset" image="WindowTopLeft" />
                <Image type="TopRightCorner" imageset="MT3Imageset" image="WindowTopRight" />
                <Image type="BottomLeftCorner" imageset="MT3Imageset" image="WindowBottomLeft" />
                <Image type="BottomRightCorner" imageset="MT3Imageset" image="WindowBottomRight" />
                <Image type="LeftEdge" imageset="MT3Imageset" image="WindowLeft" />
                <Image type="RightEdge" imageset="MT3Imageset" image="WindowRight" />
                <Image type="TopEdge" imageset="MT3Imageset" image="WindowTop" />
                <Image type="BottomEdge" imageset="MT3Imageset" image="WindowBottom" />
                <Colours topLeft="FFDDDDDD" topRight="FFFFFFFF" 
                         bottomLeft="FFFFFFFF" bottomRight="FFDDDDDD" />
            </FrameComponent>
        </ImagerySection>
        
        <StateImagery name="Enabled">
            <Layer>
                <Section section="client_with_frame" />
            </Layer>
        </StateImagery>
    </WidgetLook>
</LookNFeel>
```

### CEGUI èµ„æºé…ç½®

```xml
<!-- MT3Scheme.scheme -->
<GUILayout>
    <WindowSet Filename="CEGUIFalagardWLBase" />
    
    <FalagardMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/PushButton" Name="MT3Scheme/Button" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/Editbox" Name="MT3Scheme/Editbox" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/FrameWindow" Name="MT3Scheme/FrameWindow" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/Titlebar" Name="MT3Scheme/Titlebar" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/Listbox" Name="MT3Scheme/Listbox" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/Combobox" Name="MT3Scheme/Combobox" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/Checkbox" Name="MT3Scheme/Checkbox" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/RadioButton" Name="MT3Scheme/RadioButton" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/Scrollbar" Name="MT3Scheme/Scrollbar" />
        </WindowMapping>
        <WindowMapping>
            <WindowType TargetType="CEGUI/ProgressBar" Name="MT3Scheme/ProgressBar" />
        </WindowMapping>
    </FalagardMapping>
</GUILayout>
```

### CEGUI æœ€ä½³å®è·µ

1. **æ‰¹é‡æ¸²æŸ“**: å°½é‡å‡å°‘ç»˜åˆ¶è°ƒç”¨ï¼ŒæŒ‰çº¹ç†åˆ†ç»„æ¸²æŸ“
2. **å¯¹è±¡æ± **: é‡ç”¨çª—å£å¯¹è±¡ï¼Œå‡å°‘å†…å­˜åˆ†é…
3. **æ™ºèƒ½æŒ‡é’ˆ**: ä½¿ç”¨ RAII ç®¡ç†çª—å£ç”Ÿå‘½å‘¨æœŸ
4. **äº‹ä»¶ç®¡ç†**: è‡ªåŠ¨æ–­å¼€äº‹ä»¶è¿æ¥ï¼Œé¿å…å†…å­˜æ³„æ¼
5. **èµ„æºé¢„åŠ è½½**: åœ¨æ¸¸æˆå¯åŠ¨æ—¶é¢„åŠ è½½å¸¸ç”¨èµ„æº
6. **å¼‚æ­¥åŠ è½½**: å¤§å‹èµ„æºä½¿ç”¨å¼‚æ­¥åŠ è½½ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
7. **å†…å­˜ç›‘æ§**: å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æº

MT3 é¡¹ç›®çš„ CEGUI é›†æˆå±•ç¤ºäº†ï¼š
- è‡ªå®šä¹‰æ¸²æŸ“å™¨å®ç°
- é«˜æ•ˆçš„æ‰¹é‡æ¸²æŸ“
- å®Œæ•´çš„èµ„æºç®¡ç†ç³»ç»Ÿ
- ä¼˜åŒ–çš„å†…å­˜ç®¡ç†
- çµæ´»çš„äº‹ä»¶å¤„ç†æœºåˆ¶

CEGUI ä¸º MT3 æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„ UI ç³»ç»Ÿï¼Œé€‚åˆå¤æ‚çš„ MMO æ¸¸æˆ UI éœ€æ±‚ã€‚

---

## 12.2 CRT åº“å†²çªæ·±åº¦è§£æ

### é—®é¢˜æ¦‚è¿°

**é”™è¯¯ä¿¡æ¯**:
```
é”™è¯¯ LNK2005: __crt_debugger_hook å·²ç»åœ¨ MSVCRT.lib(utility_desktop.obj) ä¸­å®šä¹‰
é”™è¯¯ LNK1169: æ‰¾åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå¤šé‡å®šä¹‰çš„ç¬¦å·
```

**å…³é”®è­¦å‘Š**:
```
è­¦å‘Š LNK4098: é»˜è®¤åº“"libcmtd.lib"ä¸å…¶ä»–åº“çš„ä½¿ç”¨å†²çªï¼›è¯·ä½¿ç”¨ /NODEFAULTLIB:library
```

**å‘ç”Ÿæ—¶æœº**: ç¼–è¯‘ MT3 ä¸»ç¨‹åº (mt3.win32.vcxproj)

### å†²çªçš„æ ¹æœ¬åŸå› 

ä»ç¼–è¯‘æ—¥å¿—å¯ä»¥çœ‹åˆ°,é—®é¢˜å‡ºåœ¨**ä¸¤ä¸ªä¸åŒçš„ CRT åº“åŒæ—¶è¢«é“¾æ¥**:

```
ucrt.lib(api-ms-win-crt-runtime-l1-1-0.dll) : error LNK2005: __crt_debugger_hook å·²ç»åœ¨ MSVCRT.lib(utility_desktop.obj) ä¸­å®šä¹‰
```

è¿™è¡¨æ˜:
- **ucrt.lib** (æ–°çš„ Universal C Runtime) æ­£åœ¨è¢«é“¾æ¥ âœ…
- **MSVCRT.lib** (æ—§çš„å¤šçº¿ç¨‹åŠ¨æ€ CRT) ä¹Ÿåœ¨è¢«é“¾æ¥ âŒ

### ä¸ºä»€ä¹ˆä¼šåŒæ—¶é“¾æ¥ä¸¤ä¸ª CRT?

#### åŸå›  A: ä¾èµ–åº“ä½¿ç”¨äº†æ—§ç‰ˆ CRT

æŸ¥çœ‹ä¾èµ–åº“åˆ—è¡¨:
```xml
<AdditionalDependencies>
  legacy_stdio_definitions.lib;
  Ws2_32.lib;
  opengl32.lib;
  glew32.lib;
  libEGL.lib;        â† è¿˜åœ¨ä¾èµ–åˆ—è¡¨ä¸­!
  libGLESv2.lib;     â† è¿˜åœ¨ä¾èµ–åˆ—è¡¨ä¸­!
  libBox2D.lib;
  libcocos2d.lib;    â† å¯èƒ½æ˜¯æ—§ç‰ˆæœ¬ç¼–è¯‘çš„
  libCocosDenshion.lib;
  ...
  engine.lib;        â† å¯èƒ½æ˜¯æ—§ç‰ˆæœ¬ç¼–è¯‘çš„
  FireClient.lib;    â† å¯èƒ½æ˜¯æ—§ç‰ˆæœ¬ç¼–è¯‘çš„
  ...
</AdditionalDependencies>
```

**å…³é”®å‘ç°**: 
1. `libEGL.lib` å’Œ `libGLESv2.lib` **ä»ç„¶åœ¨ä¾èµ–åˆ—è¡¨ä¸­**!
2. å¾ˆå¤š `.lib` æ–‡ä»¶å¯èƒ½æ˜¯ç”¨æ—§ç‰ˆæœ¬ VS ç¼–è¯‘çš„,ä½¿ç”¨äº† MSVCRT.lib

#### åŸå›  B: ç¬¬ä¸‰æ–¹åº“çš„ CRT ç‰ˆæœ¬

ä»è­¦å‘Šä¿¡æ¯å¯ä»¥çœ‹åˆ°:
```
MSVCRT.lib(initializers.obj) : warning LNK4098: é»˜è®¤åº“"libcmtd.lib"ä¸å…¶ä»–åº“çš„ä½¿ç”¨å†²çª
```

è¿™è¯´æ˜æœ‰äº›åº“åœ¨é“¾æ¥æ—¶è‡ªåŠ¨å¼•å…¥äº† MSVCRT.lib

#### åŸå›  C: å¿½ç•¥é»˜è®¤åº“é…ç½®ä¸å®Œæ•´

æŸ¥çœ‹ `IgnoreSpecificDefaultLibraries`:
- Debug é…ç½®: åªå¿½ç•¥äº† `libcmtd.lib`
- Release é…ç½®: åªå¿½ç•¥äº† `libcmt.lib`

ä½†æ²¡æœ‰å¿½ç•¥ `MSVCRT.lib`!

### CRT åº“çš„é€‰æ‹©çŸ©é˜µ

| é…ç½® | é™æ€é“¾æ¥ | åŠ¨æ€é“¾æ¥ | VS2015+ |
|------|----------|----------|---------|
| **Debug** | libcmtd.lib | msvcrtd.lib | ucrtd.lib + vcruntimeXXXd.lib |
| **Release** | libcmt.lib | msvcrt.lib | ucrt.lib + vcruntimeXXX.lib |

**å½“å‰é—®é¢˜**: é¡¹ç›®ä½¿ç”¨ `/MD` (åŠ¨æ€ CRT),åº”è¯¥é“¾æ¥ `ucrt.lib`,ä½†ä¾èµ–åº“å¼•å…¥äº† `msvcrt.lib`

### Visual Studio ç‰ˆæœ¬ä¸ CRT å¯¹åº”å…³ç³»

| Visual Studio ç‰ˆæœ¬ | å¹³å°å·¥å…·é›† | CRT ç‰ˆæœ¬ | å‘å¸ƒå¹´ä»½ |
|-------------------|------------|----------|----------|
| Visual Studio 2010 | v100 | MSVCR100.dll | 2010 |
| Visual Studio 2012 | v110 | MSVCR110.dll | 2012 |
| Visual Studio 2013 | v120 | MSVCR120.dll | 2013 |
| **Visual Studio 2015** | **v140** | **UCRT + vcruntime140.dll** | 2015 |
| Visual Studio 2017 | v141 | UCRT + vcruntime140.dll | 2017 |
| Visual Studio 2019 | v142 | UCRT + vcruntime140.dll | 2019 |
| Visual Studio 2022 | v143 | UCRT + vcruntime140.dll | 2022 |

### CRT æ¶æ„å˜åŒ–

#### v120 (VS2013) CRTæ¶æ„:
```
åº”ç”¨ç¨‹åº â†’ MSVCR120.dll (å•ä¸€ CRT DLL)
         â†’ msvcp120.dll (C++ æ ‡å‡†åº“)
```

#### v140 (VS2015) Universal CRTæ¶æ„:
```
åº”ç”¨ç¨‹åº â†’ vcruntime140.dll (C++ è¿è¡Œæ—¶)
         â†’ msvcp140.dll (C++ æ ‡å‡†åº“)
         â†’ UCRT (Windows 10 ç»„ä»¶)
            â”œâ”€â”€ ucrtbase.dll (é€šç”¨ CRT å‡½æ•°)
            â””â”€â”€ api-ms-win-crt-*.dll (20å¤šä¸ªCRT APIé›†DLL)
               â”œâ”€â”€ api-ms-win-crt-runtime-l1-1-0.dll
               â”œâ”€â”€ api-ms-win-crt-stdio-l1-1-0.dll
               â”œâ”€â”€ api-ms-win-crt-heap-l1-1-0.dll
               â”œâ”€â”€ api-ms-win-crt-string-l1-1-0.dll
               â””â”€â”€ ...
```

### ç¬¦å·å†²çªåˆ†æ

#### __crt_debugger_hook å†²çª

```cpp
// v120è¿è¡Œæ—¶çš„ç¬¦å· (MSVCRT.libå¯¼å‡º)
void __cdecl __crt_debugger_hook(int reserved);

// v140è¿è¡Œæ—¶çš„å¯¹åº”ç¬¦å· (ucrtbase.dllå¯¼å‡º)
void __cdecl __crt_debugger_hook(int reserved);

// ucrt.lib â†’ __crt_debugger_hook (æ–°ç‰ˆæœ¬)
// MSVCRT.lib â†’ __crt_debugger_hook (æ—§ç‰ˆæœ¬)
// ç»“æœ: error LNK2005: __crt_debugger_hook å·²ç»åœ¨ MSVCRT.lib ä¸­å®šä¹‰
```

#### __acrt_iob_func å†²çª

```cpp
// v120è¿è¡Œæ—¶çš„ç¬¦å· (MSVCRT.libå¯¼å‡º)
FILE* __cdecl __iob_func(void);

// v140è¿è¡Œæ—¶çš„å¯¹åº”ç¬¦å· (ucrtbase.dllå¯¼å‡º)
FILE* __cdecl __acrt_iob_func(unsigned index);

// ucrtbase.dllä½¿ç”¨æ–°çš„å®ç°
FILE* __cdecl __acrt_iob_func(unsigned index) {
    return &(__acrt_iob_func_table)[index];
}
```

### å®Œæ•´è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: å½»åº•æ¸…ç†ä¾èµ–åˆ—è¡¨ (æ¨è)

**æ­¥éª¤ 1: ç§»é™¤ä¸éœ€è¦çš„åº“**

ä» `mt3.win32.vcxproj` ä¸­ç§»é™¤:
- `libEGL.lib` (Win32 ä¸éœ€è¦)
- `libGLESv2.lib` (Win32 ä¸éœ€è¦)

**æ­¥éª¤ 2: å¿½ç•¥æ—§ç‰ˆ CRT åº“**

åœ¨ `IgnoreSpecificDefaultLibraries` ä¸­æ·»åŠ :
- Debug: `libcmtd.lib;libcmt.lib;msvcrtd.lib;msvcrt.lib`
- Release: `libcmt.lib;libcmtd.lib;msvcrt.lib;msvcrtd.lib`

**åŸç†**: å¼ºåˆ¶é“¾æ¥å™¨å¿½ç•¥æ‰€æœ‰æ—§ç‰ˆ CRT,åªä½¿ç”¨ UCRT

**æ­¥éª¤ 3: ç¡®ä¿ä½¿ç”¨åŠ¨æ€ CRT**

- Debug: `RuntimeLibrary = MultiThreadedDebugDLL` (/MDd)
- Release: `RuntimeLibrary = MultiThreadedDLL` (/MD)

#### æ–¹æ¡ˆ 2: ä½¿ç”¨é™æ€ CRT (å¤‡é€‰)

å¦‚æœä¾èµ–åº“éƒ½æ˜¯é™æ€ç¼–è¯‘çš„,å¯ä»¥æ”¹ç”¨é™æ€ CRT:
- Debug: `RuntimeLibrary = MultiThreadedDebug` (/MTd)
- Release: `RuntimeLibrary = MultiThreaded` (/MT)

ä½†è¿™éœ€è¦é‡æ–°ç¼–è¯‘æ‰€æœ‰ä¾èµ–åº“!

#### æ–¹æ¡ˆ 3: é‡æ–°ç¼–è¯‘ä¾èµ–åº“ (æœ€å½»åº•)

ä½¿ç”¨ VS2015 é‡æ–°ç¼–è¯‘æ‰€æœ‰ä¾èµ–åº“:
```batch
# ç¼–è¯‘ Cocos2d-x å¼•æ“
cd cocos2d-2.0-rc2-x-2.0.1
call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" x86
msbuild cocos2d-win32.vc2010.sln /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140

# ç¼–è¯‘ CEGUI
cd dependencies/cegui
cmake -G "Visual Studio 14 2015" -DCMAKE_INSTALL_PREFIX=%INSTALL_DIR%\cegui ^
      -DCEGUI_BUILD_RENDERER_OPENGL=ON ^
      -DCEGUI_BUILD_RENDERER_OGRE=OFF ^
      -DCEGUI_BUILD_RENDERER_IRRLICHT=OFF ^
      -DCEGUI_BUILD_RENDERER_DIRECT3D10=OFF ^
      -DCEGUI_BUILD_RENDERER_DIRECT3D11=OFF ^
      -DCEGUI_BUILD_SAMPLES=OFF
msbuild cegui.sln /p:Configuration=Release /p:Platform=Win32

# ç¼–è¯‘å…¶ä»–ä¾èµ–åº“...
```

### å…·ä½“ä¿®å¤æ­¥éª¤

#### ä¿®æ”¹ 1: Debug é…ç½®

**æ–‡ä»¶**: `client/MT3Win32App/mt3.win32.vcxproj`
**ä½ç½®**: ç¬¬ 72 è¡Œ (AdditionalDependencies)

```xml
<!-- ä¿®æ”¹å‰ -->
<AdditionalDependencies>legacy_stdio_definitions.lib;Ws2_32.lib;opengl32.lib;glew32.lib;libEGL.lib;libGLESv2.lib;libBox2D.lib;...</AdditionalDependencies>

<!-- ä¿®æ”¹å -->
<AdditionalDependencies>legacy_stdio_definitions.lib;Ws2_32.lib;opengl32.lib;glew32.lib;libBox2D.lib;...</AdditionalDependencies>
```

**ä½ç½®**: ç¬¬ 76 è¡Œ (IgnoreSpecificDefaultLibraries)

```xml
<!-- ä¿®æ”¹å‰ -->
<IgnoreSpecificDefaultLibraries>libcmtd.lib</IgnoreSpecificDefaultLibraries>

<!-- ä¿®æ”¹å -->
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib;msvcrt.lib;msvcrtd.lib</IgnoreSpecificDefaultLibraries>
```

#### ä¿®æ”¹ 2: Release é…ç½®

**ä½ç½®**: ç¬¬ 108 è¡Œ (AdditionalDependencies)

```xml
<!-- ä¿®æ”¹å‰ -->
<AdditionalDependencies>legacy_stdio_definitions.lib;Ws2_32.lib;opengl32.lib;glew32.lib;libEGL.lib;libGLESv2.lib;libBox2D.lib;...</AdditionalDependencies>

<!-- ä¿®æ”¹å -->
<AdditionalDependencies>legacy_stdio_definitions.lib;Ws2_32.lib;opengl32.lib;glew32.lib;libBox2D.lib;...</AdditionalDependencies>
```

**ä½ç½®**: ç¬¬ 112 è¡Œ (IgnoreSpecificDefaultLibraries)

```xml
<!-- ä¿®æ”¹å‰ -->
<IgnoreSpecificDefaultLibraries>libcmt.lib</IgnoreSpecificDefaultLibraries>

<!-- ä¿®æ”¹å -->
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib;msvcrt.lib;msvcrtd.lib</IgnoreSpecificDefaultLibraries>
```

### æŠ€æœ¯æ·±åº¦è§£æ

#### __crt_debugger_hook æ˜¯ä»€ä¹ˆ?

```c
// è¿™æ˜¯ CRT å†…éƒ¨çš„è°ƒè¯•é’©å­å‡½æ•°
extern "C" void __crt_debugger_hook(int reserved) {
    // è°ƒè¯•å™¨å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®æ–­ç‚¹æ¥æ£€æµ‹ CRT äº‹ä»¶
}
```

**ä¸ºä»€ä¹ˆä¼šé‡å¤å®šä¹‰?**
- UCRT æœ‰ä¸€ä¸ªç‰ˆæœ¬çš„ `__crt_debugger_hook`
- MSVCRT ä¹Ÿæœ‰ä¸€ä¸ªç‰ˆæœ¬çš„ `__crt_debugger_hook`
- å½“ä¸¤ä¸ªåº“åŒæ—¶è¢«é“¾æ¥æ—¶,é“¾æ¥å™¨å‘ç°ä¸¤ä¸ªç¬¦å·,æŠ¥é”™

#### ä¸ºä»€ä¹ˆä¾èµ–åº“ä¼šå¼•å…¥ MSVCRT.lib?

##### åŸå›  1: åº“æ–‡ä»¶çš„ç¼–è¯‘é€‰é¡¹

å¦‚æœä¾èµ–åº“æ˜¯ç”¨æ—§ç‰ˆ VS ç¼–è¯‘çš„:
```
VS2010/2012/2013 ç¼–è¯‘çš„ .lib æ–‡ä»¶
  â†“
ä½¿ç”¨ /MD é€‰é¡¹(åŠ¨æ€ CRT)
  â†“
è‡ªåŠ¨ä¾èµ– MSVCRT.lib
  â†“
é“¾æ¥æ—¶è‡ªåŠ¨åŠ è½½ MSVCRT.lib
```

##### åŸå›  2: éšå¼é“¾æ¥

æŸäº›åº“å¯èƒ½éšå¼é“¾æ¥äº† CRT:
```cpp
// åº“ä»£ç ä¸­ä½¿ç”¨äº† CRT å‡½æ•°
#include <stdio.h>
#include <stdlib.h>

void some_function() {
    printf("Hello");  // éšå¼é“¾æ¥äº† CRT
    malloc(100);      // éšå¼é“¾æ¥äº† CRT
}
```

#### è¿è¡Œæ—¶åº“å¯¹æ¯”

| é…ç½® | ç¼–è¯‘é€‰é¡¹ | è¿è¡Œæ—¶ DLL | å¯¼å…¥åº“ | è°ƒè¯•æ”¯æŒ |
|------|----------|------------|--------|----------|
| **Release - MD** | `/MD` | msvcr140.dll | msvcrt.lib | âŒ æ—  |
| **Debug - MDd** | `/MDd` | msvcr140d.dll | msvcrtd.lib | âœ… å®Œæ•´ |
| **Release - MT** | `/MT` | æ— (é™æ€) | libcmt.lib | âŒ æ—  |
| **Debug - MTd** | `/MTd` | æ— (é™æ€) | libcmtd.lib | âœ… å®Œæ•´ |

#### CRT ç‰ˆæœ¬æ£€æµ‹

```cpp
// æ£€æµ‹å½“å‰ä½¿ç”¨çš„ CRT ç‰ˆæœ¬
#include <crtdbg.h>
#include <stdio.h>

void detect_crt_version() {
    // _MSC_VER å®šä¹‰ç¼–è¯‘å™¨ç‰ˆæœ¬
    printf("Compiler version: %d\n", _MSC_VER);
    
    // _MSC_FULL_VER åŒ…å«å®Œæ•´ç‰ˆæœ¬å·
    printf("Full compiler version: %d\n", _MSC_FULL_VER);
    
    // æ£€æµ‹æ˜¯å¦ä½¿ç”¨ UCRT
#ifdef _UCRT
    printf("Using Universal CRT (UCRT)\n");
#else
    printf("Using legacy CRT\n");
#endif
    
    // æ£€æµ‹è¿è¡Œæ—¶åº“ç±»å‹
#ifdef _MT
    printf("Multithreaded CRT\n");
#else
    printf("Single-threaded CRT\n");
#endif

#ifdef _DLL
    printf("Dynamic linking CRT\n");
#else
    printf("Static linking CRT\n");
#endif

#ifdef _DEBUG
    printf("Debug CRT\n");
#else
    printf("Release CRT\n");
#endif
}
```

#### CRT å…¼å®¹æ€§åŒ…è£…å™¨

å¦‚æœå¿…é¡»æ··åˆä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ CRT,å¯ä»¥åˆ›å»ºå…¼å®¹æ€§åŒ…è£…å™¨:

```cpp
// crt_compat_wrapper.cpp
#include <corecrt_io.h>
#include <stdio.h>

// ä¸ºæ—§ç‰ˆ CRT æä¾›å…¼å®¹æ€§å‡½æ•°
extern "C" {
    // v120ä¸­çš„ __iob_func åœ¨ v140ä¸­æ”¹ä¸º __acrt_iob_func
    FILE* __cdecl __iob_func(void) {
        // v140ä¸­ä½¿ç”¨__acrt_iob_funcæ›¿ä»£
        return __acrt_iob_func(0);
    }
    
    // å…¶ä»–å¯èƒ½çš„å…¼å®¹æ€§å‡½æ•°...
}

// crt_compat.def
EXPORTS
    __iob_func
    ; å…¶ä»–éœ€è¦å¯¼å‡ºçš„å‡½æ•°...

// ç¼–è¯‘å‘½ä»¤
cl /LD crt_compat_wrapper.cpp /Fecrt_compat.dll /DEF:crt_compat.def
```

ç„¶ååœ¨é¡¹ç›®ä¸­é“¾æ¥è¿™ä¸ªå…¼å®¹æ€§åº“:
```xml
<AdditionalDependencies>crt_compat.lib;...</AdditionalDependencies>
```

### éªŒè¯æ–¹æ³•

#### æ£€æŸ¥é“¾æ¥çš„ CRT åº“

ä½¿ç”¨ `/VERBOSE` é“¾æ¥å™¨é€‰é¡¹æŸ¥çœ‹å®é™…é“¾æ¥çš„åº“:
```xml
<Link>
  <AdditionalOptions>/VERBOSE:LIB %(AdditionalOptions)</AdditionalOptions>
</Link>
```

è¾“å‡ºç¤ºä¾‹:
```
1>æœç´¢åº“
1>  æœç´¢ msvcrtd.lib:
1>    å·²æœç´¢ C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\lib\msvcrtd.lib
1>  æœç´¢ ucrtd.lib:
1>    å·²æœç´¢ C:\Program Files (x86)\Windows Kits\10\Lib\10.0.19041.0\ucrt\x86\ucrtd.lib
1>  æœç´¢ MSVCRT.lib:
1>    å·²æœç´¢ C:\Program Files (x86)\Windows Kits\10\Lib\10.0.19041.0\um\x86\MSVCRT.lib
```

#### ä½¿ç”¨ dumpbin æ£€æŸ¥ç¬¦å·

```batch
# æ£€æŸ¥åº“ä¸­å¯¼å‡ºçš„ç¬¦å·
dumpbin /exports msvcr140.dll | findstr __crt_debugger_hook
dumpbin /exports msvcr100.dll | findstr __crt_debugger_hook

# æ£€æŸ¥å¯¹è±¡æ–‡ä»¶ä¸­å¼•ç”¨çš„ç¬¦å·
dumpbin /symbols some.obj | findstr __crt_debugger_hook
```

#### è¿è¡Œæ—¶æ£€æŸ¥

```cpp
// æ£€æŸ¥è¿è¡Œæ—¶åŠ è½½çš„ DLL
#include <windows.h>
#include <stdio.h>

void check_loaded_crt() {
    HMODULE hModule = GetModuleHandle(L"msvcr140.dll");
    if (hModule) {
        printf("Loaded: msvcr140.dll\n");
    }
    
    hModule = GetModuleHandle(L"msvcr140d.dll");
    if (hModule) {
        printf("Loaded: msvcr140d.dll\n");
    }
    
    hModule = GetModuleHandle(L"ucrtbase.dll");
    if (hModule) {
        printf("Loaded: ucrtbase.dll\n");
    }
    
    hModule = GetModuleHandle(L"msvcr100.dll");
    if (hModule) {
        printf("Loaded: msvcr100.dll (OLD CRT!)\n");
    }
}
```

### å¸¸è§é—®é¢˜è§£ç­”

#### Q: ä¸ºä»€ä¹ˆä¸èƒ½æ··åˆä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ CRT?

A: ä¸åŒç‰ˆæœ¬çš„ CRT æœ‰ç‹¬ç«‹çš„å †ç®¡ç†å™¨ã€æ–‡ä»¶æè¿°ç¬¦è¡¨å’Œå…¶ä»–å†…éƒ¨çŠ¶æ€ã€‚å¦‚æœåœ¨ä¸€ä¸ª CRT ä¸­åˆ†é…å†…å­˜,åœ¨å¦ä¸€ä¸ª CRT ä¸­é‡Šæ”¾,ä¼šå¯¼è‡´å †æŸåå’Œå´©æºƒã€‚

#### Q: ä»€ä¹ˆæ˜¯ Universal CRT (UCRT)?

A: Universal CRT æ˜¯ä» Windows 10 å¼€å§‹ä½œä¸ºæ“ä½œç³»ç»Ÿç»„ä»¶æä¾›çš„ C è¿è¡Œæ—¶åº“ã€‚å®ƒè§£å†³äº†ä»¥å¾€æ¯ä¸ª Visual Studio ç‰ˆæœ¬éƒ½éœ€è¦ç‹¬ç«‹ CRT çš„é—®é¢˜,å®ç°äº† CRT çš„å‘åå…¼å®¹å’Œå‘å‰å…¼å®¹ã€‚

#### Q: å¦‚ä½•ç¡®å®šåº”è¯¥å¿½ç•¥å“ªäº› CRT åº“?

A: æ ¹æ®é¡¹ç›®ä½¿ç”¨çš„è¿è¡Œæ—¶åº“ç±»å‹:
- ä½¿ç”¨ `/MD` æˆ– `/MDd`: å¿½ç•¥æ‰€æœ‰é™æ€ CRT (`libcmt.lib`, `libcmtd.lib`)
- ä½¿ç”¨ `/MT` æˆ– `/MTd`: å¿½ç•¥æ‰€æœ‰åŠ¨æ€ CRT (`msvcrt.lib`, `msvcrtd.lib`)
- ä½¿ç”¨ VS2015+: å¿½ç•¥æ—§ç‰ˆ CRT (`msvcrt.lib`, `msvcrtd.lib`)

#### Q: ä¸ºä»€ä¹ˆéœ€è¦ `legacy_stdio_definitions.lib`?

A: VS2015 çš„ UCRT ç§»é™¤äº†ä¸€äº›è¿‡æ—¶çš„ stdio å‡½æ•°,ä½†æ—§ä»£ç å¯èƒ½ä»åœ¨ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚`legacy_stdio_definitions.lib` æä¾›äº†è¿™äº›å‡½æ•°çš„å®šä¹‰,ç¡®ä¿å…¼å®¹æ€§ã€‚

### æ€»ç»“

CRT åº“å†²çªæ˜¯ VS2015 å‡çº§è¿‡ç¨‹ä¸­æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ã€‚æ ¹æœ¬åŸå› æ˜¯ VS2015 å¼•å…¥äº†å…¨æ–°çš„ Universal CRT æ¶æ„,ä¸æ—§ç‰ˆ CRT ä¸å…¼å®¹ã€‚

è§£å†³æ–¹æ³•:
1. **æ¸…ç†ä¾èµ–åˆ—è¡¨**: ç§»é™¤ä¸éœ€è¦çš„åº“(å¦‚ `libEGL.lib`, `libGLESv2.lib`)
2. **ç»Ÿä¸€ CRT ç‰ˆæœ¬**: ç¡®ä¿æ‰€æœ‰åº“ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ CRT
3. **æ­£ç¡®å¿½ç•¥å†²çªåº“**: åœ¨é“¾æ¥å™¨è®¾ç½®ä¸­å¿½ç•¥å†²çªçš„ CRT åº“
4. **è€ƒè™‘é‡æ–°ç¼–è¯‘**: å¯¹äºå¤æ‚é¡¹ç›®,è€ƒè™‘ä½¿ç”¨ VS2015 é‡æ–°ç¼–è¯‘æ‰€æœ‰ä¾èµ–åº“

---

## 12.3 libEGL/ANGLE é“¾æ¥é—®é¢˜

### é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**:
```
4>LINK : fatal error LNK1104: æ— æ³•æ‰“å¼€æ–‡ä»¶"libEGL.lib"
```

**å‘ç”Ÿæ—¶æœº**: ç¼–è¯‘ `cocos2d-win32.vc2010.sln` æ—¶

### é—®é¢˜æ ¹æœ¬åŸå› 

é€šè¿‡æ·±å…¥åˆ†æ,å‘ç°è¿™æ˜¯ä¸€ä¸ª**å¹³å°é…ç½®é”™è¯¯**:

#### ANGLE é¡¹ç›®ç®€ä»‹

- **ANGLE** (Almost Native Graphics Layer Engine) æ˜¯ Google å¼€å‘çš„é¡¹ç›®
- ç”¨äºå°† **OpenGL ES API** è°ƒç”¨è½¬æ¢ä¸º **DirectX** è°ƒç”¨
- ä¸»è¦ç”¨äºç§»åŠ¨å¹³å°(WinRT/WP8)åœ¨ Windows ä¸Šè¿è¡Œ

#### Win32 vs ç§»åŠ¨å¹³å°çš„å·®å¼‚

| å¹³å° | ä½¿ç”¨çš„å›¾å½¢ API | éœ€è¦çš„åº“ |
|------|----------------|----------|
| **Win32 æ¡Œé¢** | åŸç”Ÿ OpenGL (é€šè¿‡ GLEW) | `opengl32.lib`, `glew32.lib` |
| **WinRT/WP8** | OpenGL ES (é€šè¿‡ ANGLE) | `libEGL.lib`, `libGLESv2.lib` |

#### é¡¹ç›®é…ç½®é”™è¯¯

- `cocos2d-win32.vcxproj` ä¸­é”™è¯¯åœ°åŒ…å«äº† ANGLE åº“ä¾èµ–
- ä½† `cocos2d-win32.vc2010.sln` è§£å†³æ–¹æ¡ˆä¸­**æ²¡æœ‰åŒ…å« ANGLE é¡¹ç›®**
- Win32 å¹³å°æ ¹æœ¬**ä¸éœ€è¦**ä¹Ÿ**ä¸åº”è¯¥ä½¿ç”¨** ANGLE

#### ä»£ç è¯æ®

**Win32 å¹³å°å¤´æ–‡ä»¶** (`cocos2dx/platform/win32/CCGL.h`):
```cpp
#ifndef __CCGL_H__
#define __CCGL_H__

#include "GL/glew.h"  // ä½¿ç”¨åŸç”Ÿ OpenGL

#define CC_GL_DEPTH24_STENCIL8    GL_DEPTH24_STENCIL8

#endif // __CCGL_H__
```

**ç§»åŠ¨å¹³å°ä»£ç ** (WinRT/WP8):
```cpp
// ä½¿ç”¨ EGL
EGLDisplay display = eglGetDisplay(EGL_DEFAULT_DISPLAY);
eglInitialize(display, NULL, NULL);
// ... æ›´å¤š EGL ä»£ç 
```

ä»ä»£ç æœç´¢ç»“æœå¯ä»¥ç¡®è®¤:
- æ‰€æœ‰ `EGL` å’Œ `GLES` å¼•ç”¨éƒ½åœ¨ç§»åŠ¨å¹³å°ä»£ç ä¸­
- Win32 å¹³å°å®Œå…¨ä¸ä½¿ç”¨ EGL/GLES

### è§£å†³æ–¹æ¡ˆ

ä» `cocos2d-win32.vcxproj` ä¸­ç§»é™¤ä¸éœ€è¦çš„ ANGLE åº“ä¾èµ–:

#### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶**: `cocos2d-2.0-rc2-x-2.0.1/cocos2dx/proj.win32/cocos2d-win32.vcxproj`

##### ä¿®æ”¹ 1: Debug é…ç½® (ç¬¬ 72 è¡Œ)

```xml
<!-- ä¿®æ”¹å‰ -->
<AdditionalDependencies>opengl32.lib;glew32.lib;libxml2.lib;libzlib.lib;libjpeg.lib;winmm.lib;libpng.lib;libtiff.lib;libiconv.lib;pthreadVCE2.lib;libwebp.lib;libEGL.lib;libGLESv2.lib;libBox2D.lib;%(AdditionalDependencies)</AdditionalDependencies>

<!-- ä¿®æ”¹å -->
<AdditionalDependencies>opengl32.lib;glew32.lib;libxml2.lib;libzlib.lib;libjpeg.lib;winmm.lib;libpng.lib;libtiff.lib;libiconv.lib;pthreadVCE2.lib;libwebp.lib;libBox2D.lib;%(AdditionalDependencies)</AdditionalDependencies>
```

##### ä¿®æ”¹ 2: Release é…ç½® (ç¬¬ 110 è¡Œ)

```xml
<!-- ä¿®æ”¹å‰ -->
<AdditionalDependencies>opengl32.lib;glew32.lib;libxml2.lib;libzlib.lib;libjpeg.lib;winmm.lib;libtiff.lib;libpng.lib;libiconv.lib;pthreadVCE2.lib;libEGL.lib;libGLESv2.lib;libBox2D.lib;libwebp.lib;%(AdditionalDependencies)</AdditionalDependencies>

<!-- ä¿®æ”¹å -->
<AdditionalDependencies>opengl32.lib;glew32.lib;libxml2.lib;libzlib.lib;libjpeg.lib;winmm.lib;libtiff.lib;libpng.lib;libiconv.lib;pthreadVCE2.lib;libBox2D.lib;libwebp.lib;%(AdditionalDependencies)</AdditionalDependencies>
```

**å˜æ›´è¯´æ˜**: ç§»é™¤äº† `libEGL.lib` å’Œ `libGLESv2.lib`

### æŠ€æœ¯èƒŒæ™¯

#### OpenGL vs OpenGL ES

| ç‰¹æ€§ | OpenGL | OpenGL ES |
|------|--------|-----------|
| **ç›®æ ‡å¹³å°** | æ¡Œé¢ç³»ç»Ÿ | åµŒå…¥å¼/ç§»åŠ¨è®¾å¤‡ |
| **åŠŸèƒ½é›†** | å®Œæ•´åŠŸèƒ½ | ç²¾ç®€å­é›† |
| **Windows æ”¯æŒ** | åŸç”Ÿæ”¯æŒ | éœ€è¦ ANGLE è½¬æ¢å±‚ |
| **MT3 Win32 ä½¿ç”¨** | âœ… æ˜¯ | âŒ å¦ |

#### GLEW (OpenGL Extension Wrangler)

- ç”¨äºåŠ è½½å’Œç®¡ç† OpenGL æ‰©å±•
- Win32 ç‰ˆæœ¬çš„ Cocos2d-x é€šè¿‡ GLEW ä½¿ç”¨åŸç”Ÿ OpenGL
- å·²ç»åœ¨ `cocos2dx/platform/third_party/win32/libraries/glew32.lib` ä¸­æä¾›

#### ANGLE åœ¨ Cocos2d-x ä¸­çš„ä½¿ç”¨

Cocos2d-x æ”¯æŒå¤šä¸ªå¹³å°,ä¸åŒå¹³å°ä½¿ç”¨ä¸åŒçš„å›¾å½¢åç«¯:

```
Cocos2d-x æ¶æ„
â”œâ”€â”€ Win32
â”‚   â””â”€â”€ åŸç”Ÿ OpenGL (é€šè¿‡ GLEW)
â”œâ”€â”€ WinRT
â”‚   â””â”€â”€ OpenGL ES (é€šè¿‡ ANGLE)
â”œâ”€â”€ Windows Phone 8
â”‚   â””â”€â”€ OpenGL ES (é€šè¿‡ ANGLE)
â”œâ”€â”€ Android
â”‚   â””â”€â”€ OpenGL ES (åŸç”Ÿ)
â””â”€â”€ iOS
    â””â”€â”€ OpenGL ES (åŸç”Ÿ)
```

### éªŒè¯æ–¹æ³•

ç¼–è¯‘ `cocos2d-win32.vc2010.sln`:

```batch
REM ä½¿ç”¨æä¾›çš„æ‰¹å¤„ç†è„šæœ¬
build_cocos2d.bat
```

æˆ–è€…ç›´æ¥ç¼–è¯‘:

```batch
call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" x86
devenv.com "cocos2d-2.0-rc2-x-2.0.1\cocos2d-win32.vc2010.sln" /Rebuild "Release|Win32"
```

**é¢„æœŸç»“æœ**: 
- âœ… ç¼–è¯‘æˆåŠŸ,æ²¡æœ‰ LNK1104 é”™è¯¯
- âœ… ç”Ÿæˆ `libcocos2d.dll` å’Œ `libcocos2d.lib`
- âœ… ä½äº `cocos2d-2.0-rc2-x-2.0.1/Release.win32/` ç›®å½•

### æ·±å…¥åˆ†æ: ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯?

#### è·¨å¹³å°ä»£ç å…±äº«å¯¼è‡´çš„é—®é¢˜

Cocos2d-x æ˜¯ä¸€ä¸ªè·¨å¹³å°å¼•æ“,ä»£ç åº“ä¸­åŒ…å«å¤šä¸ªå¹³å°çš„å®ç°:

```
cocos2dx/platform/
â”œâ”€â”€ win32/
â”‚   â”œâ”€â”€ CCGL.h          # ä½¿ç”¨ GLEW
â”‚   â””â”€â”€ ...
â”œâ”€â”€ winrt/
â”‚   â”œâ”€â”€ CCGL.h          # ä½¿ç”¨ EGL
â”‚   â””â”€â”€ ...
â”œâ”€â”€ wp8/
â”‚   â”œâ”€â”€ CCGL.h          # ä½¿ç”¨ EGL
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

åœ¨é¡¹ç›®é…ç½®è¿‡ç¨‹ä¸­,å¯èƒ½é”™è¯¯åœ°å°†ç§»åŠ¨å¹³å°çš„åº“ä¾èµ–æ·»åŠ åˆ°äº† Win32 é¡¹ç›®ä¸­ã€‚

#### ANGLE é¡¹ç›®ç»“æ„

å¦‚æœéœ€è¦ä½¿ç”¨ ANGLE,é¡¹ç›®ç»“æ„åº”è¯¥æ˜¯:

```
angleproject/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ libEGL/
â”‚   â”œâ”€â”€ libGLESv2/
â”‚   â”œâ”€â”€ translator/
â”‚   â””â”€â”€ preprocessor/
â””â”€â”€ lib/
    â”œâ”€â”€ $(Configuration)/
    â”‚   â”œâ”€â”€ libEGL.lib
    â”‚   â”œâ”€â”€ libGLESv2.lib
    â”‚   â”œâ”€â”€ translator_common.lib
    â”‚   â”œâ”€â”€ translator_hlsl.lib
    â”‚   â””â”€â”€ preprocessor.lib
```

ä½†åœ¨ MT3 é¡¹ç›®ä¸­,è¿™äº›åº“æ–‡ä»¶å¹¶ä¸å­˜åœ¨,å› ä¸º Win32 ä¸éœ€è¦ ANGLEã€‚

### ç§»é™¤ ANGLE ä¾èµ–çš„å½±å“åˆ†æ

#### å¯¹ Win32 å¹³å°çš„å½±å“

- âœ… **æ— è´Ÿé¢å½±å“**: Win32 å¹³å°åŸæœ¬å°±ä¸éœ€è¦ ANGLE
- âœ… **ç¼–è¯‘æˆåŠŸ**: è§£å†³äº† LNK1104 é”™è¯¯
- âœ… **è¿è¡Œæ­£å¸¸**: ä½¿ç”¨åŸç”Ÿ OpenGL,æ€§èƒ½æ›´å¥½

#### å¯¹è·¨å¹³å°æ”¯æŒçš„å½±å“

- âš ï¸ **éœ€è¦æ³¨æ„**: å¦‚æœå°†æ¥éœ€è¦æ”¯æŒ WinRT/WP8,éœ€è¦é‡æ–°æ·»åŠ  ANGLE æ”¯æŒ
- âš ï¸ **æ–‡æ¡£æ›´æ–°**: éœ€è¦æ˜ç¡®åŒºåˆ†ä¸åŒå¹³å°çš„åº“ä¾èµ–

### æœ€ä½³å®è·µå»ºè®®

#### 1. å¹³å°ç‰¹å®šé…ç½®

ä¸ºä¸åŒå¹³å°åˆ›å»ºä¸åŒçš„é¡¹ç›®é…ç½®:

```xml
<!-- Win32 å¹³å° -->
<ItemDefinitionGroup Condition="'$(Platform)'=='Win32'">
  <Link>
    <AdditionalDependencies>opengl32.lib;glew32.lib;...</AdditionalDependencies>
  </Link>
</ItemDefinitionGroup>

<!-- WinRT å¹³å° -->
<ItemDefinitionGroup Condition="'$(Platform)'=='WinRT'">
  <Link>
    <AdditionalDependencies>libEGL.lib;libGLESv2.lib;...</AdditionalDependencies>
  </Link>
</ItemDefinitionGroup>
```

#### 2. æ¡ä»¶ç¼–è¯‘

ä½¿ç”¨é¢„å¤„ç†å™¨æŒ‡ä»¤åŒºåˆ†å¹³å°:

```cpp
#if (CC_TARGET_PLATFORM == CC_PLATFORM_WIN32)
    #include "GL/glew.h"  // Win32 ä½¿ç”¨åŸç”Ÿ OpenGL
#elif (CC_TARGET_PLATFORM == CC_PLATFORM_WINRT)
    #include <EGL/egl.h>  // WinRT ä½¿ç”¨ EGL
#endif
```

#### 3. æ¸…æ™°çš„æ–‡æ¡£

åœ¨é¡¹ç›®æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜ä¸åŒå¹³å°çš„ä¾èµ–:

```
## å¹³å°ä¾èµ–

### Win32
- OpenGL: åŸç”Ÿæ”¯æŒ
- ä¾èµ–åº“: opengl32.lib, glew32.lib
- ä¸éœ€è¦: ANGLE

### WinRT
- OpenGL: é€šè¿‡ ANGLE
- ä¾èµ–åº“: libEGL.lib, libGLESv2.lib
- éœ€è¦: ANGLE é¡¹ç›®
```

### æ€»ç»“

#### é—®é¢˜æœ¬è´¨

- è¿™æ˜¯ä¸€ä¸ª**è·¨å¹³å°é…ç½®æ±¡æŸ“**é—®é¢˜
- ç§»åŠ¨å¹³å°(WinRT/WP8)çš„é…ç½®é”™è¯¯åœ°æ··å…¥äº† Win32 æ¡Œé¢é¡¹ç›®
- å¯¼è‡´ Win32 é¡¹ç›®å°è¯•é“¾æ¥æœ¬ä¸éœ€è¦çš„ç§»åŠ¨å¹³å°åº“

#### è§£å†³æ€è·¯

1. **è¯†åˆ«å¹³å°å·®å¼‚**: Win32 ä½¿ç”¨ OpenGL,ç§»åŠ¨å¹³å°ä½¿ç”¨ OpenGL ES
2. **æ¸…ç†é…ç½®**: ç§»é™¤ Win32 é¡¹ç›®ä¸­çš„ ANGLE ä¾èµ–
3. **ä¿æŒç®€æ´**: Win32 åªéœ€è¦ `opengl32.lib` å’Œ `glew32.lib`

#### ç›¸å…³ä¿®å¤

è¿™æ˜¯ MT3 é¡¹ç›® VS2015 å…¼å®¹æ€§ä¿®å¤ç³»åˆ—çš„ç¬¬ 4 ä¸ªé—®é¢˜:

1. âœ… C1083 - SimpleAudioEngine.h å¤´æ–‡ä»¶è·¯å¾„
2. âœ… LNK2005/LNK1169 - CRT åº“å†²çª
3. âœ… C2011 - timespec é‡å®šä¹‰
4. âœ… **LNK1104 - libEGL.lib ç¼ºå¤± (æœ¬æ–‡æ¡£)**

---

## æŠ€æœ¯ä¸“é¢˜äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

1. [06-ç¼–è¯‘å®Œæ•´æŒ‡å—.md](./06-ç¼–è¯‘å®Œæ•´æŒ‡å—.md) - åŒ…å« CEGUI ç¼–è¯‘æ­¥éª¤
2. [10-ç¼–è¯‘é—®é¢˜æ’æŸ¥.md](./10-ç¼–è¯‘é—®é¢˜æ’æŸ¥.md) - åŒ…å« CRT å†²çªå’Œ libEGL é—®é¢˜æ’æŸ¥
3. [MT3ç¼–è¯‘é—®é¢˜ä¿®å¤æ€»ç»“.md](./MT3ç¼–è¯‘é—®é¢˜ä¿®å¤æ€»ç»“.md) - åŒ…å«å·²ä¿®å¤çš„é—®é¢˜åˆ—è¡¨
4. [Debugç¼–è¯‘é”™è¯¯åˆ†æä¸è§£å†³æ–¹æ¡ˆ.md](./Debugç¼–è¯‘é”™è¯¯åˆ†æä¸è§£å†³æ–¹æ¡ˆ.md) - åŒ…å« Debug é…ç½®çš„ CRT é—®é¢˜
5. [MT3é¡¹ç›®ç¼–è¯‘é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ.md](./MT3é¡¹ç›®ç¼–è¯‘é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ.md) - åŒ…å«é¡¹ç›®ä¾èµ–å…³ç³»åˆ†æ

### ä¸“é¢˜å…³è”å›¾

```
MT3 é¡¹ç›®æŠ€æœ¯ä¸“é¢˜
â”œâ”€â”€ 12.1 CEGUI UI ç³»ç»Ÿ
â”‚   â”œâ”€â”€ ä¾èµ–: FreeType, SILLY, pcre
â”‚   â”œâ”€â”€ ç›¸å…³: UI æ¸²æŸ“, èµ„æºç®¡ç†
â”‚   â””â”€â”€ æ–‡æ¡£: CEGUIæŠ€æœ¯é›†æˆæŒ‡å—.md
â”œâ”€â”€ 12.2 CRT åº“å†²çª
â”‚   â”œâ”€â”€ å½±å“: æ‰€æœ‰é“¾æ¥é˜¶æ®µ
â”‚   â”œâ”€â”€ ç›¸å…³: VS2015 å…¼å®¹æ€§, è¿è¡Œæ—¶åº“
â”‚   â””â”€â”€ æ–‡æ¡£: CRTåº“å†²çªæ·±åº¦åˆ†æ.md
â””â”€â”€ 12.3 libEGL/ANGLE é“¾æ¥é—®é¢˜
    â”œâ”€â”€ å½±å“: OpenGL æ¸²æŸ“
    â”œâ”€â”€ ç›¸å…³: è·¨å¹³å°æ”¯æŒ, å›¾å½¢ API
    â””â”€â”€ æ–‡æ¡£: libEGLé“¾æ¥é”™è¯¯ä¿®å¤è¯´æ˜.md
```

---

## å¸¸è§é—®é¢˜è§£ç­”

### Q: CEGUI ç›¸å…³é—®é¢˜

**Q: CEGUI æ¸²æŸ“æ€§èƒ½å¦‚ä½•ä¼˜åŒ–?**
A: 
- ä½¿ç”¨æ‰¹é‡æ¸²æŸ“å‡å°‘ç»˜åˆ¶è°ƒç”¨
- æŒ‰çº¹ç†åˆ†ç»„æ¸²æŸ“
- å®ç°å¯¹è±¡æ± é‡ç”¨çª—å£å¯¹è±¡
- ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†ç”Ÿå‘½å‘¨æœŸ

**Q: CEGUI å¦‚ä½•ä¸ Cocos2d-x åæ ‡ç³»å…¼å®¹?**
A: 
- CEGUI ä½¿ç”¨å·¦ä¸Šè§’ä¸ºåŸç‚¹
- Cocos2d-x ä½¿ç”¨å·¦ä¸‹è§’ä¸ºåŸç‚¹
- éœ€è¦è¿›è¡Œ Y åæ ‡ç¿»è½¬: `y = screenHeight - ceguiY`

**Q: CEGUI èµ„æºå¦‚ä½•ç®¡ç†?**
A: 
- ä½¿ç”¨äºŒè¿›åˆ¶å¸ƒå±€ç³»ç»Ÿæé«˜åŠ è½½é€Ÿåº¦
- é¢„åŠ è½½å¸¸ç”¨èµ„æº
- å®ç°å¼‚æ­¥åŠ è½½å¤§å‹èµ„æº
- å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ

### Q: CRT ç›¸å…³é—®é¢˜

**Q: ä¸ºä»€ä¹ˆä¸èƒ½æ··åˆä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ CRT?**
A: ä¸åŒç‰ˆæœ¬çš„ CRT æœ‰ç‹¬ç«‹çš„å †ç®¡ç†å™¨ã€æ–‡ä»¶æè¿°ç¬¦è¡¨å’Œå…¶ä»–å†…éƒ¨çŠ¶æ€ã€‚å¦‚æœåœ¨ä¸€ä¸ª CRT ä¸­åˆ†é…å†…å­˜,åœ¨å¦ä¸€ä¸ª CRT ä¸­é‡Šæ”¾,ä¼šå¯¼è‡´å †æŸåå’Œå´©æºƒã€‚

**Q: ä»€ä¹ˆæ˜¯ Universal CRT (UCRT)?**
A: Universal CRT æ˜¯ä» Windows 10 å¼€å§‹ä½œä¸ºæ“ä½œç³»ç»Ÿç»„ä»¶æä¾›çš„ C è¿è¡Œæ—¶åº“ã€‚å®ƒè§£å†³äº†ä»¥å¾€æ¯ä¸ª Visual Studio ç‰ˆæœ¬éƒ½éœ€è¦ç‹¬ç«‹ CRT çš„é—®é¢˜,å®ç°äº† CRT çš„å‘åå…¼å®¹å’Œå‘å‰å…¼å®¹ã€‚

**Q: å¦‚ä½•ç¡®å®šåº”è¯¥å¿½ç•¥å“ªäº› CRT åº“?**
A: æ ¹æ®é¡¹ç›®ä½¿ç”¨çš„è¿è¡Œæ—¶åº“ç±»å‹:
- ä½¿ç”¨ `/MD` æˆ– `/MDd`: å¿½ç•¥æ‰€æœ‰é™æ€ CRT (`libcmt.lib`, `libcmtd.lib`)
- ä½¿ç”¨ `/MT` æˆ– `/MTd`: å¿½ç•¥æ‰€æœ‰åŠ¨æ€ CRT (`msvcrt.lib`, `msvcrtd.lib`)
- ä½¿ç”¨ VS2015+: å¿½ç•¥æ—§ç‰ˆ CRT (`msvcrt.lib`, `msvcrtd.lib`)

### Q: libEGL/ANGLE ç›¸å…³é—®é¢˜

**Q: Win32 å¹³å°ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ ANGLE?**
A: Win32 å¹³å°åŸç”Ÿæ”¯æŒ OpenGL,ä¸éœ€è¦é€šè¿‡ ANGLE è½¬æ¢ã€‚ä½¿ç”¨åŸç”Ÿ OpenGL æ€§èƒ½æ›´å¥½,ä¸”ä¸éœ€è¦é¢å¤–çš„è½¬æ¢å±‚ã€‚

**Q: ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨ ANGLE?**
A: 
- WinRT/WP8 å¹³å°(ä¸æ”¯æŒåŸç”Ÿ OpenGL)
- éœ€è¦ä½¿ç”¨ OpenGL ES ç‰¹å®šåŠŸèƒ½çš„åœºæ™¯
- è·¨å¹³å°ç»Ÿä¸€ä½¿ç”¨ OpenGL ES API

**Q: å¦‚ä½•åˆ¤æ–­é¡¹ç›®æ˜¯å¦éœ€è¦ ANGLE?**
A: æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦ä½¿ç”¨äº† EGL/GLES API:
- å¦‚æœåªä½¿ç”¨ `#include "GL/glew.h"`,ä¸éœ€è¦ ANGLE
- å¦‚æœä½¿ç”¨ `#include <EGL/egl.h>`,éœ€è¦ ANGLE

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æœ€åæ›´æ–°**: 2025-10-12  
**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆ  
**åˆå¹¶æ¥æº**: 
- [toolchains/CEGUIæŠ€æœ¯é›†æˆæŒ‡å—.md](./toolchains/CEGUIæŠ€æœ¯é›†æˆæŒ‡å—.md)
- [CRTåº“å†²çªæ·±åº¦åˆ†æ.md](./CRTåº“å†²çªæ·±åº¦åˆ†æ.md)
- [libEGLé“¾æ¥é”™è¯¯ä¿®å¤è¯´æ˜.md](./libEGLé“¾æ¥é”™è¯¯ä¿®å¤è¯´æ˜.md)