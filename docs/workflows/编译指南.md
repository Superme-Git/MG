# MT3 项目编译完整指南

**文档版本**: 1.0
**最后更新**: 2025-10-12
**编译验证**: ✅ 所有组件编译成功

---

## 📋 目录

1. [编译概述](#编译概述)
2. [环境准备](#环境准备)
3. [项目依赖关系](#项目依赖关系)
4. [编译流程](#编译流程)
5. [常见问题解决](#常见问题解决)
6. [验证编译结果](#验证编译结果)

---

## 编译概述

### 编译目标

本指南将帮助您：
- ✅ 理解 MT3 项目的完整结构
- ✅ 掌握项目的编译流程
- ✅ 成功编译所有依赖库和主程序
- ✅ 为后续开发和升级做好准备

### 重要说明

⚠️ **关于运行版本的说明**:
- **v120 (VS2013) Debug 版本**: 原始版本，稳定可用 ✅
- **v140 (VS2015) Release 版本**: 编译成功但运行时崩溃 ⚠️

虽然 v140 编译的版本无法运行，但编译过程本身对学习项目结构和为未来升级做准备非常有价值。

---

## 环境准备

### 必需工具

| 工具 | 版本 | 下载地址 |
|------|------|---------|
| Visual Studio Build Tools | 2019 或更高 | [官方下载](https://visualstudio.microsoft.com/downloads/) |
| Windows SDK | 10.0 或更高 | 随 VS Build Tools 安装 |

### 必需组件

在 Visual Studio Installer 中安装以下组件：

1. **MSVC v140 - VS 2015 C++ 生成工具 (v14.00)**
2. **MSVC v120 - VS 2013 C++ 生成工具 (v12.00)** （可选，用于编译原始版本）
3. **Windows 10 SDK**
4. **MSBuild**

### 验证环境

运行以下命令验证 MSBuild 已正确安装：

```batch
"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin\MSBuild.exe" /version
```

应看到类似输出：
```
Microsoft (R) 生成引擎版本 16.x.x
```

---

## 项目依赖关系

### 依赖树

```
MT3.exe
├── FireClient.lib
│   ├── engine.lib
│   │   ├── libcocos2d.dll
│   │   │   └── 第三方库 (glew32, pthread, zlib, etc.)
│   │   ├── libCocosDenshion.dll
│   │   ├── platform.lib
│   │   ├── lua.lib
│   │   ├── cauthc.lib
│   │   └── ljfm.lib
│   │       └── platform.lib
│   ├── platform.lib
│   └── lua.lib
└── 运行时DLL (libcocos2d.dll, fmodex.dll, etc.)
```

### 核心组件说明

| 组件 | 说明 | 依赖 |
|------|------|------|
| **platform.lib** | 平台抽象层，提供跨平台功能 | 无 |
| **lua.lib** | Lua 5.1 脚本引擎 | 无 |
| **ljfm.lib** | 乐居文件管理，文件操作封装 | platform.lib |
| **cauthc.lib** | 客户端认证库 | 无 |
| **libcocos2d.dll** | Cocos2d-x 2.0 游戏引擎核心 | 第三方库 |
| **libCocosDenshion.dll** | Cocos2d-x 音频引擎 | libcocos2d.dll |
| **engine.lib** | 游戏引擎扩展层 | 所有上述组件 |
| **FireClient.lib** | 游戏逻辑核心 | engine.lib, platform.lib, lua.lib |
| **MT3.exe** | 主程序入口 | 所有上述组件 |

---

## 编译流程

### 方法 A: 一键编译（推荐）

#### 使用 v140 工具集

```batch
build_mt3_release_complete.bat
```

此脚本将自动编译所有组件，按正确的依赖顺序：

1. platform.lib
2. ljfm.lib
3. lua.lib
4. cauthc.lib
5. libcocos2d.dll
6. libCocosDenshion.dll
7. engine.lib
8. MT3.exe

**预计时间**: 20-30 分钟（首次完整编译）

#### 使用 v120 工具集

```powershell
powershell.exe -ExecutionPolicy Bypass -File build_v120_all.ps1
```

### 方法 B: 手动编译

如果需要单独编译某个组件，使用以下命令模板：

```batch
set MSBUILD="C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin\MSBuild.exe"

%MSBUILD% <项目文件路径> ^
  /t:Rebuild ^
  /p:Configuration=Release ^
  /p:Platform=Win32 ^
  /p:PlatformToolset=v140 ^
  /v:minimal ^
  /nologo ^
  /m
```

#### 具体编译命令

##### 1. 编译 platform.lib

```batch
%MSBUILD% common\platform\platform.editor.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `common\platform\Release.win32\platform.lib` (~4.8 MB)

##### 2. 编译 ljfm.lib

```batch
%MSBUILD% common\ljfm\ljfm.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `common\ljfm\Release.win32\ljfm.lib`

##### 3. 编译 lua.lib

```batch
%MSBUILD% common\lua\lua.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `common\lua\Release.win32\lua.lib`

##### 4. 编译 cauthc.lib

```batch
%MSBUILD% common\cauthc\projects\windows\cauthc.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `common\cauthc\projects\windows\Release.win32\cauthc.lib` (~23 MB)

##### 5. 编译 libcocos2d.dll

```batch
%MSBUILD% cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\cocos2d-win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\Release.win32\libcocos2d.dll` (~2.2 MB)

**重要**: 此步骤需要最多时间（3-5分钟），请耐心等待。

##### 6. 编译 libCocosDenshion.dll

```batch
%MSBUILD% cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\CocosDenshion.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\Release.win32\libCocosDenshion.dll` (~45 KB)

##### 7. 编译 engine.lib

```batch
%MSBUILD% engine\engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `engine\Release.win32\engine.lib` (~37 MB)

##### 8. 编译 MT3.exe

```batch
%MSBUILD% client\MT3Win32App\mt3.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /v:minimal /nologo /m
```

**输出**: `client\MT3Win32App\Release.win32\MT3.exe` (~8.4 MB)

##### 9. 复制运行时 DLL

```batch
copy_runtime_dlls.bat
```

此脚本会将所有必需的 DLL 文件复制到 MT3.exe 所在目录。

---

## 常见问题解决

### 问题 1: 找不到 MSBuild.exe

**错误信息**:
```
'MSBuild.exe' 不是内部或外部命令
```

**解决方案**:
1. 确保已安装 Visual Studio Build Tools 2019 或更高版本
2. 在脚本中使用完整路径：
   ```batch
   "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin\MSBuild.exe"
   ```

### 问题 2: 找不到平台工具集 v140

**错误信息**:
```
error MSB8020: 无法找到 v140 的生成工具（平台工具集 = 'v140'）
```

**解决方案**:
在 Visual Studio Installer 中安装 "MSVC v140 - VS 2015 C++ 生成工具 (v14.00)"

### 问题 3: 链接错误 - 找不到 .lib 文件

**错误信息**:
```
LINK : fatal error LNK1104: 无法打开文件 'platform.lib'
```

**解决方案**:
1. 检查是否按照正确的顺序编译了依赖库
2. 确保依赖库的输出目录存在
3. 检查项目文件中的库搜索路径

### 问题 4: IniFile 符号未定义

**错误信息**:
```
error LNK2001: 无法解析的外部符号 "public: static int __cdecl IniFile::read_profile_int"
```

**解决方案**:
此问题已在 `platform.editor.vcxproj` 中修复。确保使用最新的项目文件，其中包含 `IniFile.cpp` 和 `IniFile.h`。

### 问题 5: 编译后的 MT3.exe 崩溃

**现象**: v140 编译的 MT3.exe 在启动时崩溃

**原因**:
- v140 (VS2015) 和 v120 (VS2013) 二进制不兼容
- Release 优化可能破坏了某些代码逻辑
- 缺少必要的调试信息

**解决方案**:
使用原始的 v120 Debug 版本：
```batch
cd client\resource\bin\debug
MT3原始.exe
```

### 问题 6: 缺少 DLL 文件

**错误信息**:
```
找不到 libcocos2d.dll
找不到 fmodex.dll
```

**解决方案**:
运行 `copy_runtime_dlls.bat` 脚本，或手动复制以下 DLL 到 MT3.exe 所在目录：

1. libcocos2d.dll
2. libCocosDenshion.dll
3. glew32.dll
4. pthreadVCE2.dll
5. libcurl.dll
6. iconv.dll
7. libxml2.dll
8. zlib1.dll
9. fmodex.dll

---

## 验证编译结果

### 检查编译产物

运行以下命令验证所有库都已成功编译：

```batch
:: 检查核心库
dir common\platform\Release.win32\platform.lib
dir common\ljfm\Release.win32\ljfm.lib
dir common\lua\Release.win32\lua.lib
dir common\cauthc\projects\windows\Release.win32\cauthc.lib
dir engine\Release.win32\engine.lib

:: 检查 Cocos2d-x
dir cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\Release.win32\libcocos2d.dll
dir cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\Release.win32\libCocosDenshion.dll

:: 检查主程序
dir client\MT3Win32App\Release.win32\MT3.exe

:: 检查运行时 DLL
dir client\MT3Win32App\Release.win32\*.dll
```

### 预期文件大小

| 文件 | 预期大小 | 工具集 |
|------|---------|-------|
| platform.lib | ~4.8 MB | v140 |
| cauthc.lib | ~23 MB | v140 |
| engine.lib | ~37 MB | v140 |
| libcocos2d.dll | ~2.2 MB | v140 |
| libCocosDenshion.dll | ~45 KB | v140 |
| MT3.exe | ~8.4 MB | v140 Release |
| MT3原始.exe | ~23 MB | v120 Debug |

### 编译成功标志

如果看到以下输出，说明编译成功：

```
Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:XX:XX.XX
```

---

## 编译优化建议

### 首次完整编译
- 预计时间：20-30 分钟
- 使用 `/m` 参数启用多核编译
- 按依赖顺序编译所有组件

### 增量编译（修改代码后）
- 只重新编译修改的模块
- 不需要重新编译依赖库
- 节省时间：2-5 分钟

### 清理编译（遇到奇怪错误时）

删除所有中间文件并重新编译：

```batch
:: 删除所有 Release.win32 目录
for /d /r . %%d in (Release.win32) do @if exist "%%d" rd /s /q "%%d"

:: 重新完整编译
build_mt3_release_complete.bat
```

---

## 编译时间参考

| 组件 | 预计时间 |
|------|---------|
| platform.lib | 30-60 秒 |
| ljfm.lib | 20-30 秒 |
| lua.lib | 30-60 秒 |
| cauthc.lib | 1-2 分钟 |
| libcocos2d.dll | 3-5 分钟 |
| libCocosDenshion.dll | 30 秒 |
| engine.lib | 2-3 分钟 |
| MT3.exe | 1-2 分钟 |
| **总计** | **20-30 分钟** |

---

## 关键项目文件修改记录

编译过程中对以下项目文件进行了修改以解决编译问题：

### 1. common/platform/platform.editor.vcxproj

**修改**: 添加缺失的 IniFile.cpp 和 IniFile.h

```xml
<ItemGroup>
  <ClCompile Include="ini\IniFile.cpp" />
  <!-- ... -->
</ItemGroup>
<ItemGroup>
  <ClInclude Include="ini\IniFile.h" />
  <!-- ... -->
</ItemGroup>
```

### 2. client/MT3Win32App/mt3.win32.vcxproj

**修改**: 添加库搜索路径

```xml
<AdditionalLibraryDirectories>
  ../../cocos2d-2.0-rc2-x-2.0.1/cocos2dx/proj.win32/$(Configuration).win32;
  ../../cocos2d-2.0-rc2-x-2.0.1/CocosDenshion/proj.win32/$(Configuration).win32;
  ../../common/platform/$(Configuration).win32;
  ../../common/cauthc/projects/windows/$(Configuration).win32;
  ../../common/lua/$(Configuration).win32;
  ../../common/ljfm/$(Configuration).win32;
  ../../engine/$(Configuration).win32;
  %(AdditionalLibraryDirectories)
</AdditionalLibraryDirectories>
```

### 3. cocos2d-x 着色器日志增强

**修改**: 在 `CCGLProgram.cpp` 中添加了详细的着色器链接日志，帮助调试 v140 版本的运行时问题。

---

## 总结

完成本编译指南后，您将：

✅ 理解 MT3 项目的完整架构
✅ 掌握所有依赖库的编译方法
✅ 能够独立解决常见编译问题
✅ 为后续项目升级和开发打下基础

虽然 v140 编译的版本存在运行时问题，但编译过程本身极具学习价值，帮助您深入理解项目结构和 C++ 编译链接过程。

---

**下一步**: 查看 [快速启动指南.md](./快速启动指南.md) 了解如何运行游戏。

**相关文档**: [最终可用方案.md](./最终可用方案.md) - 详细的 v140 编译尝试总结和经验教训

---

**文档维护**: 如有问题或建议，请更新本文档。
**最后验证日期**: 2025-10-12
**验证人员**: Claude Code
