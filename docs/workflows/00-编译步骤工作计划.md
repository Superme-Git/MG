# MT3 编译步骤工作计划（v120 主线）
文档版本: 1.0
最后更新: 2025-10-14
适用工具集: VS2013 v120

说明：本计划作为可执行入口，串联编译前检查、全量构建、验证与故障排查。所有 v140 内容已归档于 [docs/archive/v140相关文档](../archive/v140相关文档:1)。

---

阶段门总览
- G0 前置检查
- G1 清理与同步
- G2 基础库构建
- G3 引擎层构建
- G4 应用层构建与运行时准备
- G5 验证与运行测试

重要交叉链接
- 编译完整流程详解：[docs/06-编译完整指南.md](../06-编译完整指南.md:1)
- 编译前检查清单：[docs/编译前检查清单.md](../编译前检查清单.md:1)（作为 G0 执行表）
- 文档索引（重建后）：[docs/13-文档索引.md](../13-文档索引.md:1)

---

G0 前置检查（必须全部通过后进入 G1）

环境检测（必做）：
- 执行脚本：`cmd /c "_v120_check\detect_v120_and_build.bat"`
- 结果判定：
  - 退出码 0：v120 工具集已成功激活并通过测试（可进入 G1）
  - 退出码 2：已激活新版工具集但未安装 v120 → 按 06-编译完整指南.md“附录A”安装 v120 后复验
  - 退出码 1：未找到 VS 工具集或编译失败 → 安装 VS 或修复环境后复验

清单（在纸面或本文件标记 ✓/✗）：
- ✓ Visual Studio 2013 v120 工具集可用（通过检测脚本或 cl、msbuild 命令验证）
- ✓ Windows SDK 8.1 已安装
- ✓ 项目根目录结构完整（client/、engine/、common/、cocos2d-2.0-rc2-x-2.0.1/）
- ✓ 可用磁盘空间 ≥ 10GB（推荐 ≥ 20GB）
- ✓ 运行时 DLL 清单已确认（libcocos2d.dll、libCocosDenshion.dll、glew32.dll、pthreadVCE2.dll、libcurl.dll、iconv.dll、libxml2.dll、zlib1.dll、fmodex.dll）

推荐命令：
- 环境检测：`cmd /c "_v120_check\detect_v120_and_build.bat"`
- 检查编译器：cl
- 检查 MSBuild：msbuild /version
- 检查 v120：dir "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC"
- 单模块试编：msbuild common\lua\lua.vcxproj /t:Build /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /nologo

若检测未通过（分支逻辑）：
- 安装 v120 工具集：参见 [docs/06-编译完整指南.md](../06-编译完整指南.md:1) 的“附录A”
- 复验：再次执行 `cmd /c "_v120_check\detect_v120_and_build.bat"`，直至返回码为 0
- 阻断生产编译：在未通过 G0 的情况下禁止进入 G1 及后续阶段

参考：[docs/编译前检查清单.md](../编译前检查清单.md:1)

---

G1 清理与同步
- 关闭所有 IDE/编辑器的占用（避免文件锁）
- 清理历史输出（可选）：
  - for /d /r . %%d in (Release.win32) do @if exist "%%d" rd /s /q "%%d"
- 同步依赖脚本与配置（如存在）：git pull 或手动更新

产出：干净工作区；可进入 G2

---

G2 基础库构建（可并行，但推荐按序执行以便日志追踪）

统一模板：
- set MSBUILD="C:\Program Files (x86)\MSBuild\12.0\Bin\MSBuild.exe"
- %MSBUILD% <项目> /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m

顺序与示例：
- platform.lib
  - %MSBUILD% common\platform\platform.editor.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
- ljfm.lib
  - %MSBUILD% common\ljfm\ljfm.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
- lua.lib
  - %MSBUILD% common\lua\lua.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
- cauthc.lib
  - %MSBUILD% common\cauthc\projects\windows\cauthc.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m

阶段门 G2 验收：
- 输出存在：common\platform\Release.win32\platform.lib
- 输出存在：common\ljfm\Release.win32\ljfm.lib
- 输出存在：common\lua\Release.win32\lua.lib
- 输出存在：common\cauthc\projects\windows\Release.win32\cauthc.lib

---

G3 引擎层构建（依赖 G2 完成）

顺序与示例：
- libcocos2d.dll
  - %MSBUILD% cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\cocos2d-win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
- libCocosDenshion.dll
  - %MSBUILD% cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\CocosDenshion.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
- engine.lib
  - %MSBUILD% engine\engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m

阶段门 G3 验收：
- 输出存在：cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\Release.win32\libcocos2d.dll
- 输出存在：cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\Release.win32\libCocosDenshion.dll
- 输出存在：engine\Release.win32\engine.lib

---

G4 应用层构建与运行时准备

顺序与示例：
- MT3.exe
  - %MSBUILD% client\MT3Win32App\mt3.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
- 复制运行时 DLL
  - copy_runtime_dlls.bat
- PostBuild 校验（如有）：复制至 client\resource\bin\Release

阶段门 G4 验收：
- 输出存在：client\MT3Win32App\Release.win32\MT3.exe
- 运行时 DLL 已就绪：client\MT3Win32App\Release.win32\*.dll 或 client\resource\bin\Release\*.dll

---

G5 验证与运行测试

验证命令示例：
- dir client\MT3Win32App\Release.win32\MT3.exe
- dir client\MT3Win32App\Release.win32\*.dll
- dir common\platform\Release.win32\platform.lib
- dir engine\Release.win32\engine.lib

运行测试：
- cd client\resource\bin\Release
- MT3.exe

成功标准：
- 编译输出完整且大小合理
- 程序启动无缺 DLL 提示
- 无致命崩溃（功能测试可另行开展）

---

故障快速决策树（摘要）
- 缺库/链接错误（LNK1104、LNK2001）：回到 G2/G3，核对产物与“附加库目录”
- 运行时缺 DLL：执行 copy_runtime_dlls.bat 或手动复制
- ABI/工具链错误：确保 PlatformToolset=v120，统一 /MD 或 /MDd，不忽略 msvcrt.lib
- 编译异常慢：确认 /m 开启，排除杀毒干扰，SSD 优先

详细排查参见：[docs/06-编译完整指南.md](../06-编译完整指南.md:1)

---

时间与产能参考（v120）
- 首次全量：20–30 分钟
- 引擎层（engine + cocos2d）：约 5–8 分钟
- 增量编译：2–5 分钟

---

产出与验收记录（建议表格）
- 编译起止时间：________
- 机器配置：CPU ______ / RAM ______ / SSD/HDD ______
- 产物尺寸核对：platform.lib ____ MB / engine.lib ____ MB / MT3.exe ____ MB
- 链接/引用自检：随机抽查 10 个链接 ✓
- 异常与修复记录：简述问题与解决

---

维护与后续
- 本计划与 [docs/06-编译完整指南.md](../06-编译完整指南.md:1)、[docs/编译前检查清单.md](../编译前检查清单.md:1) 同步维护
- 文档索引重建后统一入口：[docs/13-文档索引.md](../13-文档索引.md:1)
- 若需调研或升级 v140，请仅参考归档目录并避免污染主线

---

快速命令汇总（v120）
- msbuild common\lua\lua.vcxproj /t:Build /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /nologo
- msbuild engine\engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /m
- msbuild client\MT3Win32App\mt3.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /m

---

参考与致谢
- 主流程与排查依据： [docs/06-编译完整指南.md](../06-编译完整指南.md:1)
- 检查清单来源： [docs/编译前检查清单.md](../编译前检查清单.md:1) 与 [.claude/BUILD_CHECKLIST.md](.claude/BUILD_CHECKLIST.md:1)
- 历史探索与经验： 归档目录 [docs/archive/临时报告](../archive/临时报告:1)、[docs/archive/v140相关文档](../archive/v140相关文档:1)

维护说明：更新本计划时务必同步修正交叉引用与路径。