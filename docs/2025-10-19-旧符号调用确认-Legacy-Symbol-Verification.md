# 旧符号调用确认 Legacy Symbol Verification

## 1. 背景说明
- 当前 Lua 客户端脚本存在使用 `math.mod`、`table.getn` 等 Lua 5.1 中已标记为废弃的旧接口。
- 计划在重构过程中统一替换为 `math.fmod`、`#table` 等新版写法，以降低静态分析告警并兼容未来的 Lua 升级。
- 在替换前，需要确认是否有 **C++ 模块或第三方脚本** 通过绑定层直接调用旧符号，避免出现未预期的兼容性问题。

## 2. 交接目标
请 C++ 技术组协助确认以下事项，确保 API 替换不会影响现有客户端功能：
1. C++ 层是否通过 `lua_getglobal` / `lua_getfield` 等方式直接访问 `math.mod`、`table.getn` 或重定向到这些函数的自定义包装。
2. 是否有落地在客户端发布包中的第三方 Lua 模块（或热更脚本）依赖旧符号，并由 C++ 模块负责加载。
3. 若存在依赖，需要提供调用路径和版本范围，为脚本侧制定兼容方案（例如保留向后兼容别名）。

## 3. 需确认的符号列表
| 模块 | 旧符号 | 拟替换方案 | 备注 |
|------|--------|------------|------|
| `math` | `math.mod` | `math.fmod` | Lua 5.1 中 `math.mod` 指向 `math.fmod`；5.3 起被移除 |
| `table` | `table.getn` | `#tbl` 运算符 | 官方已建议改用长度运算符 |

> 若 C++ 层通过自定义库导出了同名函数，请一并告知。

## 4. 检查建议
1. **代码检索**  
   - 检查 C++ 工程中与 Lua 交互的文件（如 `lua_bindings`, `ScriptEngine`, `LuaHelper` 等）是否显式引用上述符号。
   - 搜索关键字：`"math.mod"`, `"table.getn"`, `"lua_getglobal(L, \"math\")"`, `"lua_getglobal(L, \"table\")"` 等。
2. **运行时验证**  
   - 在调试版客户端中启用 Lua API 访问日志（若有），确认是否存在 C++ 调用旧符号的记录。
   - 若无法直接观察，可在 Lua 层临时包裹旧函数：例如 `math.mod = function(...) LogDeprecated("math.mod"); return math.fmod(...) end`，观察是否被触发。

## 5. 输出期望
请 C++ 技术组在 2025-10-22（周三）前反馈以下内容：
- 是否检测到任何 C++ 或第三方脚本对旧符号的依赖；
- 如果有，列明模块、调用场景、是否可同步替换为新版函数；
- 若无依赖，请给出确认结论，方便脚本侧安排替换与回归测试。

## 6. 后续计划（脚本侧）
- 在获得确认后，我们将提交一个替换补丁，统一使用 `math.fmod` 与 `#tbl`。
- 替换完成后安排一次基础流程回归（登录、战斗、活动）与 Android/iOS 真机冒烟，确保行为一致。
- 若 C++ 反馈需保留旧符号，将讨论是否保留兼容别名或延迟改动。

## 7. 联系方式
- 脚本负责人：XXX（钉钉/IM：xxx）
- C++ 对接人：待指派（请确认）
- 如果需要开会讨论，请建议时间段，我们协调会议安排。
