# MT3 编译完整指南（v120 权威版）

文档版本: 1.0
最后更新: 2025-10-21
适用工具集: VS2013 v120（唯一支持版本）

---

## 编译概述

目标：统一 v120 工具链，按依赖顺序完成 MT3 全量编译，并提供可执行与可验证流程。

**重要声明**：MT3项目仅支持v120工具集（Visual Studio 2013），不支持v140（VS2015）及更高版本。v140编译会导致运行时崩溃，已确认不可用。**不支持Visual Studio 2015/2017/2019/2022及更高版本**。

---

## 环境准备

必需工具与组件：

- Visual Studio 2013（含 v120 工具集）- **唯一支持版本**
- Windows SDK 8.1（或 10.0），MSBuild 可用
- 命令行可执行：cl、msbuild

验证命令：

```batch
cl
msbuild /version
```

检查 v120 安装位置示例：

```batch
dir "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC"
```

---

## 项目依赖关系

```
MT3.exe
├── FireClient.lib
│   ├── engine.lib
│   │   ├── libcocos2d.dll
│   │   │   └── 第三方库 (glew32, pthread, zlib, etc.)
│   │   ├── libCocosDenshion.dll
│   │   ├── platform.lib
│   │   ├── lua.lib
│   │   ├── cauthc.lib
│   │   └── ljfm.lib
│   │       └── platform.lib
│   ├── platform.lib
│   └── lua.lib
└── 运行时DLL (libcocos2d.dll, fmodex.dll, etc.)
```

运行时库统一：

- Release：/MD（MultiThreadedDLL）
- Debug：/MDd（MultiThreadedDebugDLL）
- 字符集：Unicode

---

## 编译流程

### 方法 A：一键编译（推荐）

脚本入口（如存在以下脚本，优先使用）：

- [server/tools/exportdata/xgen.bat](server/tools/exportdata/xgen.bat:1)（示例，占位）
- [copy_runtime_dlls.bat](../../copy_runtime_dlls.bat)（运行时DLL复制）
- [build_mt3_v120_complete.bat](./编译前检查清单.md:416) 或 [Build-MT3-v120.ps1](./编译前检查清单.md:94)

示例（PowerShell）：

```powershell
powershell.exe -ExecutionPolicy Bypass -File Build-MT3-v120.ps1
```

示例（批处理）：

```batch
build_mt3_v120_complete.bat
```

该脚本应按依赖顺序编译：

1. platform.lib
2. ljfm.lib
3. lua.lib
4. cauthc.lib
5. libcocos2d.dll
6. libCocosDenshion.dll
7. engine.lib
8. MT3.exe

### 方法 B：手动编译（精确控制）

MSBuild 通用模板（v120）：

```batch
set MSBUILD="C:\Program Files (x86)\MSBuild\12.0\Bin\MSBuild.exe"

%MSBUILD% <项目文件> ^
  /t:Rebuild ^
  /p:Configuration=Release ^
  /p:Platform=Win32 ^
  /p:PlatformToolset=v120 ^
  /v:minimal ^
  /nologo ^
  /m
```

组件编译命令（按顺序执行）：

1) platform.lib

```batch
%MSBUILD% common\platform\platform.editor.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

2) ljfm.lib

```batch
%MSBUILD% common\ljfm\ljfm.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

3) lua.lib

```batch
%MSBUILD% common\lua\lua.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

4) cauthc.lib

```batch
%MSBUILD% common\cauthc\projects\windows\cauthc.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

5) libcocos2d.dll

```batch
%MSBUILD% cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\cocos2d-win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

6) libCocosDenshion.dll

```batch
%MSBUILD% cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\CocosDenshion.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

7) engine.lib

```batch
%MSBUILD% engine\engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

8) MT3.exe

```batch
%MSBUILD% client\MT3Win32App\mt3.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /v:minimal /nologo /m
```

9) 复制运行时 DLL

```batch
copy_runtime_dlls.bat
```

---

## 验证编译结果

快速验证（示例）：

```batch
dir common\platform\Release.win32\platform.lib
dir common\ljfm\Release.win32\ljfm.lib
dir common\lua\Release.win32\lua.lib
dir common\cauthc\projects\windows\Release.win32\cauthc.lib
dir engine\Release.win32\engine.lib
dir cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\Release.win32\libcocos2d.dll
dir cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\Release.win32\libCocosDenshion.dll
dir client\MT3Win32App\Release.win32\MT3.exe
dir client\MT3Win32App\Release.win32\*.dll
```

推荐文件大小（v120 近似参考）：

- platform.lib：~4–5 MB
- cauthc.lib：~20–24 MB
- engine.lib：~30–38 MB
- libcocos2d.dll：~2 MB
- libCocosDenshion.dll：~45 KB
- MT3.exe：~8–12 MB（Release）

---

## 常见问题解决

问题 1：找不到 MSBuild.exe

解决：确保安装 VS2013；脚本中使用完整路径。

问题 2：链接错误 LNK1104（无法打开 *.lib）

解决：检查依赖顺序与库输出目录，确认"附加库目录"配置正确。

问题 3：未解析的外部符号（LNK2001/LNK2019）

解决：统一运行时库为 /MD 或 /MDd；避免忽略 msvcrt.lib；核对 PCH 与编译选项一致。

问题 4：缺少运行时 DLL

解决：运行 [copy_runtime_dlls.bat](../../copy_runtime_dlls.bat) 或手动复制 9 个必需 DLL 到 MT3.exe 目录。

---

## 编译优化建议

首次完整编译：
- 使用 /m 启用多核；预计 20–30 分钟
- 优先完整编译后再增量迭代

增量编译：
- 仅重新编译修改模块；2–5 分钟

清理编译（遇到异常）：

```batch
for /d /r . %%d in (Release.win32) do @if exist "%%d" rd /s /q "%%d"
build_mt3_v120_complete.bat
```

---

## 关键项目文件修改记录（验证）

1. [common/platform/platform.editor.vcxproj](common/platform/platform.editor.vcxproj:1)
- 添加缺失的 IniFile.cpp / IniFile.h，保证 IniFile 符号链接正确。

2. [client/MT3Win32App/mt3.win32.vcxproj](client/MT3Win32App/mt3.win32.vcxproj:1)
- 补充"附加库目录"至各依赖输出目录（$(Configuration).win32）。

3. Cocos2d-x 着色器日志（可选）
- 如需调试运行时问题，可增强 CCGLProgram.cpp 的链接日志；不影响 v120 主线。

---

## 交叉引用与下一步

- 技术栈指引（统一入口）：[docs/MT3_技术栈指引.md](./MT3_技术栈指引.md:1)
- 入门运行：[docs/01-快速启动指南.md](./01-快速启动指南.md:1)
- 编译前检查：[docs/编译前检查清单.md](./编译前检查清单.md:1)
- 工作计划入口：[docs/00-编译步骤工作计划.md](./00-编译步骤工作计划.md:1)
- 文档总索引（13-新结构）：[docs/13-文档索引.md](./13-文档索引.md:1)
- 深度架构：[docs/04-架构深度分析.md](./04-架构深度分析.md:1)
- 技术体系总结：[docs/03-技术体系总结.md](./03-技术体系总结.md:1)
- 特殊技术专题（CRT/CEGUI/libEGL 等）：[docs/12-特殊技术专题.md](./12-特殊技术专题.md:1)

归档说明：
- v140（VS2015）及更高版本相关内容仅保留在 [docs/archive/v140相关文档](./archive/v140相关文档)，不作为主线编译参考。

---

## 附录：命令速查（v120）

```batch
msbuild common\lua\lua.vcxproj /t:Build /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /nologo
msbuild engine\engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v120 /m
```

成功标志（示例输出）：

```
Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:XX:XX.XX
```

---

## 附录A：v120 工具集安装指南

- 唯一方案：安装 Visual Studio 2013（含 v120 工具集）与 Windows SDK 8.1。

校验步骤（必须）：
```batch
cmd /c "_v120_check\detect_v120_and_build.bat"
```
结果判定：
- 退出码 0：已成功激活 v120 并编译运行测试程序。
- 退出码 2：已激活新版工具集但缺失 v120；需安装 v120 工具集，然后复验。
- 退出码 1：未找到 VS 工具集或编译失败；需安装 VS 或修复 VS 环境。

常见安装问题：
- 未找到 vswhere：安装 Visual Studio Installer（vswhere 随 VS Installer 安装）。
- 企业受限环境：线下下载安装包，按上述组件勾选离线安装。

---

## 附录B：环境检测脚本使用说明

脚本路径：
- `_v120_check\detect_v120_and_build.bat`

脚本行为：
- 优先检测 VS2013 经典 vcvars（vcvarsall.bat / vcvars32.bat）。
- 若未检测到，使用 vswhere 定位 VS2017/2019/2022 的 vcvarsall.bat，并尝试 `-vcvars_ver=12.0` 激活 v120。
- 成功激活后调用 cl 编译并运行 `_v120_check\test_v120.cpp` 进行验证。

退出码语义：
- 0：v120 工具集激活且编译运行通过。
- 2：工具集激活但未安装 v120；需安装 v120 后复验。
- 1：未找到 VS 工具集或编译失败。

手动调用示例（无需脚本）：
```batch
call "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\vcvarsall.bat" x86
cl /nologo /EHsc /MT _v120_check\test_v120.cpp /Fe:_v120_check\test_v120.exe
_e:\MT3\_v120_check\test_v120.exe
```

故障定位建议：
- 调用 vcvars 后执行 `where cl` 验证编译器可见。
- 若 vcvars 路径差异，直接修改脚本中的 VSWHERE 路径或 vcvars 路径后重试。

---

维护说明：如需更新本指南，请同步修正所有交叉引用（06、07、13、00 以及 .claude/RULES.md），并确保"附录A/B"与 `_v120_check\detect_v120_and_build.bat` 的行为一致。