# MT3 项目 VS2015 兼容性补丁说明

## 📌 问题概述

在使用 Visual Studio 2015 编译 MT3 项目(基于 Cocos2d-x 2.0.1)时,会遇到多个兼容性问题。本文档记录了所有必要的修复。

---

## 🔧 补丁列表

### 补丁 1: SimpleAudioEngine 头文件路径修复

**文件**: `client/MT3Win32App/SimpleAudioEngineAdapter.cpp`

**问题**: C1083 - 无法打开包括文件

**原始代码**:
```cpp
#include "CocosDenshion/Include/SimpleAudioEngine.h"
```

**修复后**:
```cpp
#include "SimpleAudioEngine.h"
```

**状态**: ✅ 已完成

---

### 补丁 2: pthread.h timespec 重定义修复

**文件**: `cocos2d-2.0-rc2-x-2.0.1/cocos2dx/platform/third_party/win32/pthread/pthread.h`

**问题**: C2011 - `timespec` 结构体重定义

**根本原因**:
- VS2015 在 `<time.h>` 中已经定义了 `struct timespec`
- pthread 库也定义了 `struct timespec`
- 导致重复定义冲突

**修复位置**: 第 305-317 行

**原始代码**:
```c
#ifndef HAVE_STRUCT_TIMESPEC
#define HAVE_STRUCT_TIMESPEC
struct timespec {
    long tv_sec;
    long tv_nsec;
};
#endif /* HAVE_STRUCT_TIMESPEC */
```

**修复后**:
```c
// 防止timespec结构体重复定义
// VS2015及以上版本在time.h中已经定义了timespec
// 需要检查多个可能已经定义timespec的宏
#ifndef HAVE_STRUCT_TIMESPEC
#if !defined(_TIMESPEC_DEFINED) && !defined(_INC_TIME) && !defined(TIMESPEC_DEFINED) && (_MSC_VER < 1900)
// VS2015之前的版本需要定义timespec
#define PTW32_TIMESPEC_DEFINED
#define HAVE_STRUCT_TIMESPEC 1
struct timespec {
	long tv_sec;
	long tv_nsec;
};
#endif /* VS2015之前的版本 */
#endif /* !HAVE_STRUCT_TIMESPEC */
```

**关键改动**:
1. 添加 `_MSC_VER < 1900` 检查(1900 = VS2015)
2. 添加额外的宏检查 `_TIMESPEC_DEFINED` 和 `TIMESPEC_DEFINED`
3. 只在 VS2015 之前的版本中定义 `timespec`

**状态**: ✅ 已完成

---

### 补丁 3: CRT 运行时库冲突修复

**文件**: `client/MT3Win32App/mt3.win32.vcxproj`

**问题**: LNK2005/LNK1169 - 多重定义符号,CRT 库冲突

**修复内容**:

**Debug 配置**:
```xml
<RuntimeLibrary>MultiThreadedDebugDLL</RuntimeLibrary>
<AdditionalDependencies>legacy_stdio_definitions.lib;%(AdditionalDependencies)</AdditionalDependencies>
<IgnoreSpecificDefaultLibraries>libcmtd.lib</IgnoreSpecificDefaultLibraries>
```

**Release 配置**:
```xml
<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>
<AdditionalDependencies>legacy_stdio_definitions.lib;%(AdditionalDependencies)</AdditionalDependencies>
<IgnoreSpecificDefaultLibraries>libcmt.lib</IgnoreSpecificDefaultLibraries>
```

**关键点**:
- 使用动态 CRT (`MultiThreadedDLL` / `MultiThreadedDebugDLL`)
- 链接 `legacy_stdio_definitions.lib` (VS2015 兼容库)
- 忽略静态 CRT 库(`libcmt.lib` / `libcmtd.lib`)

**状态**: ✅ 已完成

---

### 补丁 4: OpenGL 库依赖配置修复

**文件**: `client/MT3Win32App/mt3.win32.vcxproj`

**问题**: 误将移动平台专用 OpenGL ES 库引入 Win32 项目

**根本原因**:
- Win32 平台使用原生 OpenGL 实现，通过 GLEW 库进行扩展管理
- 移动平台(包括 WinRT、WP8、Tizen)使用 OpenGL ES 实现，依赖 EGL 进行窗口系统集成
- 当前配置错误地在 Win32 平台引入了移动平台专用的 `libEGL.lib` 和 `libGLESv2.lib`

**技术分析**:

**Win32 平台 OpenGL 实现**:
- 采用原生 OpenGL API
- 使用 `GL/glew.h` 头文件进行 OpenGL 扩展管理
- 链接 `opengl32.lib` 和 `glew32.lib` 等 Win32 平台专用库

**移动平台 OpenGL 实现**:
- 使用 OpenGL ES (OpenGL for Embedded Systems) API
- 依赖 EGL (Embedded-System Graphics Library) 进行窗口系统集成
- 对应库文件为 `libEGL.lib` 和 `libGLESv2.lib`

**修复内容**:

从 Win32 项目配置中移除以下移动平台专用库依赖:

**Debug 配置**:
```xml
<!-- 移除以下依赖 -->
libEGL.lib;
libGLESv2.lib;
```

**Release 配置**:
```xml
<!-- 移除以下依赖 -->
libEGL.lib;
libGLESv2.lib;
```

**关键改动**:
1. 移除 Win32 平台中多余的移动平台 OpenGL ES 库引用
2. 确保仅链接 Win32 平台所需的 OpenGL 相关库

**状态**: ✅ 已完成

---

## 🎯 编译顺序要求

由于依赖关系,必须按以下顺序编译:

1. **第一阶段**: 基础库
   - liblua
   - libBox2D
   - libchipmunk
   - pcre
   - SILLY
   - libspeex, libogg, libvorbis

2. **第二阶段**: ANGLE 组件
   - preprocessor
   - translator_common
   - translator_hlsl
   - esUtil

3. **第三阶段**: Cocos2d-x 核心
   - **libcocos2d** (依赖第一、二阶段)

4. **第四阶段**: 游戏框架库
   - cegui
   - platform
   - cauthc
   - ljfm

5. **第五阶段**: 游戏引擎
   - **engine** (依赖前四阶段)

6. **第六阶段**: 应用程序
   - FireClient
   - MT3

---

## 📝 应用补丁方法

### 方法 1: 手动应用(已完成)

所有补丁已经应用到代码库中,无需额外操作。

### 方法 2: 从备份恢复后重新应用

如果需要从备份恢复并重新应用补丁:

```powershell
# 1. SimpleAudioEngine 头文件修复
# 编辑 client/MT3Win32App/SimpleAudioEngineAdapter.cpp
# 将第 4 行改为: #include "SimpleAudioEngine.h"

# 2. pthread.h timespec 修复
# 编辑 cocos2d-2.0-rc2-x-2.0.1/cocos2dx/platform/third_party/win32/pthread/pthread.h
# 替换第 305-317 行为上述修复后代码

# 3. CRT 运行时库配置
# 编辑 client/MT3Win32App/mt3.win32.vcxproj
# 修改 RuntimeLibrary 和链接器设置

# 4. OpenGL 库依赖配置修复
# 编辑 client/MT3Win32App/mt3.win32.vcxproj
# 在 Debug 和 Release 配置中移除以下依赖项:
# libEGL.lib;
# libGLESv2.lib;
```

---

## ⚠️ 注意事项

### 1. 编译器版本限制

这些补丁专门针对 **Visual Studio 2015** (版本 14.0, `_MSC_VER = 1900`)。

如果使用其他版本:
- **VS2013 及更早**: 不需要 timespec 补丁
- **VS2017/2019/2022**: 可能需要额外的兼容性修复

### 2. 第三方库兼容性

所有依赖库(libcocos2d, engine, platform 等)必须使用相同版本的编译器重新编译。

**不能混用**:
- ❌ 主程序用 VS2015,库用 VS2010 编译
- ❌ 部分库用 VS2015,部分库用 VS2013 编译
- ✅ 所有组件统一使用 VS2015 编译

### 3. 运行时库依赖

编译后的程序需要以下运行时库:
- `MSVCP140.dll` (C++ 标准库)
- `VCRUNTIME140.dll` (C 运行时库)
- `ucrtbase.dll` (Universal CRT)

用户需要安装 **Visual C++ Redistributable for Visual Studio 2015**。

### 4. 调试版本注意事项

Debug 版本还需要:
- `MSVCP140D.dll`
- `VCRUNTIME140D.dll`
- `ucrtbased.dll`

这些文件不能单独分发,仅用于开发环境。

---

## 🧪 验证方法

### 验证补丁是否正确应用

```powershell
# 1. 检查 SimpleAudioEngineAdapter.cpp
$content = Get-Content "client\MT3Win32App\SimpleAudioEngineAdapter.cpp"
if ($content -match '#include "SimpleAudioEngine\.h"') {
    Write-Host "✓ 补丁 1 已应用" -ForegroundColor Green
} else {
    Write-Host "✗ 补丁 1 未应用" -ForegroundColor Red
}

# 2. 检查 pthread.h
$content = Get-Content "cocos2d-2.0-rc2-x-2.0.1\cocos2dx\platform\third_party\win32\pthread\pthread.h"
if ($content -match '_MSC_VER < 1900') {
    Write-Host "✓ 补丁 2 已应用" -ForegroundColor Green
} else {
    Write-Host "✗ 补丁 2 未应用" -ForegroundColor Red
}

# 3. 检查 mt3.win32.vcxproj
$content = Get-Content "client\MT3Win32App\mt3.win32.vcxproj"
if ($content -match 'legacy_stdio_definitions\.lib') {
    Write-Host "✓ 补丁 3 已应用" -ForegroundColor Green
} else {
    Write-Host "✗ 补丁 3 未应用" -ForegroundColor Red
}

# 4. 检查 OpenGL 库依赖配置
$content = Get-Content "client\MT3Win32App\mt3.win32.vcxproj"
if ($content -match 'libEGL\.lib|libGLESv2\.lib') {
    Write-Host "✗ 补丁 4 未应用: 仍包含移动平台 OpenGL 库" -ForegroundColor Red
} else {
    Write-Host "✓ 补丁 4 已应用" -ForegroundColor Green
}
```

### 验证编译成功

```powershell
# 检查关键库文件是否存在
$libs = @(
    "cocos2d-2.0-rc2-x-2.0.1\Release.win32\libcocos2d.lib",
    "engine\Release.win32\engine.lib",
    "client\FireClient\Release.win32\MT3.exe"
)

foreach ($lib in $libs) {
    if (Test-Path $lib) {
        $size = (Get-Item $lib).Length / 1MB
        Write-Host "✓ $lib ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
    } else {
        Write-Host "✗ 缺失: $lib" -ForegroundColor Red
    }
}
```

---

## 📚 相关文档

- [MT3项目编译问题分析与解决方案.md](MT3项目编译问题分析与解决方案.md) - 完整的技术分析
- [MT3编译快速指南.md](MT3编译快速指南.md) - 快速参考指南

---

## 🔗 参考链接

### Visual Studio 2015 相关

- [Visual C++ Redistributable for Visual Studio 2015](https://www.microsoft.com/zh-cn/download/details.aspx?id=48145)
- [Universal CRT (UCRT) 介绍](https://docs.microsoft.com/zh-cn/cpp/porting/upgrade-your-code-to-the-universal-crt)
- [VS2015 新特性](https://docs.microsoft.com/zh-cn/visualstudio/releasenotes/vs2015-version-history)

### Cocos2d-x 相关

- [Cocos2d-x 2.0.1 官方文档](https://docs.cocos2d-x.org/cocos2d-x/v2/en/)
- [pthread-win32 项目](https://sourceware.org/pthreads-win32/)

### C/C++ 标准库

- [timespec 结构体定义](https://en.cppreference.com/w/c/chrono/timespec)
- [MSVC 预定义宏](https://docs.microsoft.com/zh-cn/cpp/preprocessor/predefined-macros)

---

## 📊 补丁历史

| 日期 | 补丁编号 | 描述 | 状态 |
|------|----------|------|------|
| 2025-10-11 | Patch-001 | SimpleAudioEngine 头文件路径修复 | ✅ 已应用 |
| 2025-10-11 | Patch-002 | pthread.h timespec 重定义修复 | ✅ 已应用 |
| 2025-10-11 | Patch-003 | CRT 运行时库冲突修复 | ✅ 已应用 |
| 2025-10-11 | Patch-004 | OpenGL 库依赖配置修复 | ✅ 已应用 |

---

## 💡 故障排除

### 问题 1: 仍然出现 timespec 重定义错误

**可能原因**:
- 补丁未正确应用
- 文件被其他工具覆盖

**解决方法**:
```powershell
# 重新检查文件内容
Get-Content "cocos2d-2.0-rc2-x-2.0.1\cocos2dx\platform\third_party\win32\pthread\pthread.h" | Select-Object -Skip 304 -First 20
```

确认包含 `_MSC_VER < 1900` 检查。

### 问题 2: LNK2005 错误仍然存在

**可能原因**:
- 依赖库未重新编译
- 混用了不同版本的库

**解决方法**:
```powershell
# 清理所有旧的库文件
Remove-Item -Recurse -Force "cocos2d-2.0-rc2-x-2.0.1\Release.win32"
Remove-Item -Recurse -Force "engine\Release.win32"
# ... 清理其他库目录

# 重新编译所有库
.\build_all_dependencies.ps1
```

### 问题 3: 运行时缺少 DLL

**解决方法**:
1. 下载并安装 VC++ 2015 Redistributable
2. 或将以下 DLL 复制到程序目录:
   - `MSVCP140.dll`
   - `VCRUNTIME140.dll`
   - `ucrtbase.dll`

这些文件位于:
```
C:\Windows\System32\  (64位系统)
C:\Windows\SysWOW64\ (32位程序在64位系统上)
```

---

**文档版本**: 1.0  
**最后更新**: 2025-10-11  
**维护者**: MT3 项目团队  
**适用版本**: Visual Studio 2015 (14.0)