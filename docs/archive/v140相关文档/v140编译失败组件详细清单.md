# MT3项目 v140编译失败组件详细清单

**日期**: 2025-10-13
**工具集**: v140 (VS2015)
**配置**: Release | Win32

---

## 📊 编译结果总览

```
总组件数: 9个
编译成功: 6个 (67%)
编译失败: 3个 (33%)
```

---

## ❌ 编译失败的组件

### 1. **ljfm.lib** (Layer 1 - 基础库)

**项目路径**: `common\ljfm\ljfm.vcxproj`

**失败原因**: 缺少源文件

**错误信息**:
```
c1 : fatal error C1083: 无法打开源文件: "pfs\contrib\encode\crc32.c": No such file or directory
c1 : fatal error C1083: 无法打开源文件: "pfs\contrib\encode\md5.c": No such file or directory
```

**详细分析**:
- ljfm库依赖pfs (Packed File System)
- pfs相关的源文件缺失:
  - `pfs\contrib\encode\crc32.c`
  - `pfs\contrib\encode\md5.c`
  - 可能还有其他pfs相关文件

**解决方案**:
1. 从原始项目源码中找到完整的pfs源文件
2. 或者从备份中恢复这些文件
3. 或者使用预编译的ljfm.lib (v120版本)

**影响**:
- ⚠️ 中等影响
- ljfm是文件管理库,被engine.lib和MT3.exe依赖
- 如果使用v120预编译的ljfm.lib,可能导致运行时冲突

---

### 2. **lua.lib** (Layer 1 - 基础库)

**项目路径**: `common\lua\lua.vcxproj`

**失败原因**: 预编译头(PCH)版本不匹配

**错误信息**:
```
..\..\cocos2d-2.0-rc2-x-2.0.1\lua\tolua\tolua_map.c : fatal error C1853:
"Release\lua.pch"预编译头文件来自编译器的早期版本，或者预编译头为 C++ 而在 C 中使用它(或相反)

..\..\cocos2d-2.0-rc2-x-2.0.1\lua\tolua\tolua_to.c : fatal error C1853:
"Release\lua.pch"预编译头文件来自编译器的早期版本，或者预编译头为 C++ 而在 C 中使用它(或相反)
```

**详细分析**:
- lua项目混合了C和C++文件
- tolua相关的.c文件与C++的预编译头不兼容
- PCH在v140下的处理与v120不同

**可能的C文件**:
```
cocos2d-2.0-rc2-x-2.0.1\lua\tolua\tolua_map.c
cocos2d-2.0-rc2-x-2.0.1\lua\tolua\tolua_to.c
cocos2d-2.0-rc2-x-2.0.1\lua\tolua\tolua_push.c
cocos2d-2.0-rc2-x-2.0.1\lua\tolua\tolua_is.c
cocos2d-2.0-rc2-x-2.0.1\lua\tolua\tolua_event.c
...
```

**解决方案**:
1. **方案A**: 禁用预编译头
   ```xml
   <PrecompiledHeader>NotUsing</PrecompiledHeader>
   ```

2. **方案B**: 为C文件单独配置
   ```xml
   <!-- 对tolua/*.c文件禁用PCH -->
   <ItemDefinitionGroup>
     <ClCompile Condition="'%(Extension)'=='.c'">
       <PrecompiledHeader>NotUsing</PrecompiledHeader>
     </ClCompile>
   </ItemDefinitionGroup>
   ```

3. **方案C**: 使用v120预编译的lua.lib

**影响**:
- 🔴 高影响
- lua是脚本引擎核心,被libcocos2d和engine大量使用
- 必须解决,否则影响整个游戏逻辑

---

### 3. **MT3.exe** (Layer 4 - 应用程序)

**项目路径**: `client\MT3Win32App\mt3.win32.vcxproj`

**失败原因**: v120预编译第三方库与v140运行时冲突

**错误信息** (部分):
```
libpng.lib(pngerror.obj) : warning LNK4049: 已导入本地定义的符号 ___iob_func
libpng.lib(pngerror.obj) : warning LNK4049: 已导入本地定义的符号 _fprintf

ucrt.lib(api-ms-win-crt-runtime-l1-1-0.dll) : error LNK2005:
__crt_debugger_hook 已经在 MSVCRT.lib(utility_desktop.obj) 中定义

freetype.lib(type1cid.obj) : error LNK2001: 无法解析的外部符号 __imp__atol
freetype.lib(type42.obj) : error LNK2001: 无法解析的外部符号 __imp__atol

MT3.exe : fatal error LNK1120: 172 个无法解析的外部命令
```

**涉及的v120预编译第三方库**:
```
1.  libpng.lib           - PNG图像库
2.  libjpeg.lib          - JPEG图像库
3.  libtiff.lib          - TIFF图像库
4.  freetype.lib         - 字体渲染库
5.  zlib.lib             - 压缩库
6.  cegui.lib            - GUI库
7.  pcre.lib             - 正则表达式库
8.  silly.lib            - 图像加载库
9.  libspeex.lib         - 语音编解码库
10. libogg.lib           - Ogg容器库
11. libvorbis.lib        - Vorbis音频编解码库
12. esUtil.lib           - OpenGL ES工具库
13. libSpine.lib         - 骨骼动画库
14. libcurl_imp.lib      - HTTP库
15. pthreadVCE2.lib      - POSIX线程库
```

**冲突机制详解**:

#### A. CRT符号重定义冲突
```
v140编译的代码:
├─ 链接到 vcruntime140.dll (新的运行时)
└─ 使用 Universal CRT (ucrtbase.dll)

v120预编译库:
├─ 链接到 msvcr120.dll (旧的运行时)
└─ 使用传统CRT

结果: __crt_debugger_hook, _fprintf 等符号在两个CRT中都定义
```

#### B. 未解析的外部符号
```
v120库期望的符号:
__imp__atol    (导入函数,来自msvcr120.dll)
__imp__fprintf (导入函数,来自msvcr120.dll)
___iob_func    (FILE结构,来自msvcr120.dll)

v140运行时提供的符号:
这些符号在v140中位置改变或重命名
例如: ___iob_func 在v140中不存在,被 __acrt_iob_func 替代
```

#### C. Universal CRT引入的问题
```
VS2015引入Universal CRT:
旧: msvcr120.dll (单一CRT)
新: vcruntime140.dll + ucrtbase.dll + api-ms-win-crt-*.dll (分层CRT)

这是根本性的架构变化,v120库无法理解
```

**详细的未解析符号示例**:
```
__imp__atol           - 字符串转长整型
__imp__atoi           - 字符串转整型
__imp__fprintf        - 格式化输出
__imp__fopen          - 文件打开
__imp__fclose         - 文件关闭
__imp__fread          - 文件读取
__imp__fwrite         - 文件写入
___iob_func           - 标准IO流(stdin/stdout/stderr)
__imp__malloc         - 内存分配
__imp__free           - 内存释放
__imp__memcpy         - 内存复制
__imp__strcmp         - 字符串比较
... (共172个未解析符号)
```

**解决方案**:

#### 方案1: 使用v120工具集 (推荐)
```xml
<PlatformToolset>v120</PlatformToolset>
```
✅ 优点: 完全兼容所有预编译库
❌ 缺点: 需要安装VS2013

#### 方案2: 重新编译所有第三方库为v140
**需要从源码编译**:
```
1.  libpng         -> 从 libpng-1.6.x 源码编译
2.  libjpeg        -> 从 libjpeg-turbo 源码编译
3.  libtiff        -> 从 libtiff-4.x 源码编译
4.  freetype       -> 从 freetype-2.x 源码编译
5.  zlib           -> 从 zlib-1.2.x 源码编译
6.  cegui          -> 从 CEGUI-0.7.x 源码编译
7.  pcre           -> 从 pcre-8.x 源码编译
8.  silly          -> 从 SILLY 源码编译
9.  libspeex       -> 从 speex-1.2 源码编译
10. libogg         -> 从 libogg-1.3.x 源码编译
11. libvorbis      -> 从 libvorbis-1.3.x 源码编译
12. esUtil         -> 需要找到源码
13. libSpine       -> 从 spine-runtime 源码编译
14. libcurl        -> 从 curl-7.x 源码编译
15. pthreadVCE2    -> 从 pthreads-w32 源码编译
```

**工作量估算**: 2-5天
- 获取所有源码: 0.5天
- 配置v140编译: 1-2天
- 解决编译问题: 1-2天
- 测试验证: 0.5天

#### 方案3: 使用vcpkg (现代化方案)
```batch
vcpkg install libpng:x86-windows
vcpkg install libjpeg-turbo:x86-windows
vcpkg install freetype:x86-windows
vcpkg install zlib:x86-windows
...
```
✅ 优点: 自动管理依赖和版本
❌ 缺点: 需要调整项目配置

#### 方案4: 使用兼容层 (实验性,不推荐)
创建包装函数处理v120/v140差异:
```cpp
// crt_wrapper.cpp
extern "C" {
    // 包装 ___iob_func
    FILE* __cdecl __iob_func_compat() {
        return __acrt_iob_func(0);
    }

    // 更多包装函数...
}
```
⚠️ 风险高,不推荐生产使用

**影响**:
- 🔴 严重影响
- 这是最终的可执行文件,无法链接就无法生成
- 必须解决才能完成v140编译

---

## 📊 失败组件依赖关系分析

```
MT3.exe (失败)
├─ FireClient.lib (成功)
├─ engine.lib (成功)
│  ├─ platform.lib (成功)
│  ├─ ljfm.lib (失败 - 缺文件)
│  └─ libcocos2d.dll (成功)
│     └─ lua.lib (失败 - PCH问题)
├─ libCocosDenshion.dll (成功)
└─ 第三方库 (全部v120预编译,冲突)
   ├─ libpng.lib (v120)
   ├─ libjpeg.lib (v120)
   ├─ freetype.lib (v120)
   └─ ... (12个更多v120库)
```

**关键依赖链**:
- MT3.exe 无法链接 → 因为第三方库冲突
- engine.lib 可能运行异常 → 因为依赖失败的ljfm.lib和lua.lib
- libcocos2d.dll 可能不完整 → 因为依赖失败的lua.lib

---

## 🎯 优先级修复建议

### 高优先级 (必须修复)

1. **lua.lib** - 禁用PCH或调整配置
   - 难度: ⭐⭐
   - 工作量: 0.5-1小时
   - 影响: 非常大

2. **MT3.exe第三方库** - 选择一个方案执行
   - 难度: ⭐⭐⭐⭐⭐
   - 工作量: 2-5天
   - 影响: 决定性

### 中优先级 (建议修复)

3. **ljfm.lib** - 找到缺失的pfs源文件
   - 难度: ⭐⭐⭐
   - 工作量: 2-4小时
   - 影响: 中等

---

## 💡 实际可行方案

### **推荐: 保持v120 Debug版本**

```batch
使用原始版本:
client\resource\bin\debug\MT3原始.exe (23MB)

理由:
✅ 完全稳定运行
✅ 所有功能正常
✅ 无需任何修改
✅ 立即可用

缺点:
❌ Debug性能较低
❌ 文件较大
```

### **如果坚持v140**

**短期方案** (1-2天):
1. 修复lua.lib的PCH问题
2. 尝试找到ljfm.lib的源文件
3. 使用vcpkg重新编译关键第三方库(libpng, libjpeg, freetype)
4. 其他库暂时使用v120预编译版,接受潜在风险

**长期方案** (1-2周):
1. 升级到Cocos2d-x 3.x或4.x
2. 使用vcpkg管理所有第三方库
3. 完全迁移到v140/v141 (VS2017)

---

## 📝 总结

### 编译失败的3个组件

| # | 组件 | 失败原因 | 难度 | 是否可修复 |
|---|------|---------|------|----------|
| 1 | ljfm.lib | 缺少源文件 | ⭐⭐⭐ | ✅ 可能 |
| 2 | lua.lib | PCH问题 | ⭐⭐ | ✅ 是 |
| 3 | MT3.exe | 第三方库冲突 | ⭐⭐⭐⭐⭐ | ⚠️ 工作量大 |

### 根本原因

**不是配置问题,是历史遗留问题**:
- 项目创建于2013-2016年
- 使用v120 (VS2013)工具集
- 依赖大量v120预编译第三方库
- v140 (VS2015)引入Universal CRT,打破兼容性

### 最终建议

**学习目标已达成** ✅
- 理解了项目结构
- 掌握了编译流程
- 发现了真正问题

**生产使用建议**:
- 使用v120 Debug原始版本 (立即可用)
- 或投入时间完全迁移到v140 (2-5天)
- 或升级到Cocos2d-x 3.x+ (1-2周)

---

**创建时间**: 2025-10-13
**状态**: ✅ 完整分析完成
