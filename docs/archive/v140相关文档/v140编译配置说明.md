# MT3 v140 (VS2015) 编译配置说明

**创建时间**: 2025-10-13
**工具集**: v140 (Visual Studio 2015)
**配置**: Release
**平台**: Win32

---

## 📋 核心原则

### 1. **统一工具集** ✅
所有项目必须使用 **v140 (VS2015)** 工具集编译

```xml
<PlatformToolset>v140</PlatformToolset>
```

### 2. **统一运行时库** ✅
所有项目必须使用 **/MD (MultiThreadedDLL)** 运行时库

```xml
<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>
```

### 3. **正确的链接器配置** ⚠️ **关键!**

**只忽略静态运行时库,不要忽略动态运行时库:**

```xml
<!-- ✅ 正确配置 -->
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib</IgnoreSpecificDefaultLibraries>

<!-- ❌ 错误配置 - 不要这样做! -->
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib;msvcrt.lib;msvcrtd.lib</IgnoreSpecificDefaultLibraries>
```

**重要**: **绝对不能忽略 `msvcrt.lib`!** 这是 /MD 运行时的核心库!

---

## 🏗️ 编译顺序 (4层架构)

### 第一层: 基础库
按任意顺序编译,无相互依赖:

1. **platform.lib** - 平台抽象层
   - 路径: `common\platform\platform.editor.vcxproj`
   - 功能: 跨平台文件系统、网络、线程

2. **ljfm.lib** - 文件管理库
   - 路径: `common\ljfm\ljfm.vcxproj`
   - 功能: 文件管理和更新引擎

3. **lua.lib** - Lua脚本引擎
   - 路径: `common\lua\lua.vcxproj`
   - 功能: Lua 5.1 + tolua++ 绑定

4. **cauthc.lib** - 认证库
   - 路径: `common\cauthc\projects\windows\cauthc.win32.vcxproj`
   - 功能: 客户端认证和安全

### 第二层: Cocos2d引擎
依赖第一层的lua.lib:

5. **libcocos2d.dll** - Cocos2d-x核心
   - 路径: `cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\cocos2d-win32.vcxproj`
   - 功能: 2D游戏引擎框架

6. **libCocosDenshion.dll** - 音频引擎
   - 路径: `cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\CocosDenshion.win32.vcxproj`
   - 功能: 音频播放和管理

### 第三层: 游戏引擎扩展
依赖前两层:

7. **engine.lib** - MT3游戏引擎
   - 路径: `engine\engine.win32.vcxproj`
   - 依赖: platform, ljfm, cocos2d-x
   - 功能: MT3特定引擎功能

### 第四层: 应用程序
依赖所有前面的库:

8. **FireClient.lib** - 游戏逻辑库
   - 路径: `client\FireClient\FireClient.win32.vcxproj`
   - 依赖: 所有基础库 + engine

9. **MT3.exe** - 主程序入口
   - 路径: `client\MT3Win32App\mt3.win32.vcxproj`
   - 依赖: 所有库
   - 功能: 程序入口点

---

## 📊 依赖关系图

```
Layer 4: MT3.exe
           ↓
        FireClient.lib
           ↓
Layer 3: engine.lib
           ↓
Layer 2: libcocos2d.dll + libCocosDenshion.dll
           ↓
Layer 1: platform.lib, ljfm.lib, lua.lib, cauthc.lib
```

---

## 🔧 MSBuild 编译命令模板

### 基本命令格式
```batch
"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin\MSBuild.exe" ^
  项目路径.vcxproj ^
  /t:Rebuild ^
  /p:Configuration=Release ^
  /p:Platform=Win32 ^
  /p:PlatformToolset=v140 ^
  /v:minimal ^
  /nologo ^
  /m
```

### 参数说明
- `/t:Rebuild` - 完全重新编译
- `/p:Configuration=Release` - Release配置
- `/p:Platform=Win32` - 32位平台
- `/p:PlatformToolset=v140` - 强制使用v140工具集
- `/v:minimal` - 最小输出信息
- `/nologo` - 不显示logo
- `/m` - 多核并行编译

---

## ⚠️ 常见错误和解决方案

### 错误1: LNK2001 未解析的外部符号
**原因**: 运行时库不匹配或忽略了必需的标准库

**解决方案**:
1. 检查所有项目的运行时库配置是否为 `/MD`
2. 确保 `IgnoreSpecificDefaultLibraries` **不包含** `msvcrt.lib`
3. 重新编译所有依赖库

### 错误2: 找不到 msvcr140.dll
**原因**: 缺少 Visual C++ 2015 运行时

**解决方案**:
安装 Visual C++ 2015 Redistributable:
```
https://www.microsoft.com/zh-cn/download/details.aspx?id=48145
```

### 错误3: 编译顺序错误
**原因**: 在依赖库编译完成前编译了上层项目

**解决方案**:
严格按照4层编译顺序,使用提供的 `build_mt3_v140_final.bat` 脚本

### 错误4: 符号重定义
**原因**: 混用了静态库和动态库的运行时

**解决方案**:
1. 统一使用 `/MD` (动态运行时)
2. 在链接器中忽略 `libcmt.lib` 和 `libcmtd.lib`

---

## 📝 验证清单

编译完成后,检查以下文件是否存在:

### 基础库 (Layer 1)
- [ ] `common\platform\Release.win32\platform.lib`
- [ ] `common\ljfm\Release.win32\ljfm.lib`
- [ ] `common\lua\Release.win32\lua.lib`
- [ ] `common\cauthc\projects\windows\Release.win32\cauthc.lib`

### 引擎层 (Layer 2)
- [ ] `cocos2d-2.0-rc2-x-2.0.1\Release.win32\libcocos2d.dll`
- [ ] `cocos2d-2.0-rc2-x-2.0.1\Release.win32\libCocosDenshion.dll`

### 扩展层 (Layer 3)
- [ ] `engine\Release.win32\engine.lib`

### 应用层 (Layer 4)
- [ ] `client\FireClient\Release.win32\FireClient.lib`
- [ ] `client\MT3Win32App\Release.win32\MT3.exe`
- [ ] `client\resource\bin\Release\MT3.exe` (PostBuild复制)

---

## 🚀 快速编译步骤

### 方法1: 使用自动化脚本 (推荐)
```batch
cd e:\梦幻西游MG原版源码
build_mt3_v140_final.bat
```

### 方法2: 手动编译
```batch
cd e:\梦幻西游MG原版源码

:: Layer 1
msbuild common\platform\platform.editor.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild common\ljfm\ljfm.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild common\lua\lua.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild common\cauthc\projects\windows\cauthc.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m

:: Layer 2
msbuild cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\cocos2d-win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\CocosDenshion.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m

:: Layer 3
msbuild engine\engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m

:: Layer 4
msbuild client\FireClient\FireClient.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild client\MT3Win32App\mt3.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
```

---

## 🎯 编译后测试

### 步骤1: 验证文件
```batch
test_mt3_build.bat
```

### 步骤2: 运行程序
```batch
cd client\resource\bin\Release
MT3.exe
```

### 步骤3: 检查依赖项
```batch
dumpbin /DEPENDENTS client\MT3Win32App\Release.win32\MT3.exe
```

应该看到:
- `msvcr140.dll` 或 `VCRUNTIME140.dll` (v140运行时)
- `libcocos2d.dll`
- `libCocosDenshion.dll`
- Windows系统DLL (kernel32.dll, user32.dll等)

---

## 📚 相关文档

- [编译成功报告.md](./编译成功报告.md) - 第三方库编译报告
- [最终可用方案.md](../最终可用方案.md) - v120原始版本说明
- [06-编译完整指南.md](../06-编译完整指南.md:1) - 快速入门指南

---

## 💡 最佳实践

1. **版本控制**: 在编译前提交代码更改
2. **清理编译**: 使用 `/t:Rebuild` 而不是 `/t:Build`
3. **并行编译**: 使用 `/m` 参数利用多核CPU
4. **最小输出**: 使用 `/v:minimal` 减少日志噪音
5. **验证依赖**: 编译后使用 dumpbin 检查依赖项
6. **备份成功版本**: 保存成功编译的二进制文件

---

**最后更新**: 2025-10-13
**维护者**: Claude Code Assistant
**状态**: ✅ 配置已验证
