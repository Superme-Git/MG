# MT3项目 v140 完整编译执行说明

**日期**: 2025-10-13
**目标**: 使用v140工具集完成MT3.exe的完整编译和验证

---

## 📋 执行概述

本次任务遵循以下核心原则:

1. ✅ **统一的平台工具集**: 所有库使用 v140 (VS2015) 编译
2. ✅ **统一的运行时库**: 所有库使用 `/MD` (MultiThreadedDLL)
3. ✅ **分析整理编译顺序**: 按照4层依赖架构顺序编译
4. ⚠️ **不可以忽略标准库**: **绝对不忽略 msvcrt.lib**

---

## 🏗️ 编译架构 (4层依赖结构)

```
┌─────────────────────────────────────────┐
│  Layer 4: 应用程序层                      │
│  - FireClient.lib (游戏逻辑)             │
│  - MT3.exe (主程序)                      │
└─────────────────────────────────────────┘
              ↑ 依赖
┌─────────────────────────────────────────┐
│  Layer 3: 游戏引擎扩展层                  │
│  - engine.lib (MT3引擎扩展)              │
└─────────────────────────────────────────┘
              ↑ 依赖
┌─────────────────────────────────────────┐
│  Layer 2: Cocos2d引擎层                  │
│  - libcocos2d.dll (2D引擎)              │
│  - libCocosDenshion.dll (音频)          │
└─────────────────────────────────────────┘
              ↑ 依赖
┌─────────────────────────────────────────┐
│  Layer 1: 基础库层 (无相互依赖)            │
│  - platform.lib (平台抽象)               │
│  - ljfm.lib (文件管理)                   │
│  - lua.lib (脚本引擎)                    │
│  - cauthc.lib (认证库)                   │
└─────────────────────────────────────────┘
```

---

## 📝 已创建的脚本文件

### 1. 主编译脚本
**文件**: `build_mt3_v140_final.bat`

**功能**:
- 按正确顺序编译所有9个组件
- 自动验证编译结果
- 显示文件大小和状态
- 复制运行时DLL到bin目录

**使用方法**:
```batch
cd e:\梦幻西游MG原版源码
build_mt3_v140_final.bat
```

### 2. 测试验证脚本
**文件**: `test_mt3_build.bat`

**功能**:
- 检查所有编译输出文件
- 使用dumpbin分析依赖项
- 验证运行时库链接
- 复制文件到运行目录
- 计算MD5校验和

**使用方法**:
```batch
cd e:\梦幻西游MG原版源码
test_mt3_build.bat
```

### 3. 配置文档
**文件**: `doc\v140编译配置说明.md`

**内容**:
- 核心编译原则
- 详细的编译顺序
- MSBuild命令模板
- 常见错误解决方案
- 验证清单

---

## 🔑 关键配置要点

### 1. 不忽略标准库 (最重要!)

**正确配置** ✅:
```xml
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib</IgnoreSpecificDefaultLibraries>
```

**错误配置** ❌:
```xml
<!-- 千万不要这样! -->
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib;msvcrt.lib</IgnoreSpecificDefaultLibraries>
```

**原因**:
- `msvcrt.lib` 是 `/MD` 运行时的**核心库**
- 忽略它会导致数千个链接错误 (LNK2001)
- 只应该忽略**静态**运行时库 (libcmt.lib, libcmtd.lib)

### 2. 统一运行时库

所有项目必须使用:
```xml
<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>  <!-- Release -->
<RuntimeLibrary>MultiThreadedDebugDLL</RuntimeLibrary>  <!-- Debug -->
```

### 3. 统一平台工具集

所有项目必须使用:
```xml
<PlatformToolset>v140</PlatformToolset>
```

---

## 📊 编译顺序详解

### 第一层: 基础库 (可并行)
1. **platform.lib** - 1.5 MB
   ```batch
   msbuild common\platform\platform.editor.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

2. **ljfm.lib** - 1.3 MB
   ```batch
   msbuild common\ljfm\ljfm.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

3. **lua.lib** - 4.1 MB
   ```batch
   msbuild common\lua\lua.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

4. **cauthc.lib** - 23 MB
   ```batch
   msbuild common\cauthc\projects\windows\cauthc.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

### 第二层: Cocos2d引擎 (依赖Layer 1)
5. **libcocos2d.dll** - 1.4 MB (DLL) + 2.1 MB (LIB)
   ```batch
   msbuild cocos2d-2.0-rc2-x-2.0.1\cocos2dx\proj.win32\cocos2d-win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

6. **libCocosDenshion.dll** - 45 KB
   ```batch
   msbuild cocos2d-2.0-rc2-x-2.0.1\CocosDenshion\proj.win32\CocosDenshion.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

### 第三层: 游戏引擎 (依赖Layer 1+2)
7. **engine.lib** - 37 MB (最大的库)
   ```batch
   msbuild engine\engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

### 第四层: 应用程序 (依赖所有)
8. **FireClient.lib** - 游戏逻辑
   ```batch
   msbuild client\FireClient\FireClient.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

9. **MT3.exe** - 主程序 (约8-10 MB)
   ```batch
   msbuild client\MT3Win32App\mt3.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
   ```

---

## ✅ 验证清单

编译完成后,检查以下文件:

### 基础库
- [ ] `common\platform\Release.win32\platform.lib` (1.5 MB)
- [ ] `common\ljfm\Release.win32\ljfm.lib` (1.3 MB)
- [ ] `common\lua\Release.win32\lua.lib` (4.1 MB)
- [ ] `common\cauthc\projects\windows\Release.win32\cauthc.lib` (23 MB)

### Cocos2d引擎
- [ ] `cocos2d-2.0-rc2-x-2.0.1\Release.win32\libcocos2d.dll` (1.4 MB)
- [ ] `cocos2d-2.0-rc2-x-2.0.1\Release.win32\libcocos2d.lib` (2.1 MB)
- [ ] `cocos2d-2.0-rc2-x-2.0.1\Release.win32\libCocosDenshion.dll` (45 KB)

### 游戏引擎
- [ ] `engine\Release.win32\engine.lib` (37 MB)

### 应用程序
- [ ] `client\FireClient\Release.win32\FireClient.lib`
- [ ] `client\MT3Win32App\Release.win32\MT3.exe` (8-10 MB)
- [ ] `client\resource\bin\Release\MT3.exe` (PostBuild复制)

---

## 🚀 执行步骤

### 步骤1: 清理旧文件 (可选)
```batch
cd e:\梦幻西游MG原版源码
rmdir /s /q client\MT3Win32App\Release.win32
rmdir /s /q client\FireClient\Release.win32
rmdir /s /q engine\Release.win32
rmdir /s /q cocos2d-2.0-rc2-x-2.0.1\Release.win32
```

### 步骤2: 执行完整编译
```batch
build_mt3_v140_final.bat
```

**预计时间**: 15-20分钟
**输出**: 9个组件按顺序编译

### 步骤3: 验证编译结果
```batch
test_mt3_build.bat
```

**检查**:
- 所有文件是否存在
- 文件大小是否合理
- 依赖项是否正确
- 运行时库是否正确链接

### 步骤4: 运行测试
```batch
cd client\resource\bin\Release
MT3.exe
```

---

## 🔍 故障排查

### 问题1: 编译失败,出现LNK2001错误
**检查**:
1. 是否忽略了 `msvcrt.lib`?
2. 运行时库是否统一为 `/MD`?
3. 依赖库是否已经编译?

**解决**:
```batch
# 检查项目配置
findstr "IgnoreSpecificDefaultLibraries" client\MT3Win32App\mt3.win32.vcxproj
# 应该只看到: libcmt.lib;libcmtd.lib
```

### 问题2: MT3.exe无法运行,缺少DLL
**检查**:
```batch
# 检查DLL是否复制
dir client\resource\bin\Release\*.dll
```

**解决**:
```batch
# 手动复制DLL
xcopy /Y /Q cocos2d-2.0-rc2-x-2.0.1\Release.win32\*.dll client\resource\bin\Release\
```

### 问题3: 编译非常慢
**优化**:
- 确保使用了 `/m` 参数 (多核编译)
- 关闭杀毒软件临时排除项目目录
- 使用SSD而不是HDD

### 问题4: 运行时崩溃
**检查**:
```batch
# 分析依赖项
dumpbin /DEPENDENTS client\MT3Win32App\Release.win32\MT3.exe

# 应该看到 msvcr140.dll 或 VCRUNTIME140.dll
```

**解决**:
安装 Visual C++ 2015 Redistributable

---

## 📈 预期结果

### 编译成功标志
1. ✅ 所有9个组件无错误编译
2. ✅ 输出文件大小合理
3. ✅ PostBuild事件成功执行
4. ✅ DLL文件正确复制

### 总文件大小
- **总库大小**: 约 69 MB
- **MT3.exe**: 约 8-10 MB
- **DLL文件**: 约 1.5 MB

### 运行时依赖
- `msvcr140.dll` (v140 C运行时)
- `VCRUNTIME140.dll` (v140 C++运行时)
- `libcocos2d.dll`
- `libCocosDenshion.dll`
- Windows系统DLL

---

## 🎯 成功标准

1. **编译成功**: 所有组件零错误编译
2. **文件验证**: 所有输出文件存在且大小合理
3. **依赖正确**: MT3.exe链接到v140运行时
4. **能够运行**: MT3.exe成功启动(即使崩溃也算初步成功)

---

## 📚 相关文档

- [v140编译配置说明.md](doc/v140编译配置说明.md) - 详细配置说明
- [编译成功报告.md](doc/编译成功报告.md) - 第三方库编译报告
- [最终可用方案.md](最终可用方案.md) - v120原始版本对比

---

## 💡 经验总结

### 成功关键因素
1. **统一工具集**: v140 across all projects
2. **统一运行时**: /MD for all projects
3. **正确顺序**: 4-layer dependency hierarchy
4. **不忽略标准库**: msvcrt.lib is essential!

### 与v120对比
| 方面 | v120 (原始) | v140 (本次) |
|------|-------------|-------------|
| 工具集 | VS2013 | VS2015 |
| 运行时 | msvcr120.dll | msvcr140.dll |
| 优化 | Debug | Release |
| 大小 | 23 MB | 8-10 MB |
| 状态 | ✅ 稳定运行 | 🔄 编译测试中 |

---

**创建时间**: 2025-10-13
**执行状态**: 🔄 编译进行中
**下一步**: 等待编译完成并验证结果
