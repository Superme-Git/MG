# MT3项目v140工具集迁移完整解决方案

## 执行摘要

本文档提供了将MT3项目从v110工具集迁移到v140工具集的完整解决方案。重点解决3个失败组件：ljfm.lib、lua.lib和MT3.exe。

---

## 一、问题分析

### 1.1 ljfm.lib 失败原因

**配置问题：**
```xml
<!-- Line 55: Debug|Win32配置 -->
<CompileAsWinRT>true</CompileAsWinRT>
```

**根本原因：**
1. ljfm.vcxproj在Debug|Win32配置中**错误启用了WinRT编译**
2. WinRT(Windows Runtime)是专为UWP应用设计的C++扩展
3. v140工具集对WinRT的要求更严格,与传统Win32静态库不兼容
4. 项目包含ARM平台配置(Line 8-11),但Win32不应使用WinRT
5. 预编译头配置不一致:
   - pch.cpp设置为Create (Line 153)
   - 大部分.cpp文件设置为NotUsing
   - Debug|Win32使用Use,但实际文件都是NotUsing

**影响范围：**
- 静态库类型项目
- 包含49个C/C++源文件
- 依赖cocos2d引擎的文件系统组件

---

### 1.2 lua.lib 失败原因

**配置问题：**
```xml
<!-- Line 91: Release|Win32配置 -->
<PrecompiledHeader>Use</PrecompiledHeader>

<!-- Line 202: pch.cpp -->
<PrecompiledHeader>Create</PrecompiledHeader>
```

**根本原因：**
1. Release配置要求使用预编译头,但实际所有源文件都不使用
2. 包含Windows Phone 8特定的导入(Line 216):
   ```xml
   <Import Project="$(MSBuildExtensionsPath)\Microsoft\WindowsPhone\..."/>
   ```
3. 引用了platform.winmd(Line 210-213),这是WinRT元数据文件
4. Debug配置正确设置为NotUsing,但Release配置错误

**影响范围：**
- 静态库类型项目
- 包含Lua 5.1解释器和tolua++绑定
- 41个C/C++源文件

---

### 1.3 MT3.exe 失败原因

**配置问题：**
```xml
<!-- Line 18: 全局属性 -->
<WindowsTargetPlatformVersion>10.0.19041.0</WindowsTargetPlatformVersion>
```

**根本原因：**
1. 指定了Windows 10 SDK版本10.0.19041.0
2. v140工具集(VS2015)默认支持Windows 8.1 SDK
3. 当前环境可能没有安装该版本的SDK
4. 依赖ljfm.lib和lua.lib,这两个库编译失败导致链接失败

**影响范围：**
- 可执行文件项目
- 依赖72个静态库
- 主程序入口

---

## 二、解决方案

### 2.1 ljfm.lib 修复方案

#### 修复步骤 1: 禁用WinRT编译

**文件:** `common/ljfm/ljfm.vcxproj`

**修改位置:** Line 48-62 (Debug|Win32配置)

```xml
<!-- 修改前 -->
<ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
  <ClCompile>
    <PreprocessorDefinitions>_LIB;UNICODE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    <PrecompiledHeader>Use</PrecompiledHeader>
    <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    <AdditionalUsingDirectories>$(WindowsSDK_MetadataPath);$(AdditionalUsingDirectories)</AdditionalUsingDirectories>
    <AdditionalIncludeDirectories>pfs;.;../../../cocos2d-2.0-rc2-x-2.0.1/cocos2dx/platform/third_party/wp8/zlib;pfs/src;../platform</AdditionalIncludeDirectories>
    <CompileAsWinRT>true</CompileAsWinRT>
    <MinimalRebuild>false</MinimalRebuild>
  </ClCompile>
  <Link>
    <SubSystem>Console</SubSystem>
    <IgnoreAllDefaultLibraries>false</IgnoreAllDefaultLibraries>
  </Link>
</ItemDefinitionGroup>

<!-- 修改后 -->
<ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
  <ClCompile>
    <PreprocessorDefinitions>_LIB;UNICODE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    <PrecompiledHeader>NotUsing</PrecompiledHeader>
    <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    <AdditionalIncludeDirectories>pfs;.;../../../cocos2d-2.0-rc2-x-2.0.1/cocos2dx/platform/third_party/wp8/zlib;pfs/src;../platform</AdditionalIncludeDirectories>
    <CompileAsWinRT>false</CompileAsWinRT>
    <MinimalRebuild>false</MinimalRebuild>
  </ClCompile>
  <Link>
    <SubSystem>Console</SubSystem>
    <IgnoreAllDefaultLibraries>false</IgnoreAllDefaultLibraries>
  </Link>
</ItemDefinitionGroup>
```

**关键更改：**
1. `<CompileAsWinRT>true</CompileAsWinRT>` → `<CompileAsWinRT>false</CompileAsWinRT>`
2. `<PrecompiledHeader>Use</PrecompiledHeader>` → `<PrecompiledHeader>NotUsing</PrecompiledHeader>`
3. 移除 `<AdditionalUsingDirectories>` (WinRT特定配置)

#### 修复步骤 2: 修复Release配置

**修改位置:** Line 63-74 (Release|Win32配置)

```xml
<!-- 修改后 -->
<ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
  <ClCompile>
    <PreprocessorDefinitions>_LIB;NDEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    <PrecompiledHeader>NotUsing</PrecompiledHeader>
    <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    <AdditionalIncludeDirectories>pfs;.;../../../cocos2d-2.0-rc2-x-2.0.1/cocos2dx/platform/third_party/wp8/zlib;pfs/src;../platform</AdditionalIncludeDirectories>
    <CompileAsWinRT>false</CompileAsWinRT>
  </ClCompile>
  <Link>
    <SubSystem>Console</SubSystem>
    <IgnoreAllDefaultLibraries>false</IgnoreAllDefaultLibraries>
  </Link>
</ItemDefinitionGroup>
```

#### 修复步骤 3: 移除ARM平台配置(可选)

如果不需要ARM平台支持,可以删除Line 42-47和Line 75-103的ARM相关配置。

---

### 2.2 lua.lib 修复方案

#### 修复步骤 1: 修复预编译头配置

**文件:** `common/lua/lua.vcxproj`

**修改位置:** Line 88-102 (Release|Win32配置)

```xml
<!-- 修改前 -->
<ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
  <ClCompile>
    <PreprocessorDefinitions>_USRDLL;NDEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    <PrecompiledHeader>Use</PrecompiledHeader>
    <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    <CompileAsWinRT>false</CompileAsWinRT>
    <AdditionalUsingDirectories>$(WindowsSDK_MetadataPath);$(AdditionalUsingDirectories)</AdditionalUsingDirectories>
  </ClCompile>
  ...
</ItemDefinitionGroup>

<!-- 修改后 -->
<ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
  <ClCompile>
    <PreprocessorDefinitions>_LIB;NDEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    <PrecompiledHeader>NotUsing</PrecompiledHeader>
    <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    <CompileAsWinRT>false</CompileAsWinRT>
    <AdditionalIncludeDirectories>..\..\cocos2d-2.0-rc2-x-2.0.1\lua\lua;..\..\cocos2d-2.0-rc2-x-2.0.1\lua\tolua;..\platform</AdditionalIncludeDirectories>
  </ClCompile>
  <Link>
    <SubSystem>Console</SubSystem>
    <IgnoreAllDefaultLibraries>false</IgnoreAllDefaultLibraries>
    <GenerateWindowsMetadata>false</GenerateWindowsMetadata>
    <GenerateDebugInformation>true</GenerateDebugInformation>
  </Link>
</ItemDefinitionGroup>
```

**关键更改：**
1. `<PrecompiledHeader>Use</PrecompiledHeader>` → `<PrecompiledHeader>NotUsing</PrecompiledHeader>`
2. `_USRDLL` → `_LIB` (这是静态库,不是DLL)
3. 移除 `<AdditionalUsingDirectories>` 
4. 添加 `<AdditionalIncludeDirectories>` (与Debug配置一致)

#### 修复步骤 2: 移除Windows Phone导入

**修改位置:** Line 215-218

```xml
<!-- 删除以下行 -->
<Import Project="$(MSBuildExtensionsPath)\Microsoft\WindowsPhone\v$(TargetPlatformVersion)\Microsoft.Cpp.WindowsPhone.$(TargetPlatformVersion).targets" />
```

#### 修复步骤 3: 移除WinRT引用

**修改位置:** Line 206-214

```xml
<!-- 删除以下ItemGroup -->
<ItemGroup>
  <Reference Include="Windows">
    <IsWinMDFile>true</IsWinMDFile>
  </Reference>
  <Reference Include="platform.winmd">
    <IsWinMDFile>true</IsWinMDFile>
    <Private>false</Private>
  </Reference>
</ItemGroup>
```

#### 修复步骤 4: 移除ARM平台配置(可选)

如果不需要ARM平台支持,可以删除Line 8-19和Line 103-134的ARM相关配置。

---

### 2.3 MT3.exe 修复方案

#### 修复步骤 1: 移除Windows SDK版本指定

**文件:** `client/MT3Win32App/mt3.win32.vcxproj`

**修改位置:** Line 13-19

```xml
<!-- 修改前 -->
<PropertyGroup Label="Globals">
  <ProjectName>MT3</ProjectName>
  <ProjectGuid>{B8BF9E81-35FD-4582-BA1C-B85FA365BABB}</ProjectGuid>
  <RootNamespace>HelloWorldwin32</RootNamespace>
  <Keyword>Win32Proj</Keyword>
  <WindowsTargetPlatformVersion>10.0.19041.0</WindowsTargetPlatformVersion>
</PropertyGroup>

<!-- 修改后 -->
<PropertyGroup Label="Globals">
  <ProjectName>MT3</ProjectName>
  <ProjectGuid>{B8BF9E81-35FD-4582-BA1C-B85FA365BABB}</ProjectGuid>
  <RootNamespace>HelloWorldwin32</RootNamespace>
  <Keyword>Win32Proj</Keyword>
</PropertyGroup>
```

**关键更改：**
删除 `<WindowsTargetPlatformVersion>10.0.19041.0</WindowsTargetPlatformVersion>` 行,让v140工具集使用默认的SDK版本。

#### 修复步骤 2: 确认依赖库路径

确保ljfm.lib和lua.lib修复后,MT3.exe能够找到这些库文件。检查Line 74和Line 110的库路径配置是否正确。

---

## 三、实施计划

### 3.1 实施顺序

按照依赖关系,必须按以下顺序进行修复:

```
第一阶段: 基础库修复
├── ljfm.lib (无依赖)
└── lua.lib (无依赖)

第二阶段: 应用程序修复
└── MT3.exe (依赖ljfm.lib和lua.lib)
```

### 3.2 详细步骤

#### 阶段一: ljfm.lib修复

1. **备份原始文件**
   ```bash
   copy common\ljfm\ljfm.vcxproj common\ljfm\ljfm.vcxproj.bak
   ```

2. **修改vcxproj文件**
   - 按照2.1节的修复方案修改配置

3. **清理并重新编译**
   ```bash
   # 清理
   msbuild common\ljfm\ljfm.vcxproj /t:Clean /p:Configuration=Debug /p:Platform=Win32
   
   # 编译
   msbuild common\ljfm\ljfm.vcxproj /t:Build /p:Configuration=Debug /p:Platform=Win32
   ```

4. **验证输出**
   - 检查 `lib\Debug\Win32\ljfm.lib` 是否生成
   - 文件大小应在合理范围内

#### 阶段二: lua.lib修复

1. **备份原始文件**
   ```bash
   copy common\lua\lua.vcxproj common\lua\lua.vcxproj.bak
   ```

2. **修改vcxproj文件**
   - 按照2.2节的修复方案修改配置

3. **清理并重新编译**
   ```bash
   # 清理
   msbuild common\lua\lua.vcxproj /t:Clean /p:Configuration=Debug /p:Platform=Win32
   
   # 编译
   msbuild common\lua\lua.vcxproj /t:Build /p:Configuration=Debug /p:Platform=Win32
   ```

4. **验证输出**
   - 检查 `lib\Debug\Win32\lua.lib` 是否生成

#### 阶段三: MT3.exe修复

1. **备份原始文件**
   ```bash
   copy client\MT3Win32App\mt3.win32.vcxproj client\MT3Win32App\mt3.win32.vcxproj.bak
   ```

2. **修改vcxproj文件**
   - 按照2.3节的修复方案修改配置

3. **清理并重新编译**
   ```bash
   # 清理
   msbuild client\MT3Win32App\mt3.win32.vcxproj /t:Clean /p:Configuration=Debug /p:Platform=Win32
   
   # 编译
   msbuild client\MT3Win32App\mt3.win32.vcxproj /t:Build /p:Configuration=Debug /p:Platform=Win32
   ```

4. **验证输出**
   - 检查 `Debug.win32\MT3.exe` 是否生成
   - 运行程序验证功能

---

## 四、验证清单

### 4.1 ljfm.lib验证

- [ ] 项目编译无错误
- [ ] 项目编译无警告(或仅有可接受的警告)
- [ ] 生成ljfm.lib文件
- [ ] 文件大小合理(参考v110版本)
- [ ] 可以被MT3.exe成功链接

### 4.2 lua.lib验证

- [ ] 项目编译无错误
- [ ] 项目编译无警告(或仅有可接受的警告)
- [ ] 生成lua.lib文件
- [ ] 文件大小合理(参考v110版本)
- [ ] 可以被MT3.exe成功链接

### 4.3 MT3.exe验证

- [ ] 项目编译无错误
- [ ] 链接无错误
- [ ] 生成MT3.exe文件
- [ ] 程序可以正常启动
- [ ] 核心功能正常运行
- [ ] 无明显的运行时错误

---

## 五、风险评估与应对

### 5.1 潜在风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| WinRT依赖代码无法编译 | 中 | 高 | 检查源代码,移除或条件编译WinRT特定代码 |
| SDK版本不兼容 | 低 | 中 | 安装Windows 8.1 SDK |
| 第三方库不兼容 | 低 | 高 | 检查所有依赖库的v140兼容性 |
| 运行时错误 | 中 | 高 | 全面测试,使用调试器定位问题 |

### 5.2 回退方案

如果修复失败,可以回退到v110工具集:

1. 恢复备份的vcxproj文件
2. 在VS2015中将工具集改回v110(如果支持)
3. 或使用VS2012继续开发

---

## 六、后续优化建议

### 6.1 代码现代化

1. **移除过时的平台支持**
   - 删除ARM和Windows Phone配置
   - 简化项目结构

2. **统一编译选项**
   - 所有项目使用一致的预编译头策略
   - 统一警告级别和错误处理

3. **升级依赖库**
   - 考虑升级cocos2d-x到更新版本
   - 升级Lua到5.3或5.4版本

### 6.2 项目维护性改进

1. **使用属性表(Property Sheets)**
   - 创建共享的编译配置
   - 减少重复配置

2. **文档化**
   - 记录所有配置变更
   - 维护构建说明文档

3. **持续集成**
   - 设置自动化构建
   - 及早发现兼容性问题

---

## 七、总结

本迁移方案的核心是:

1. **禁用WinRT编译** - ljfm.lib的主要问题
2. **修复预编译头配置** - lua.lib的主要问题  
3. **移除SDK版本限制** - MT3.exe的主要问题

这些都是**配置问题**,不涉及代码修改,风险较低。按照本方案逐步执行,应该能够成功完成v140工具集的迁移。

---

## 附录A: 快速修复脚本

如果需要批量修改,可以使用以下PowerShell脚本:

```powershell
# ljfm.lib快速修复
$ljfmFile = "common\ljfm\ljfm.vcxproj"
$content = Get-Content $ljfmFile -Raw
$content = $content -replace '<CompileAsWinRT>true</CompileAsWinRT>','<CompileAsWinRT>false</CompileAsWinRT>'
$content = $content -replace '<PrecompiledHeader>Use</PrecompiledHeader>','<PrecompiledHeader>NotUsing</PrecompiledHeader>'
$content | Set-Content $ljfmFile

# lua.lib快速修复
$luaFile = "common\lua\lua.vcxproj"
$content = Get-Content $luaFile -Raw
$content = $content -replace '<PrecompiledHeader>Use</PrecompiledHeader>','<PrecompiledHeader>NotUsing</PrecompiledHeader>'
$content = $content -replace '_USRDLL','_LIB'
$content | Set-Content $luaFile

# MT3.exe快速修复
$mt3File = "client\MT3Win32App\mt3.win32.vcxproj"
$content = Get-Content $mt3File -Raw
$content = $content -replace '<WindowsTargetPlatformVersion>.*?</WindowsTargetPlatformVersion>',''
$content | Set-Content $mt3File

Write-Host "修复完成!"
```

**注意:** 使用脚本前请务必备份原始文件!

---

**文档版本:** 1.0  
**创建日期:** 2025-10-13  
**最后更新:** 2025-10-13