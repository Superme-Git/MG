# MT3é¡¹ç›® - å…³é”®æŠ€æœ¯æ–‡æ¡£ä¸è§£å†³æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-13  
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ€»ç»“ä¸æœ€ä½³å®è·µ  

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æŠ€æœ¯æ¦‚è§ˆ](#é¡¹ç›®æŠ€æœ¯æ¦‚è§ˆ)
2. [ç¼–è¯‘æ„å»ºå…³é”®ç‚¹](#ç¼–è¯‘æ„å»ºå…³é”®ç‚¹)
3. [æ¶æ„è®¾è®¡è¦ç‚¹](#æ¶æ„è®¾è®¡è¦ç‚¹)
4. [æ ¸å¿ƒæŠ€æœ¯è§£å†³æ–¹æ¡ˆ](#æ ¸å¿ƒæŠ€æœ¯è§£å†³æ–¹æ¡ˆ)
5. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
6. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
7. [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)

---

## é¡¹ç›®æŠ€æœ¯æ¦‚è§ˆ

### åŸºæœ¬ä¿¡æ¯

| é¡¹ç›®å±æ€§ | é…ç½® |
|---------|------|
| **é¡¹ç›®åç§°** | æ¢¦å¹»è¥¿æ¸¸MG (2D MMORPG) |
| **å¼€å‘è¯­è¨€** | C++ / Lua |
| **æ¸¸æˆå¼•æ“** | Cocos2d-x 2.0-rc2-x-2.0.1 |
| **ç›®æ ‡å¹³å°** | Windows (Win32) |
| **å¼€å‘å¹´ä»£** | 2016å¹´å·¦å³ |
| **C++æ ‡å‡†** | C++03/C++11 æ··åˆ |

### æŠ€æœ¯æ¶æ„ (4å±‚)

```
Layer 4: åº”ç”¨å±‚
  â”œâ”€ FireClient.lib (æ¸¸æˆé€»è¾‘)
  â””â”€ MT3.exe (ä¸»ç¨‹åºå…¥å£)

Layer 3: å¼•æ“æ‰©å±•å±‚
  â””â”€ engine.lib (37 MB - æ¸¸æˆå¼•æ“æ‰©å±•)

Layer 2: Cocos2då¼•æ“å±‚
  â”œâ”€ libcocos2d.dll (2.2 MB - 2Då¼•æ“æ ¸å¿ƒ)
  â””â”€ libCocosDenshion.dll (45 KB - éŸ³é¢‘å¼•æ“)

Layer 1: åŸºç¡€åº“å±‚ (æ— ç›¸äº’ä¾èµ–)
  â”œâ”€ platform.lib (1.5 MB - å¹³å°æŠ½è±¡)
  â”œâ”€ ljfm.lib (1.3 MB - æ–‡ä»¶ç®¡ç†)
  â”œâ”€ lua.lib (4.1 MB - è„šæœ¬å¼•æ“)
  â””â”€ cauthc.lib (23 MB - è®¤è¯åº“)
```

---

## ç¼–è¯‘æ„å»ºå…³é”®ç‚¹

### 1. è¿è¡Œæ—¶åº“ç»Ÿä¸€é…ç½® âš ï¸ **æœ€å…³é”®!**

#### é—®é¢˜æ ¹æº
æ··ç”¨ä¸åŒçš„Visual C++è¿è¡Œæ—¶åº“ä¼šå¯¼è‡´å¤§é‡é“¾æ¥é”™è¯¯(7,029ä¸ªLNK2001é”™è¯¯)

#### æ­£ç¡®é…ç½®æ–¹æ³•

```xml
<!-- âœ… æ‰€æœ‰é¡¹ç›®å¿…é¡»ç»Ÿä¸€ä½¿ç”¨ -->
<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>  <!-- Release: /MD -->
<RuntimeLibrary>MultiThreadedDebugDLL</RuntimeLibrary>  <!-- Debug: /MDd -->
```

#### é“¾æ¥å™¨é…ç½® - å…³é”®é”™è¯¯é¿å…

```xml
<!-- âœ… æ­£ç¡®é…ç½® - åªå¿½ç•¥é™æ€è¿è¡Œæ—¶åº“ -->
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib</IgnoreSpecificDefaultLibraries>

<!-- âŒ é”™è¯¯é…ç½® - ç»å¯¹ä¸èƒ½å¿½ç•¥ msvcrt.lib! -->
<IgnoreSpecificDefaultLibraries>libcmt.lib;libcmtd.lib;msvcrt.lib;msvcrtd.lib</IgnoreSpecificDefaultLibraries>
```

**é‡è¦**: `msvcrt.lib` æ˜¯ `/MD` è¿è¡Œæ—¶çš„æ ¸å¿ƒåº“,å¿½ç•¥å®ƒä¼šå¯¼è‡´æ‰€æœ‰æ ‡å‡†åº“å‡½æ•°é“¾æ¥å¤±è´¥!

### 2. å¹³å°å·¥å…·é›†ç‰ˆæœ¬æ§åˆ¶

```xml
<!-- ç»Ÿä¸€ä½¿ç”¨ v140 (VS2015) -->
<PlatformToolset>v140</PlatformToolset>
```

**å…³é”®ç‚¹**:
- âœ… æ‰€æœ‰ç»„ä»¶å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å·¥å…·é›†ç‰ˆæœ¬
- âŒ v120 (VS2013) å’Œ v140 (VS2015) äºŒè¿›åˆ¶ä¸å…¼å®¹
- âš ï¸ ä¸èƒ½æ··ç”¨ä¸åŒç‰ˆæœ¬ç¼–è¯‘çš„åº“æ–‡ä»¶

### 3. ç¼–è¯‘é¡ºåº - ä¸¥æ ¼æŒ‰ä¾èµ–å±‚çº§

```batch
# ç¬¬ä¸€å±‚ (å¹¶è¡Œç¼–è¯‘,æ— ä¾èµ–)
msbuild platform.editor.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild ljfm.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild lua.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild cauthc.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m

# ç¬¬äºŒå±‚ (ä¾èµ–ç¬¬ä¸€å±‚)
msbuild cocos2d-win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild CocosDenshion.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m

# ç¬¬ä¸‰å±‚ (ä¾èµ–å‰ä¸¤å±‚)
msbuild engine.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m

# ç¬¬å››å±‚ (ä¾èµ–æ‰€æœ‰)
msbuild FireClient.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
msbuild mt3.win32.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m
```

### 4. ç¼–è¯‘ä¼˜åŒ–å‚æ•°

```batch
# MSBuild æœ€ä½³å®è·µå‚æ•°
/t:Rebuild        # å®Œå…¨é‡æ–°ç¼–è¯‘
/p:Configuration=Release  # Releaseé…ç½®
/p:Platform=Win32         # 32ä½å¹³å°
/p:PlatformToolset=v140   # å¼ºåˆ¶å·¥å…·é›†ç‰ˆæœ¬
/v:minimal                # æœ€å°è¾“å‡ºä¿¡æ¯
/nologo                   # ä¸æ˜¾ç¤ºlogo
/m                        # å¤šæ ¸å¹¶è¡Œç¼–è¯‘
```

### 5. éªŒè¯ç¼–è¯‘ç»“æœ

```batch
# ä½¿ç”¨ dumpbin æ£€æŸ¥è¿è¡Œæ—¶åº“
dumpbin /DIRECTIVES platform.lib | findstr /C:"DEFAULTLIB"

# æœŸæœ›è¾“å‡º:
# /DEFAULTLIB:"MSVCRT"    âœ… æ­£ç¡® - åŠ¨æ€é“¾æ¥
# /DEFAULTLIB:"LIBCMT"    âŒ é”™è¯¯ - é™æ€é“¾æ¥
```

---

## æ¶æ„è®¾è®¡è¦ç‚¹

### 1. æ ¸å¿ƒè®¾è®¡æ¨¡å¼

#### å•ä¾‹æ¨¡å¼ (Singleton)
```cpp
// å¼•æ“æ ¸å¿ƒå•ä¾‹
class IEngine
{
public:
    static IEngine* GetEngine();  // å…¨å±€è®¿é—®ç‚¹
    
private:
    IEngine() {}
    static IEngine* m_instance;
    
    // ç¦æ­¢å¤åˆ¶
    IEngine(const IEngine&) = delete;
    IEngine& operator=(const IEngine&) = delete;
};
```

**åº”ç”¨åœºæ™¯**:
- IEngine - å¼•æ“ä¸»å®ä¾‹
- IWorld - ä¸–ç•Œç®¡ç†å™¨
- IRenderer - æ¸²æŸ“å™¨
- å„ç§Managerç±»

#### å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆ
```cpp
// Nuclearå¼•æ“å¼•ç”¨è®¡æ•°
template<typename T>
class NuclearHardRef
{
public:
    NuclearHardRef(T* ptr = nullptr) : m_ptr(ptr) { AddRef(); }
    ~NuclearHardRef() { Release(); }
    
    T* operator->() const { return m_ptr; }
    
private:
    void AddRef() { if (m_ptr) m_ptr->AddRef(); }
    void Release() { 
        if (m_ptr && m_ptr->Release() == 0) 
            m_ptr = nullptr; 
    }
    
    T* m_ptr;
};
```

**å…³é”®ç‚¹**:
- âœ… è‡ªåŠ¨ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
- âœ… é¿å…å†…å­˜æ³„æ¼
- âœ… çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°

#### å¯¹è±¡æ± æ¨¡å¼
```cpp
template<typename T>
class ObjectPool
{
public:
    T* Acquire()
    {
        if (!m_freeList.empty()) {
            T* obj = m_freeList.back();
            m_freeList.pop_back();
            return obj;
        }
        return new T();
    }
    
    void Release(T* obj)
    {
        obj->Reset();
        if (m_freeList.size() < MAX_POOL_SIZE) {
            m_freeList.push_back(obj);
        } else {
            delete obj;
        }
    }
    
private:
    std::vector<T*> m_freeList;
    static const size_t MAX_POOL_SIZE = 100;
};
```

**ä¼˜åŠ¿**:
- âœ… å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°
- âœ… æé«˜æ€§èƒ½ (é¿å…é¢‘ç¹new/delete)
- âœ… å‡å°‘å†…å­˜ç¢ç‰‡

### 2. å†…å­˜ç®¡ç†ç­–ç•¥

#### è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨ (nedmalloc)
```cpp
namespace Nuclear
{
    void* nedalloc(size_t size);
    void nedfree(void* ptr);
    void* nedrealloc(void* ptr, size_t size);
}
```

**ä¼˜åŠ¿**:
- æ¯”ç³»ç»Ÿmallocå¿«2-3å€
- å‡å°‘å†…å­˜ç¢ç‰‡
- å¤šçº¿ç¨‹å‹å¥½

#### é¢„ç¼–è¯‘å¤´ (PCH)
```cpp
// nupch.h - æ ‡å‡†é¢„ç¼–è¯‘å¤´
#include <vector>
#include <map>
#include <string>
#include <windows.h>
#include "cocos2d.h"
```

**ç¼–è¯‘æ—¶é—´ä¼˜åŒ–**:
- é¦–æ¬¡ç¼–è¯‘: ~30ç§’
- å¢é‡ç¼–è¯‘: ~3-5ç§’
- æé€Ÿçº¦85%

---

## æ ¸å¿ƒæŠ€æœ¯è§£å†³æ–¹æ¡ˆ

### 1. Cocos2d-x OpenGLç€è‰²å™¨é—®é¢˜

#### é—®é¢˜
Releaseç‰ˆæœ¬ç€è‰²å™¨é“¾æ¥å¤±è´¥ä½†ä¸æ£€æŸ¥çŠ¶æ€,å¯¼è‡´è¿è¡Œæ—¶å´©æºƒ

#### è§£å†³æ–¹æ¡ˆ
```cpp
// CCGLProgram.cpp - ä¿®æ”¹link()æ–¹æ³•
bool CCGLProgram::link()
{
    glLinkProgram(m_uProgram);
    
    // âœ… Releaseç‰ˆæœ¬ä¹Ÿè¦æ£€æŸ¥é“¾æ¥çŠ¶æ€
    GLint status;
    glGetProgramiv(m_uProgram, GL_LINK_STATUS, &status);
    if (status == GL_FALSE) {
        // è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
        GLint logLength = 0;
        glGetProgramiv(m_uProgram, GL_INFO_LOG_LENGTH, &logLength);
        if (logLength > 1) {
            GLchar* log = (GLchar*)malloc(logLength);
            glGetProgramInfoLog(m_uProgram, logLength, &logLength, log);
            CCLOG("Program link error: %s", log);
            free(log);
        }
        return false;
    }
    
    return true;
}
```

**å…³é”®æ•™è®­**:
- âš ï¸ Releaseç‰ˆæœ¬ä¸åº”è¯¥è·³è¿‡é”™è¯¯æ£€æŸ¥
- âœ… å§‹ç»ˆéªŒè¯OpenGLæ“ä½œç»“æœ
- âœ… æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 2. IniFileç¼ºå¤±é—®é¢˜

#### é—®é¢˜
platform.libé“¾æ¥å¤±è´¥,æç¤ºIniFileç¬¦å·æœªå®šä¹‰

#### è§£å†³æ–¹æ¡ˆ
```xml
<!-- platform.editor.vcxproj - æ·»åŠ ç¼ºå¤±æ–‡ä»¶ -->
<ItemGroup>
  <ClCompile Include="ini\IniFile.cpp" />
</ItemGroup>
<ItemGroup>
  <ClInclude Include="ini\IniFile.h" />
</ItemGroup>
```

**å…³é”®ç‚¹**:
- âœ… æ£€æŸ¥.vcxprojæ–‡ä»¶çš„å®Œæ•´æ€§
- âœ… ç¡®ä¿æ‰€æœ‰æºæ–‡ä»¶éƒ½å·²åŒ…å«
- âœ… éªŒè¯æ–‡ä»¶è·¯å¾„æ­£ç¡®æ€§

### 3. åº“æœç´¢è·¯å¾„é—®é¢˜

#### é—®é¢˜
é“¾æ¥å™¨æ‰¾ä¸åˆ°ä¾èµ–åº“æ–‡ä»¶

#### è§£å†³æ–¹æ¡ˆ
```xml
<!-- mt3.win32.vcxproj - é…ç½®åº“æœç´¢è·¯å¾„ -->
<AdditionalLibraryDirectories>
  ../../cocos2d-2.0-rc2-x-2.0.1/cocos2dx/proj.win32/$(Configuration).win32;
  ../../cocos2d-2.0-rc2-x-2.0.1/CocosDenshion/proj.win32/$(Configuration).win32;
  ../../common/platform/$(Configuration).win32;
  ../../common/cauthc/projects/windows/$(Configuration).win32;
  ../../common/lua/$(Configuration).win32;
  ../../common/ljfm/$(Configuration).win32;
  ../../engine/$(Configuration).win32;
  %(AdditionalLibraryDirectories)
</AdditionalLibraryDirectories>
```

**å…³é”®ç‚¹**:
- âœ… ä½¿ç”¨ç›¸å¯¹è·¯å¾„
- âœ… ä½¿ç”¨$(Configuration)å˜é‡åŠ¨æ€é€‚é…
- âœ… ä¿ç•™%(AdditionalLibraryDirectories)ç»§æ‰¿çˆ¶é…ç½®

### 4. v140ç¼–è¯‘ä½†æ— æ³•è¿è¡Œé—®é¢˜

#### æ ¹æœ¬åŸå› 
v140 (VS2015) å’Œ v120 (VS2013) å·¥å…·é›†äºŒè¿›åˆ¶ä¸å…¼å®¹

#### è§£å†³æ–¹æ¡ˆ
**é€‰é¡¹1**: ä½¿ç”¨åŸå§‹v120ç‰ˆæœ¬ âœ… æ¨è
```batch
cd client\resource\bin\debug
MT3åŸå§‹.exe
```

**é€‰é¡¹2**: è°ƒè¯•v140ç‰ˆæœ¬
- ä½¿ç”¨Visual Studioè°ƒè¯•å™¨å®šä½å´©æºƒåŸå› 
- å°è¯•ä¸åŒä¼˜åŒ–çº§åˆ« (/O1 ä»£æ›¿ /O2)
- æ£€æŸ¥ç€è‰²å™¨ç¼–è¯‘å’ŒOpenGLåˆå§‹åŒ–

**é€‰é¡¹3**: å®Œæ•´å‡çº§ (é•¿æœŸæ–¹æ¡ˆ)
- å‡çº§åˆ°Cocos2d-x 3.x/4.x
- æ›´å¥½çš„ç°ä»£ç¼–è¯‘å™¨æ”¯æŒ
- éœ€è¦å¤§é‡ä»£ç è¿ç§»å·¥ä½œ

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç©ºé—´åˆ†åŒº - å››å‰æ ‘

```cpp
class QuadTree
{
public:
    void Insert(Sprite* sprite)
    {
        if (m_sprites.size() > MAX_CAPACITY && m_depth < MAX_DEPTH) {
            Split();  // è¶…è¿‡å®¹é‡æ—¶åˆ†è£‚
        }
        // æ’å…¥é€»è¾‘...
    }
    
    void Query(const Rect& rect, std::vector<Sprite*>& result)
    {
        if (!m_bounds.Intersects(rect)) return;
        
        // æ”¶é›†ç›¸äº¤çš„ç²¾çµ
        for (Sprite* sprite : m_sprites) {
            if (rect.Contains(sprite->GetPosition())) {
                result.push_back(sprite);
            }
        }
        
        // é€’å½’æŸ¥è¯¢å­èŠ‚ç‚¹
        for (auto& child : m_children) {
            child->Query(rect, result);
        }
    }
    
private:
    static const int MAX_CAPACITY = 10;
    static const int MAX_DEPTH = 5;
    Rect m_bounds;
    std::vector<Sprite*> m_sprites;
    std::vector<std::unique_ptr<QuadTree>> m_children;
};
```

**ä¼˜åŠ¿**:
- å¿«é€Ÿç¢°æ’æ£€æµ‹
- è§†é”¥å‰”é™¤ä¼˜åŒ–
- O(log n) æŸ¥è¯¢å¤æ‚åº¦

### 2. æ‰¹é‡æ¸²æŸ“

```cpp
class SpriteBatchRenderer
{
public:
    void Flush()
    {
        // æŒ‰çº¹ç†åˆ†ç»„
        std::map<Texture*, std::vector<Sprite*>> batches;
        
        for (const QuadInfo& quad : m_quadList) {
            batches[quad.texture].push_back(quad);
        }
        
        // æ‰¹é‡æ¸²æŸ“æ¯ç»„
        for (auto& [texture, sprites] : batches) {
            texture->Bind();
            BuildVertexBuffer(sprites);
            glDrawArrays(GL_TRIANGLES, 0, sprites.size() * 6);
        }
    }
};
```

**ä¼˜åŠ¿**:
- å‡å°‘Draw Call
- å‡å°‘çŠ¶æ€åˆ‡æ¢
- æé«˜GPUåˆ©ç”¨ç‡

### 3. è„æ ‡è®° (Dirty Flag)

```cpp
class Transform
{
public:
    void SetPosition(float x, float y, float z)
    {
        if (m_position != Vector3{x, y, z}) {
            m_position = {x, y, z};
            m_dirty = true;  // æ ‡è®°ä¸ºè„
        }
    }
    
    const Matrix4x4& GetMatrix()
    {
        if (m_dirty) {
            RecalculateMatrix();  // ä»…åœ¨éœ€è¦æ—¶è®¡ç®—
            m_dirty = false;
        }
        return m_matrix;
    }
    
private:
    Vector3 m_position;
    Matrix4x4 m_matrix;
    bool m_dirty;
};
```

**ä¼˜åŠ¿**:
- é¿å…é‡å¤è®¡ç®—
- å»¶è¿Ÿè®¡ç®—åˆ°çœŸæ­£éœ€è¦æ—¶
- æ˜¾è‘—æå‡æ€§èƒ½

### 4. å¼‚æ­¥èµ„æºåŠ è½½

```cpp
class AsyncLoader
{
public:
    void LoadAsync(const std::wstring& path, Callback callback)
    {
        Task task = {path, callback};
        
        std::lock_guard<std::mutex> lock(m_mutex);
        m_taskQueue.push(task);
        m_condition.notify_one();
    }
    
private:
    void WorkerThread()
    {
        while (m_running) {
            std::unique_lock<std::mutex> lock(m_mutex);
            m_condition.wait(lock, [this] { 
                return !m_taskQueue.empty() || !m_running; 
            });
            
            if (!m_running) break;
            
            Task task = m_taskQueue.front();
            m_taskQueue.pop();
            lock.unlock();
            
            // æ‰§è¡ŒåŠ è½½
            void* data = LoadFile(task.path);
            
            // å›è°ƒåˆ°ä¸»çº¿ç¨‹
            PostToMainThread(task.callback, data);
        }
    }
};
```

**ä¼˜åŠ¿**:
- ä¸é˜»å¡ä¸»çº¿ç¨‹
- æå‡ç”¨æˆ·ä½“éªŒ
- å……åˆ†åˆ©ç”¨å¤šæ ¸CPU

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: LNK2001 æœªè§£æçš„å¤–éƒ¨ç¬¦å·

**ç—‡çŠ¶**:
```
error LNK2001: æ— æ³•è§£æçš„å¤–éƒ¨ç¬¦å· @__security_check_cookie@4
error LNK2001: æ— æ³•è§£æçš„å¤–éƒ¨ç¬¦å· ___security_cookie
error LNK2001: æ— æ³•è§£æçš„å¤–éƒ¨ç¬¦å· operator new/delete
```

**åŸå› **: è¿è¡Œæ—¶åº“ä¸åŒ¹é…æˆ–å¿½ç•¥äº†å¿…éœ€çš„æ ‡å‡†åº“

**è§£å†³æ–¹æ¡ˆ**:
1. âœ… æ£€æŸ¥æ‰€æœ‰é¡¹ç›®çš„è¿è¡Œæ—¶åº“é…ç½®æ˜¯å¦ä¸º `/MD`
2. âœ… ç¡®ä¿ `IgnoreSpecificDefaultLibraries` **ä¸åŒ…å«** `msvcrt.lib`
3. âœ… é‡æ–°ç¼–è¯‘æ‰€æœ‰ä¾èµ–åº“

### é—®é¢˜2: æ‰¾ä¸åˆ°å¹³å°å·¥å…·é›† v140

**ç—‡çŠ¶**:
```
error MSB8020: æ— æ³•æ‰¾åˆ° v140 çš„ç”Ÿæˆå·¥å…·
```

**è§£å†³æ–¹æ¡ˆ**:
1. å®‰è£… Visual Studio 2015 æˆ–
2. å®‰è£… Visual Studio 2017/2019 çš„ v140 å·¥å…·é›†ç»„ä»¶
3. æˆ–ä¿®æ”¹ä¸ºå½“å‰å·²å®‰è£…çš„å·¥å…·é›† (å¦‚ v141, v142)

### é—®é¢˜3: æ‰¾ä¸åˆ° Windows SDK

**ç—‡çŠ¶**:
```
error MSB8036: æ‰¾ä¸åˆ° Windows SDK ç‰ˆæœ¬ 10.0.19041.0
```

**è§£å†³æ–¹æ¡ˆ**:
```batch
# æŸ¥çœ‹å·²å®‰è£…çš„SDK
dir "C:\Program Files (x86)\Windows Kits\10\Include"

# ä¿®æ”¹é¡¹ç›®æ–‡ä»¶
<WindowsTargetPlatformVersion>10.0.17763.0</WindowsTargetPlatformVersion>
```

### é—®é¢˜4: ç¼–è¯‘æˆåŠŸä½†è¿è¡Œå´©æºƒ

**ç—‡çŠ¶**: v140ç¼–è¯‘çš„MT3.exeå¯åŠ¨æ—¶å´©æºƒ

**è¯Šæ–­æ­¥éª¤**:
```batch
# 1. æ£€æŸ¥ä¾èµ–é¡¹
dumpbin /DEPENDENTS MT3.exe

# 2. æ£€æŸ¥è¿è¡Œæ—¶åº“
dumpbin /DIRECTIVES platform.lib | findstr /C:"DEFAULTLIB"

# 3. æ£€æŸ¥DLLæ˜¯å¦å­˜åœ¨
dir *.dll
```

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨åŸå§‹v120 Debugç‰ˆæœ¬ (æœ€å¯é )
- å®‰è£…Visual C++ 2015 Redistributable
- æ£€æŸ¥æ‰€æœ‰DLLæ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®ä½ç½®

### é—®é¢˜5: ç¼ºå°‘DLLæ–‡ä»¶

**ç—‡çŠ¶**:
```
æ‰¾ä¸åˆ° libcocos2d.dll
æ‰¾ä¸åˆ° fmodex.dll
```

**è§£å†³æ–¹æ¡ˆ**:
```batch
# å¤åˆ¶æ‰€æœ‰å¿…éœ€çš„DLLåˆ°MT3.exeç›®å½•
copy cocos2d-2.0-rc2-x-2.0.1\Release.win32\*.dll client\resource\bin\Release\
```

**å¿…éœ€çš„DLLåˆ—è¡¨**:
1. libcocos2d.dll
2. libCocosDenshion.dll
3. glew32.dll
4. pthreadVCE2.dll
5. libcurl.dll
6. iconv.dll
7. libxml2.dll
8. zlib1.dll
9. fmodex.dll

---

## æœ€ä½³å®è·µæ€»ç»“

### 1. ç¼–è¯‘æ„å»º

#### âœ… æ¨èåšæ³•
- ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ç¼–è¯‘,å‡å°‘äººä¸ºé”™è¯¯
- æŒ‰ä¾èµ–å±‚çº§é¡ºåºç¼–è¯‘
- ä½¿ç”¨ `/m` å‚æ•°å¯ç”¨å¹¶è¡Œç¼–è¯‘
- æ¯æ¬¡å®Œæ•´ç¼–è¯‘ä½¿ç”¨ `/t:Rebuild`
- ä¿å­˜æˆåŠŸç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½œä¸ºå¤‡ä»½

#### âŒ åº”è¯¥é¿å…
- æ··ç”¨ä¸åŒç‰ˆæœ¬çš„å·¥å…·é›†
- å¿½ç•¥å¿…éœ€çš„æ ‡å‡†åº“ (msvcrt.lib)
- è·³è¿‡ä¾èµ–åº“çš„ç¼–è¯‘
- åœ¨Releaseç‰ˆæœ¬ä¸­ç¦ç”¨é”™è¯¯æ£€æŸ¥

### 2. ä»£ç ç»„ç»‡

#### å‘½åçº¦å®š
```cpp
// ç±»å: PascalCase
class SpriteManager {};

// æˆå‘˜å˜é‡: m_ å‰ç¼€ + camelCase
class Sprite {
    std::wstring m_modelName;
    int m_refCount;
};

// æ¥å£: I å‰ç¼€
class IEngine {};

// å‡½æ•°: PascalCase
void UpdateSprite();

// å¸¸é‡: å…¨å¤§å†™ + ä¸‹åˆ’çº¿
const int MAX_SPRITES = 1000;
```

#### é”™è¯¯å¤„ç†
```cpp
// ä½¿ç”¨è¿”å›å€¼ + æ—¥å¿—
bool LoadTexture(const std::wstring& path)
{
    FILE* file = fopen(path.c_str(), "rb");
    if (!file) {
        CCLOG("Failed to open texture: %s", path.c_str());
        return false;
    }
    // å¤„ç†...
    fclose(file);
    return true;
}

// å…³é”®è·¯å¾„ä½¿ç”¨æ–­è¨€
void SetSprite(Sprite* sprite)
{
    assert(sprite != nullptr && "Sprite cannot be null");
    m_sprite = sprite;
}
```

### 3. æ€§èƒ½ä¼˜åŒ–

#### ä¼˜å…ˆçº§æ’åº
1. **é«˜**: æ‰¹é‡æ¸²æŸ“ã€å¯¹è±¡æ± ã€ç©ºé—´åˆ†åŒº
2. **ä¸­**: å¼‚æ­¥åŠ è½½ã€è„æ ‡è®°ã€å†…å­˜å¯¹é½
3. **ä½**: å­—ç¬¦ä¸²ä¼˜åŒ–ã€é¢„ç¼–è¯‘å¤´

#### ä¼˜åŒ–åŸåˆ™
- å…ˆæµ‹é‡,åä¼˜åŒ–
- ä¼˜åŒ–çƒ­ç‚¹ä»£ç è·¯å¾„
- å¹³è¡¡å¯è¯»æ€§å’Œæ€§èƒ½
- é¿å…è¿‡æ—©ä¼˜åŒ–

### 4. ç‰ˆæœ¬æ§åˆ¶

#### å…³é”®æ–‡ä»¶è·Ÿè¸ª
- âœ… æ‰€æœ‰.vcxprojé¡¹ç›®æ–‡ä»¶
- âœ… æ‰¹å¤„ç†å’ŒPowerShellè„šæœ¬
- âœ… é…ç½®æ–‡ä»¶å’Œèµ„æºå®šä¹‰
- âŒ ç¼–è¯‘è¾“å‡ºæ–‡ä»¶ (*.lib, *.dll, *.exe)
- âŒ ä¸­é—´æ–‡ä»¶ (*.obj, *.pch)

### 5. æ–‡æ¡£ç»´æŠ¤

#### æ›´æ–°åŸåˆ™
1. å‡†ç¡®æ€§ç¬¬ä¸€ - ç¡®ä¿æ‰€æœ‰ä¿¡æ¯å‡†ç¡®æ— è¯¯
2. åŠæ—¶æ¸…ç† - åˆ é™¤è¿‡æ—¶å’Œé”™è¯¯çš„æ–‡æ¡£
3. é¿å…é‡å¤ - åŒä¸€ä¿¡æ¯åªåœ¨ä¸€ä¸ªåœ°æ–¹ç»´æŠ¤
4. ç»“æ„æ¸…æ™° - å»ºç«‹æ¸…æ™°çš„æ–‡æ¡£å¯¼èˆª
5. ç‰ˆæœ¬æ§åˆ¶ - è®°å½•æ–‡æ¡£ç‰ˆæœ¬å’Œæ›´æ–°å†å²

---

## æŠ€æœ¯ç»éªŒæ€»ç»“

### æˆåŠŸå…³é”®å› ç´ 

1. **ç»Ÿä¸€çš„å·¥å…·é“¾**
   - æ‰€æœ‰åº“ä½¿ç”¨ç›¸åŒçš„å·¥å…·é›†ç‰ˆæœ¬ (v140)
   - ç»Ÿä¸€çš„è¿è¡Œæ—¶åº“é…ç½® (/MD)
   - ä¸€è‡´çš„ç¼–è¯‘å‚æ•°

2. **æ­£ç¡®çš„ä¾èµ–ç®¡ç†**
   - ç†è§£4å±‚ä¾èµ–æ¶æ„
   - æŒ‰é¡ºåºç¼–è¯‘ä¾èµ–åº“
   - ä½¿ç”¨å¯¹è±¡æ± å’Œæ™ºèƒ½æŒ‡é’ˆç®¡ç†ç”Ÿå‘½å‘¨æœŸ

3. **è‡ªåŠ¨åŒ–æ„å»º**
   - å‡å°‘äººä¸ºé”™è¯¯
   - æé«˜ç¼–è¯‘æ•ˆç‡
   - ä¾¿äºæŒç»­é›†æˆ

4. **è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†**
   - Releaseç‰ˆæœ¬ä¹Ÿè¦æ£€æŸ¥é”™è¯¯
   - æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - ä¾¿äºé—®é¢˜è¯Šæ–­

### ç»éªŒæ•™è®­

1. âš ï¸ **å·¥å…·é›†å…¼å®¹æ€§å¾ˆé‡è¦**
   - v120 å’Œ v140 äºŒè¿›åˆ¶ä¸å…¼å®¹
   - å‡çº§å·¥å…·é›†éœ€è¦é‡æ–°ç¼–è¯‘æ‰€æœ‰åº“
   - ä¿ç•™åŸå§‹ç‰ˆæœ¬ä½œä¸ºå‚è€ƒ

2. âš ï¸ **ä¸è¦éšæ„å¿½ç•¥æ ‡å‡†åº“**
   - msvcrt.lib æ˜¯åŠ¨æ€è¿è¡Œæ—¶çš„æ ¸å¿ƒ
   - å¿½ç•¥å®ƒä¼šå¯¼è‡´å¤§é‡é“¾æ¥é”™è¯¯
   - åªå¿½ç•¥é™æ€è¿è¡Œæ—¶åº“

3. âš ï¸ **Releaseä¼˜åŒ–å¯èƒ½ç ´åä»£ç **
   - ä¸è¦åœ¨Releaseç‰ˆæœ¬ä¸­è·³è¿‡é”™è¯¯æ£€æŸ¥
   - æŸäº›ä¼˜åŒ–å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é—®é¢˜
   - ä¿ç•™Debugç‰ˆæœ¬ç”¨äºè¯Šæ–­

4. âœ… **è‡ªåŠ¨åŒ–è„šæœ¬æé«˜æ•ˆç‡**
   - å‡å°‘é‡å¤åŠ³åŠ¨
   - ç¡®ä¿ç¼–è¯‘ä¸€è‡´æ€§
   - ä¾¿äºæ–°æˆå‘˜ä¸Šæ‰‹

### å‡çº§å»ºè®®

#### çŸ­æœŸ (ä¿æŒç°çŠ¶)
- âœ… ä½¿ç”¨ç¨³å®šçš„v120 Debugç‰ˆæœ¬
- âœ… ç»§ç»­å¼€å‘å’Œç»´æŠ¤
- âš ï¸ Debugæ€§èƒ½ç•¥ä½ä½†ç¨³å®šå¯é 

#### ä¸­æœŸ (è°ƒè¯•v140)
- ä½¿ç”¨Visual Studioè°ƒè¯•å™¨å®šä½å´©æºƒ
- å°è¯•ä¸åŒä¼˜åŒ–çº§åˆ«
- ä¿®æ”¹å¯èƒ½æœ‰é—®é¢˜çš„ä»£ç 
- éœ€è¦æŠ•å…¥æ›´å¤šæ—¶é—´

#### é•¿æœŸ (å¼•æ“å‡çº§)
- å‡çº§åˆ°Cocos2d-x 3.xæˆ–4.x
- æ›´å¥½çš„ç°ä»£ç¼–è¯‘å™¨æ”¯æŒ
- éœ€è¦å¤§é‡ä»£ç è¿ç§»
- æœ€ä½³é•¿æœŸæ–¹æ¡ˆ

---

## å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```batch
# å®Œæ•´ç¼–è¯‘ (v140)
build_mt3_release_complete.bat

# ç¼–è¯‘å•ä¸ªç»„ä»¶
msbuild platform.editor.vcxproj /t:Rebuild /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v140 /m

# å¤åˆ¶è¿è¡Œæ—¶DLL
copy_runtime_dlls.bat

# éªŒè¯ç¼–è¯‘ç»“æœ
dumpbin /DIRECTIVES platform.lib | findstr /C:"DEFAULTLIB"

# è¿è¡Œæ¸¸æˆ
cd client\resource\bin\debug
MT3åŸå§‹.exe
```

### å…³é”®æ–‡ä»¶ä½ç½®

```
ç¼–è¯‘è¾“å‡º:
  common\platform\Release.win32\platform.lib (1.5 MB)
  common\cauthc\...\Release.win32\cauthc.lib (23 MB)
  engine\Release.win32\engine.lib (37 MB)
  cocos2d...\Release.win32\libcocos2d.dll (2.2 MB)
  client\MT3Win32App\Release.win32\MT3.exe (8.4 MB)

å¯è¿è¡Œç‰ˆæœ¬:
  client\resource\bin\debug\MT3åŸå§‹.exe (23 MB, v120 Debug) âœ…
  client\resource\bin\release\MT3.exe (å·²å¤åˆ¶å·¥ä½œç‰ˆæœ¬)
```

---

## ç›¸å…³æ–‡æ¡£

- [13-æ–‡æ¡£ç´¢å¼•.md](./13-æ–‡æ¡£ç´¢å¼•.md) - å®Œæ•´æ–‡æ¡£å¯¼èˆª
- [02-é¡¹ç›®æ¦‚è¿°.md](./02-é¡¹ç›®æ¦‚è¿°.md) - æŠ€æœ¯æ¶æ„è¯¦è§£
- [06-ç¼–è¯‘å®Œæ•´æŒ‡å—.md](./06-ç¼–è¯‘å®Œæ•´æŒ‡å—.md) - å®Œæ•´ç¼–è¯‘æµç¨‹
- [01-å¿«é€Ÿå¯åŠ¨æŒ‡å—.md](./01-å¿«é€Ÿå¯åŠ¨æŒ‡å—.md) - è¿è¡Œæ–¹å¼
- [æœ€ç»ˆå¯ç”¨æ–¹æ¡ˆ.md](./æœ€ç»ˆå¯ç”¨æ–¹æ¡ˆ.md) - v140é—®é¢˜æ€»ç»“